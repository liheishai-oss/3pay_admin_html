# æŠ•è¯‰ç›‘æ§ç³»ç»Ÿ - å®Œå–„ç›‘æ§æ–¹æ¡ˆ

> **åŸºäºPrometheus + Grafana + AlertManager**  
> **æ›´æ–°æ—¶é—´**: 2025-10-29  
> **çŠ¶æ€**: ç”Ÿäº§å°±ç»ª

---

## ğŸ“Š ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GolangæŠ•è¯‰ç›‘æ§æœåŠ¡                           â”‚
â”‚  - åç¨‹æ•°é‡ç›‘æ§                                           â”‚
â”‚  - å†…å­˜ä½¿ç”¨ç›‘æ§                                           â”‚
â”‚  - APIè°ƒç”¨ç›‘æ§                                            â”‚
â”‚  - æŠ•è¯‰å¤„ç†ç›‘æ§                                           â”‚
â”‚  - é”ç«äº‰ç›‘æ§                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ :9090/metrics
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Prometheus                              â”‚
â”‚  - æŒ‡æ ‡é‡‡é›†ï¼ˆ15ç§’é—´éš”ï¼‰                                   â”‚
â”‚  - æ•°æ®å­˜å‚¨ï¼ˆ15å¤©ï¼‰                                       â”‚
â”‚  - å‘Šè­¦è§„åˆ™è®¡ç®—                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                           â”‚
           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Grafana        â”‚    â”‚      AlertManager            â”‚
â”‚  - å¯è§†åŒ–é¢æ¿      â”‚    â”‚  - å‘Šè­¦èšåˆ                  â”‚
â”‚  - è¶‹åŠ¿åˆ†æ        â”‚    â”‚  - å‘Šè­¦åˆ†ç»„                  â”‚
â”‚  - å†å²æŸ¥è¯¢        â”‚    â”‚  - å‘Šè­¦å»é‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    Telegram Bot          â”‚
                          â”‚  - å®æ—¶æ¨é€å‘Šè­¦          â”‚
                          â”‚  - æ”¯æŒå¯Œæ–‡æœ¬            â”‚
                          â”‚  - ç§»åŠ¨ç«¯é€šçŸ¥            â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ç›‘æ§æŒ‡æ ‡ä½“ç³»

### 1. ä¸šåŠ¡æŒ‡æ ‡

```go
package metrics

import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
)

var (
    // æŠ•è¯‰å¤„ç†æ€»æ•°
    ComplaintProcessedTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "complaint_processed_total",
            Help: "æŠ•è¯‰å¤„ç†æ€»æ•°",
        },
        []string{"subject_id", "status"},  // success, failed, skipped
    )
    
    // æŠ•è¯‰å¤„ç†è€—æ—¶
    ComplaintProcessDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "complaint_process_duration_seconds",
            Help:    "æŠ•è¯‰å¤„ç†è€—æ—¶ï¼ˆç§’ï¼‰",
            Buckets: []float64{0.1, 0.5, 1, 2, 5, 10, 30, 60},
        },
        []string{"subject_id"},
    )
    
    // é»‘åå•è§¦å‘æ•°é‡
    BlacklistTriggeredTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "blacklist_triggered_total",
            Help: "é»‘åå•è§¦å‘æ€»æ•°",
        },
        []string{"risk_level"},  // low, medium, high, critical
    )
    
    // æŠ•è¯‰è®¢å•æ•°é‡åˆ†å¸ƒ
    ComplaintOrderCount = promauto.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "complaint_order_count",
            Help:    "å•ä¸ªæŠ•è¯‰åŒ…å«çš„è®¢å•æ•°é‡åˆ†å¸ƒ",
            Buckets: []float64{1, 2, 5, 10, 20, 50, 100},
        },
    )
    
    // æœªæ¨é€ç§¯å‹æ•°é‡
    UnpushedComplaintGauge = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "unpushed_complaint_count",
            Help: "æœªæ¨é€çš„æŠ•è¯‰æ•°é‡",
        },
    )
)
```

### 2. ç³»ç»ŸæŒ‡æ ‡

```go
var (
    // åç¨‹æ•°é‡
    GoroutineCount = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "goroutine_count",
            Help: "å½“å‰åç¨‹æ•°é‡",
        },
    )
    
    // å†…å­˜ä½¿ç”¨é‡
    MemoryUsage = promauto.NewGaugeVec(
        prometheus.GaugeOpts{
            Name: "memory_usage_bytes",
            Help: "å†…å­˜ä½¿ç”¨é‡ï¼ˆå­—èŠ‚ï¼‰",
        },
        []string{"type"},  // alloc, sys, heap_alloc, heap_sys
    )
    
    // GCç»Ÿè®¡
    GCDuration = promauto.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "gc_duration_seconds",
            Help:    "GCè€—æ—¶ï¼ˆç§’ï¼‰",
            Buckets: prometheus.DefBuckets,
        },
    )
    
    GCCount = promauto.NewCounter(
        prometheus.CounterOpts{
            Name: "gc_count_total",
            Help: "GCæ€»æ¬¡æ•°",
        },
    )
    
    // æ´»è·ƒWorkeræ•°é‡
    ActiveWorkerCount = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "active_worker_count",
            Help: "æ´»è·ƒçš„Workeræ•°é‡",
        },
    )
)
```

### 3. APIè°ƒç”¨æŒ‡æ ‡

```go
var (
    // æ”¯ä»˜å®APIè°ƒç”¨æ€»æ•°
    AlipayAPICallTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "alipay_api_call_total",
            Help: "æ”¯ä»˜å®APIè°ƒç”¨æ€»æ•°",
        },
        []string{"api", "status"},  // complaint_list, complaint_detail; success, failed
    )
    
    // APIè°ƒç”¨è€—æ—¶
    AlipayAPICallDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "alipay_api_call_duration_seconds",
            Help:    "æ”¯ä»˜å®APIè°ƒç”¨è€—æ—¶ï¼ˆç§’ï¼‰",
            Buckets: []float64{0.1, 0.3, 0.5, 1, 3, 5, 10},
        },
        []string{"api"},
    )
    
    // APIé”™è¯¯åˆ†å¸ƒ
    AlipayAPIErrorTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "alipay_api_error_total",
            Help: "æ”¯ä»˜å®APIé”™è¯¯æ€»æ•°",
        },
        []string{"api", "error_code"},
    )
)
```

### 4. åˆ†å¸ƒå¼é”æŒ‡æ ‡

```go
var (
    // é”è·å–æ€»æ•°
    LockAcquireTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "lock_acquire_total",
            Help: "é”è·å–æ€»æ•°",
        },
        []string{"status"},  // success, failed, already_locked
    )
    
    // é”æŒæœ‰æ—¶é—´
    LockHoldDuration = promauto.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "lock_hold_duration_seconds",
            Help:    "é”æŒæœ‰æ—¶é—´ï¼ˆç§’ï¼‰",
            Buckets: []float64{1, 5, 10, 30, 60, 120, 300},
        },
    )
    
    // é”é‡Šæ”¾å¤±è´¥æ¬¡æ•°
    LockReleaseFailedTotal = promauto.NewCounter(
        prometheus.CounterOpts{
            Name: "lock_release_failed_total",
            Help: "é”é‡Šæ”¾å¤±è´¥æ€»æ•°",
        },
    )
    
    // é”ç»­æœŸæ¬¡æ•°
    LockRenewTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "lock_renew_total",
            Help: "é”ç»­æœŸæ€»æ•°",
        },
        []string{"status"},  // success, failed
    )
)
```

### 5. è¯ä¹¦ç®¡ç†æŒ‡æ ‡

```go
var (
    // è¯ä¹¦åŠ è½½æ€»æ•°
    CertLoadTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "cert_load_total",
            Help: "è¯ä¹¦åŠ è½½æ€»æ•°",
        },
        []string{"status"},  // success, failed
    )
    
    // è¯ä¹¦ç¼“å­˜å‘½ä¸­ç‡
    CertCacheHitTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "cert_cache_hit_total",
            Help: "è¯ä¹¦ç¼“å­˜å‘½ä¸­æ€»æ•°",
        },
        []string{"hit"},  // true, false
    )
    
    // è¯ä¹¦åŠ è½½è€—æ—¶
    CertLoadDuration = promauto.NewHistogram(
        prometheus.HistogramOpts{
            Name:    "cert_load_duration_seconds",
            Help:    "è¯ä¹¦åŠ è½½è€—æ—¶ï¼ˆç§’ï¼‰",
            Buckets: []float64{0.01, 0.05, 0.1, 0.5, 1, 2},
        },
    )
    
    // å½“å‰ç¼“å­˜çš„è¯ä¹¦æ•°é‡
    CertCachedCount = promauto.NewGauge(
        prometheus.GaugeOpts{
            Name: "cert_cached_count",
            Help: "å½“å‰ç¼“å­˜çš„è¯ä¹¦æ•°é‡",
        },
    )
)
```

### 6. Panicç»Ÿè®¡æŒ‡æ ‡

```go
var (
    // Panicæ€»æ•°
    PanicTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "panic_total",
            Help: "Panicæ€»æ•°",
        },
        []string{"worker_id", "type"},  // subject_worker, loader
    )
    
    // Panicæ¢å¤æ€»æ•°
    PanicRecoveredTotal = promauto.NewCounter(
        prometheus.CounterOpts{
            Name: "panic_recovered_total",
            Help: "Panicæ¢å¤æ€»æ•°",
        },
    )
)
```

---

## ğŸ“ˆ æŒ‡æ ‡é‡‡é›†å®ç°

### 1. ç³»ç»ŸæŒ‡æ ‡é‡‡é›†å™¨

```go
package monitor

import (
    "runtime"
    "time"
    
    "complaint-monitor/metrics"
    "go.uber.org/zap"
)

// SystemMetricsCollector ç³»ç»ŸæŒ‡æ ‡é‡‡é›†å™¨
type SystemMetricsCollector struct {
    logger *zap.Logger
    stopCh chan struct{}
}

// NewSystemMetricsCollector åˆ›å»ºé‡‡é›†å™¨
func NewSystemMetricsCollector(logger *zap.Logger) *SystemMetricsCollector {
    return &SystemMetricsCollector{
        logger: logger,
        stopCh: make(chan struct{}),
    }
}

// Start å¯åŠ¨é‡‡é›†
func (c *SystemMetricsCollector) Start() {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-c.stopCh:
            return
        case <-ticker.C:
            c.collect()
        }
    }
}

// Stop åœæ­¢é‡‡é›†
func (c *SystemMetricsCollector) Stop() {
    close(c.stopCh)
}

// collect é‡‡é›†æŒ‡æ ‡
func (c *SystemMetricsCollector) collect() {
    // åç¨‹æ•°é‡
    metrics.GoroutineCount.Set(float64(runtime.NumGoroutine()))
    
    // å†…å­˜ç»Ÿè®¡
    var m runtime.MemStats
    runtime.ReadMemStats(&m)
    
    metrics.MemoryUsage.WithLabelValues("alloc").Set(float64(m.Alloc))
    metrics.MemoryUsage.WithLabelValues("sys").Set(float64(m.Sys))
    metrics.MemoryUsage.WithLabelValues("heap_alloc").Set(float64(m.HeapAlloc))
    metrics.MemoryUsage.WithLabelValues("heap_sys").Set(float64(m.HeapSys))
    
    // GCç»Ÿè®¡
    metrics.GCCount.Add(float64(m.NumGC) - float64(metrics.GCCount))
    
    c.logger.Debug("ç³»ç»ŸæŒ‡æ ‡é‡‡é›†å®Œæˆ",
        zap.Int("goroutines", runtime.NumGoroutine()),
        zap.Uint64("alloc_mb", m.Alloc/1024/1024),
        zap.Uint32("gc_count", m.NumGC))
}
```

### 2. ä¸šåŠ¡æŒ‡æ ‡è®°å½•

```go
// è®°å½•æŠ•è¯‰å¤„ç†
func recordComplaintProcessing(subjectID int, duration time.Duration, success bool) {
    status := "success"
    if !success {
        status = "failed"
    }
    
    metrics.ComplaintProcessedTotal.WithLabelValues(
        fmt.Sprintf("%d", subjectID),
        status,
    ).Inc()
    
    metrics.ComplaintProcessDuration.WithLabelValues(
        fmt.Sprintf("%d", subjectID),
    ).Observe(duration.Seconds())
}

// è®°å½•APIè°ƒç”¨
func recordAPICall(api string, duration time.Duration, err error) {
    status := "success"
    if err != nil {
        status = "failed"
        
        // è®°å½•é”™è¯¯ç 
        errorCode := extractErrorCode(err)
        metrics.AlipayAPIErrorTotal.WithLabelValues(api, errorCode).Inc()
    }
    
    metrics.AlipayAPICallTotal.WithLabelValues(api, status).Inc()
    metrics.AlipayAPICallDuration.WithLabelValues(api).Observe(duration.Seconds())
}

// è®°å½•é»‘åå•è§¦å‘
func recordBlacklistTriggered(riskLevel string) {
    metrics.BlacklistTriggeredTotal.WithLabelValues(riskLevel).Inc()
}

// è®°å½•é”æ“ä½œ
func recordLockOperation(acquired bool, duration time.Duration) {
    status := "success"
    if !acquired {
        status := "already_locked"
    }
    
    metrics.LockAcquireTotal.WithLabelValues(status).Inc()
    
    if acquired {
        metrics.LockHoldDuration.Observe(duration.Seconds())
    }
}

// è®°å½•Panic
func recordPanic(workerID string, panicType string) {
    metrics.PanicTotal.WithLabelValues(workerID, panicType).Inc()
    metrics.PanicRecoveredTotal.Inc()
}
```

---

## ğŸ¯ Prometheusé…ç½®

### prometheus.yml

```yaml
global:
  scrape_interval: 15s      # é‡‡é›†é—´éš”
  evaluation_interval: 15s  # è§„åˆ™è¯„ä¼°é—´éš”
  
  external_labels:
    cluster: 'production'
    service: 'complaint-monitor'

# å‘Šè­¦é…ç½®
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']

# å‘Šè­¦è§„åˆ™æ–‡ä»¶
rule_files:
  - 'alerts/*.yml'

# é‡‡é›†é…ç½®
scrape_configs:
  - job_name: 'complaint-monitor'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    scrape_interval: 15s
```

---

## âš ï¸ å‘Šè­¦è§„åˆ™

### alerts/complaint_monitor.yml

```yaml
groups:
  - name: complaint_monitor_alerts
    interval: 30s
    rules:
      # ğŸ”´ P0å‘Šè­¦ï¼šæœåŠ¡ä¸å¯ç”¨
      - alert: ServiceDown
        expr: up{job="complaint-monitor"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "æŠ•è¯‰ç›‘æ§æœåŠ¡ä¸å¯ç”¨"
          description: "æœåŠ¡å·²åœæ­¢è¿è¡Œè¶…è¿‡1åˆ†é’Ÿ"
      
      # ğŸ”´ P0å‘Šè­¦ï¼šåç¨‹æ•°é‡å¼‚å¸¸
      - alert: GoroutineCountHigh
        expr: goroutine_count > 1000
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "åç¨‹æ•°é‡è¿‡é«˜"
          description: "å½“å‰åç¨‹æ•°: {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨åç¨‹æ³„æ¼"
      
      # ğŸ”´ P0å‘Šè­¦ï¼šå†…å­˜ä½¿ç”¨è¿‡é«˜
      - alert: MemoryUsageHigh
        expr: memory_usage_bytes{type="alloc"} > 1073741824  # 1GB
        for: 5m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "å½“å‰å†…å­˜ä½¿ç”¨: {{ $value | humanize }}B"
      
      # ğŸŸ  P1å‘Šè­¦ï¼šAPIé”™è¯¯ç‡é«˜
      - alert: AlipayAPIErrorRateHigh
        expr: |
          sum(rate(alipay_api_error_total[5m])) 
          / 
          sum(rate(alipay_api_call_total[5m])) 
          > 0.1
        for: 5m
        labels:
          severity: warning
          priority: P1
        annotations:
          summary: "æ”¯ä»˜å®APIé”™è¯¯ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿé”™è¯¯ç‡: {{ $value | humanizePercentage }}"
      
      # ğŸŸ  P1å‘Šè­¦ï¼šæŠ•è¯‰å¤„ç†é€Ÿåº¦æ…¢
      - alert: ComplaintProcessingSlow
        expr: |
          sum(rate(complaint_processed_total[5m])) < 10/60
        for: 10m
        labels:
          severity: warning
          priority: P1
        annotations:
          summary: "æŠ•è¯‰å¤„ç†é€Ÿåº¦è¿‡æ…¢"
          description: "æœ€è¿‘5åˆ†é’Ÿå¤„ç†é€Ÿåº¦: {{ $value | humanize }}/min"
      
      # ğŸŸ  P1å‘Šè­¦ï¼šæœªæ¨é€ç§¯å‹
      - alert: UnpushedComplaintBacklog
        expr: unpushed_complaint_count > 100
        for: 10m
        labels:
          severity: warning
          priority: P1
        annotations:
          summary: "æœªæ¨é€æŠ•è¯‰ç§¯å‹"
          description: "å½“å‰ç§¯å‹æ•°é‡: {{ $value }}"
      
      # ğŸŸ¡ P2å‘Šè­¦ï¼šé”é‡Šæ”¾å¤±è´¥
      - alert: LockReleaseFailures
        expr: rate(lock_release_failed_total[5m]) > 0.01
        for: 5m
        labels:
          severity: info
          priority: P2
        annotations:
          summary: "é”é‡Šæ”¾å¤±è´¥"
          description: "æœ€è¿‘5åˆ†é’Ÿå¤±è´¥ç‡: {{ $value | humanize }}/s"
      
      # ğŸŸ¡ P2å‘Šè­¦ï¼šPanicå‘ç”Ÿ
      - alert: PanicOccurred
        expr: increase(panic_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          priority: P2
        annotations:
          summary: "æ£€æµ‹åˆ°Panic"
          description: "æœ€è¿‘5åˆ†é’ŸPanicæ¬¡æ•°: {{ $value }}"
      
      # ğŸŸ¡ P2å‘Šè­¦ï¼šè¯ä¹¦åŠ è½½å¤±è´¥ç‡é«˜
      - alert: CertLoadFailureRateHigh
        expr: |
          sum(rate(cert_load_total{status="failed"}[5m]))
          /
          sum(rate(cert_load_total[5m]))
          > 0.05
        for: 5m
        labels:
          severity: info
          priority: P2
        annotations:
          summary: "è¯ä¹¦åŠ è½½å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿå¤±è´¥ç‡: {{ $value | humanizePercentage }}"
      
      # ğŸŸ¡ P2å‘Šè­¦ï¼šé»‘åå•è§¦å‘é¢‘ç¹
      - alert: BlacklistTriggeredFrequent
        expr: rate(blacklist_triggered_total[1h]) > 50/3600
        for: 10m
        labels:
          severity: info
          priority: P2
        annotations:
          summary: "é»‘åå•è§¦å‘é¢‘ç¹"
          description: "æœ€è¿‘1å°æ—¶è§¦å‘é€Ÿç‡: {{ $value | humanize }}/h"
```

---

## ğŸ“Š Grafanaä»ªè¡¨ç›˜

### ä»ªè¡¨ç›˜é…ç½®JSONï¼ˆéƒ¨åˆ†ï¼‰

```json
{
  "dashboard": {
    "title": "æŠ•è¯‰ç›‘æ§ç³»ç»Ÿ",
    "panels": [
      {
        "title": "æœåŠ¡çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=\"complaint-monitor\"}"
          }
        ]
      },
      {
        "title": "åç¨‹æ•°é‡è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "goroutine_count",
            "legendFormat": "åç¨‹æ•°"
          }
        ]
      },
      {
        "title": "å†…å­˜ä½¿ç”¨è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "memory_usage_bytes{type=\"alloc\"} / 1024 / 1024",
            "legendFormat": "å·²åˆ†é…å†…å­˜(MB)"
          }
        ]
      },
      {
        "title": "æŠ•è¯‰å¤„ç†é€Ÿåº¦",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(complaint_processed_total[1m])*60",
            "legendFormat": "{{subject_id}} - {{status}}"
          }
        ]
      },
      {
        "title": "APIè°ƒç”¨æˆåŠŸç‡",
        "type": "gauge",
        "targets": [
          {
            "expr": "sum(rate(alipay_api_call_total{status=\"success\"}[5m])) / sum(rate(alipay_api_call_total[5m]))"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ”” AlertManageré…ç½®

### alertmanager.yml

```yaml
global:
  resolve_timeout: 5m

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'priority']
  group_wait: 30s          # ç­‰å¾…30ç§’å†å‘é€ï¼ˆèšåˆï¼‰
  group_interval: 5m       # åŒç»„å‘Šè­¦é—´éš”5åˆ†é’Ÿ
  repeat_interval: 4h      # é‡å¤å‘Šè­¦é—´éš”4å°æ—¶
  receiver: 'telegram'     # é»˜è®¤æ¥æ”¶å™¨
  
  routes:
    # P0å‘Šè­¦ç«‹å³å‘é€
    - match:
        priority: P0
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 30m
      receiver: 'telegram-critical'
    
    # P1å‘Šè­¦æ­£å¸¸å‘é€
    - match:
        priority: P1
      receiver: 'telegram'
    
    # P2å‘Šè­¦é™ä½é¢‘ç‡
    - match:
        priority: P2
      group_interval: 10m
      repeat_interval: 12h
      receiver: 'telegram-info'

# æŠ‘åˆ¶è§„åˆ™ï¼ˆé¿å…å‘Šè­¦é£æš´ï¼‰
inhibit_rules:
  # æœåŠ¡å®•æœºæ—¶æŠ‘åˆ¶å…¶ä»–æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['job']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # Telegramå…³é”®å‘Šè­¦
  - name: 'telegram-critical'
    webhook_configs:
      - url: 'http://localhost:8080/alert/telegram/critical'
        send_resolved: true
  
  # Telegramæ™®é€šå‘Šè­¦
  - name: 'telegram'
    webhook_configs:
      - url: 'http://localhost:8080/alert/telegram/normal'
        send_resolved: true
  
  # Telegramä¿¡æ¯å‘Šè­¦
  - name: 'telegram-info'
    webhook_configs:
      - url: 'http://localhost:8080/alert/telegram/info'
        send_resolved: true
```

---

## ğŸ“± Telegramå‘Šè­¦é›†æˆ

### telegram_alerter.go

```go
package alerter

import (
    "bytes"
    "encoding/json"
    "fmt"
    "net/http"
    "time"
    
    "go.uber.org/zap"
)

// TelegramAlerter Telegramå‘Šè­¦å™¨
type TelegramAlerter struct {
    botToken string
    chatID   string
    logger   *zap.Logger
}

// Alert å‘Šè­¦æ•°æ®
type Alert struct {
    Status      string            `json:"status"`
    Labels      map[string]string `json:"labels"`
    Annotations map[string]string `json:"annotations"`
    StartsAt    time.Time         `json:"startsAt"`
    EndsAt      time.Time         `json:"endsAt"`
}

// AlertMessage AlertManageræ¶ˆæ¯æ ¼å¼
type AlertMessage struct {
    Alerts []Alert `json:"alerts"`
}

// NewTelegramAlerter åˆ›å»ºå‘Šè­¦å™¨
func NewTelegramAlerter(botToken, chatID string, logger *zap.Logger) *TelegramAlerter {
    return &TelegramAlerter{
        botToken: botToken,
        chatID:   chatID,
        logger:   logger,
    }
}

// HandleWebhook å¤„ç†AlertManager webhook
func (ta *TelegramAlerter) HandleWebhook(w http.ResponseWriter, r *http.Request) {
    var msg AlertMessage
    if err := json.NewDecoder(r.Body).Decode(&msg); err != nil {
        http.Error(w, err.Error(), http.StatusBadRequest)
        return
    }
    
    for _, alert := range msg.Alerts {
        ta.sendAlert(alert)
    }
    
    w.WriteHeader(http.StatusOK)
}

// sendAlert å‘é€å‘Šè­¦
func (ta *TelegramAlerter) sendAlert(alert Alert) {
    // æ„å»ºæ¶ˆæ¯
    message := ta.formatAlert(alert)
    
    // å‘é€åˆ°Telegram
    url := fmt.Sprintf("https://api.telegram.org/bot%s/sendMessage", ta.botToken)
    
    payload := map[string]interface{}{
        "chat_id":    ta.chatID,
        "text":       message,
        "parse_mode": "HTML",
    }
    
    data, _ := json.Marshal(payload)
    resp, err := http.Post(url, "application/json", bytes.NewBuffer(data))
    if err != nil {
        ta.logger.Error("å‘é€Telegramå‘Šè­¦å¤±è´¥", zap.Error(err))
        return
    }
    defer resp.Body.Close()
    
    if resp.StatusCode != http.StatusOK {
        ta.logger.Error("Telegram APIè¿”å›é”™è¯¯", zap.Int("status", resp.StatusCode))
    }
}

// formatAlert æ ¼å¼åŒ–å‘Šè­¦æ¶ˆæ¯
func (ta *TelegramAlerter) formatAlert(alert Alert) string {
    // å›¾æ ‡æ˜ å°„
    icon := "âš ï¸"
    switch alert.Labels["priority"] {
    case "P0":
        icon = "ğŸ”´"
    case "P1":
        icon = "ğŸŸ "
    case "P2":
        icon = "ğŸŸ¡"
    }
    
    // çŠ¶æ€
    status := "è§¦å‘"
    if alert.Status == "resolved" {
        status = "âœ… å·²æ¢å¤"
        icon = "âœ…"
    }
    
    message := fmt.Sprintf(`%s <b>%s</b> - %s

<b>å‘Šè­¦è¯¦æƒ…ï¼š</b>
%s

<b>ä¼˜å…ˆçº§ï¼š</b>%s
<b>æ—¶é—´ï¼š</b>%s`,
        icon,
        alert.Labels["alertname"],
        status,
        alert.Annotations["description"],
        alert.Labels["priority"],
        alert.StartsAt.Format("2006-01-02 15:04:05"))
    
    return message
}
```

---

## ğŸš€ éƒ¨ç½²å’Œå¯åŠ¨

### 1. å¯åŠ¨Prometheus

```bash
# ä¸‹è½½Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
cd prometheus-*

# å¯åŠ¨
./prometheus --config.file=prometheus.yml
```

### 2. å¯åŠ¨AlertManager

```bash
# ä¸‹è½½AlertManager
wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz
tar xvfz alertmanager-*.tar.gz
cd alertmanager-*

# å¯åŠ¨
./alertmanager --config.file=alertmanager.yml
```

### 3. å¯åŠ¨Grafana

```bash
# å®‰è£…Grafana
sudo apt-get install -y software-properties-common
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
sudo apt-get update
sudo apt-get install grafana

# å¯åŠ¨
sudo systemctl start grafana-server
sudo systemctl enable grafana-server

# è®¿é—® http://localhost:3000
# é»˜è®¤è´¦å·: admin/admin
```

### 4. é…ç½®æ•°æ®æº

1. ç™»å½•Grafana
2. Configuration â†’ Data Sources
3. Add data source â†’ Prometheus
4. URL: `http://localhost:9090`
5. Save & Test

---

## ğŸ“‹ ç›‘æ§æ£€æŸ¥æ¸…å•

### æ¯æ—¥æ£€æŸ¥
- [ ] æœåŠ¡çŠ¶æ€æ­£å¸¸
- [ ] åç¨‹æ•°é‡ç¨³å®š
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸
- [ ] æ— P0/P1å‘Šè­¦

### æ¯å‘¨æ£€æŸ¥
- [ ] APIæˆåŠŸç‡ > 95%
- [ ] æŠ•è¯‰å¤„ç†é€Ÿåº¦æ­£å¸¸
- [ ] æ— ç§¯å‹
- [ ] GCé¢‘ç‡æ­£å¸¸
- [ ] é”ç«äº‰ä¸ä¸¥é‡

### æ¯æœˆæ£€æŸ¥
- [ ] æŸ¥çœ‹é•¿æœŸè¶‹åŠ¿
- [ ] ä¼˜åŒ–æ…¢æŸ¥è¯¢
- [ ] æ£€æŸ¥è¯ä¹¦è¿‡æœŸ
- [ ] æ¸…ç†è¿‡æœŸæ•°æ®

---

**ç›‘æ§æ–¹æ¡ˆåˆ¶å®šè€…**: AI æŠ€æœ¯æ–¹æ¡ˆ  
**æœ€åæ›´æ–°**: 2025-10-29  
**ç‰ˆæœ¬**: v1.0

