# 支付流程说明

## 📋 系统架构

### 核心组件
1. **PaymentFactory** - 支付工厂类，根据产品编号调用不同支付方式
2. **PaymentTypeService** - 支付类型管理服务
3. **AlipayService** - 支付宝支付服务（已创建的企业级服务）
4. **OrderController** - 订单创建控制器（已更新）
5. **PaymentNotifyController** - 支付通知处理控制器
6. **PaymentQueryController** - 支付查询控制器

### 数据流程
```
商户请求 → 订单创建 → 产品查询 → 支付类型获取 → 支付主体选择 → 支付配置构建 → 支付接口调用 → 返回支付信息
```

## 🔄 完整支付流程

### 1. 订单创建流程

#### 请求参数
```json
{
    "api_key": "merchant_api_key",
    "merchant_order_no": "M202501220001",
    "product_code": "1001",
    "amount": "100.00",
    "subject": "测试商品",
    "body": "这是一个测试订单",
    "notify_url": "https://merchant.com/notify",
    "return_url": "https://merchant.com/return",
    "sign": "generated_signature"
}
```

#### 处理流程
1. **验证商户** - 通过 `api_key` 验证商户身份
2. **验证签名** - 验证请求签名防止篡改
3. **查找产品** - 根据 `product_code` 查找产品信息
4. **获取支付类型** - 通过产品的 `payment_type_id` 获取支付类型
5. **选择支付主体** - 根据代理商ID和产品ID选择可用支付主体
6. **构建支付配置** - 从支付主体证书中获取支付配置
7. **调用支付接口** - 根据支付类型调用相应的支付方法
8. **返回支付信息** - 返回支付URL或支付参数

#### 响应示例
```json
{
    "code": 0,
    "msg": "订单创建成功",
    "data": {
        "platform_order_no": "BY20250122153045A1B21234",
        "merchant_order_no": "M202501220001",
        "amount": 100.00,
        "expire_time": "2025-01-22 16:00:45",
        "payment_info": {
            "payment_url": "https://openapi.alipay.com/gateway.do?...",
            "payment_method": "wap",
            "payment_type": "alipay"
        }
    }
}
```

### 2. 支付方式支持

#### 支付宝支付方式
- **alipay_wap** - WAP支付（手机网页）
- **alipay_app** - APP支付（移动应用）
- **alipay_page** - PC网站支付
- **alipay_qr** - 扫码支付
- **alipay_bar** - 条码支付（当面付）
- **alipay_preauth** - 预授权支付

#### 支付方式映射
```php
const PAYMENT_METHODS = [
    'alipay_wap' => 'AlipayService',
    'alipay_app' => 'AlipayService', 
    'alipay_page' => 'AlipayService',
    'alipay_qr' => 'AlipayService',
    'alipay_bar' => 'AlipayService',
    'alipay_preauth' => 'AlipayService',
];
```

### 3. 支付通知处理

#### 通知地址
```
POST /api/v1/payment/notify/alipay
```

#### 通知参数
```json
{
    "gmt_create": "2024-01-01 12:00:00",
    "charset": "UTF-8",
    "gmt_payment": "2024-01-01 12:01:00",
    "notify_time": "2024-01-01 12:01:00",
    "subject": "测试商品",
    "sign": "alipay_signature",
    "buyer_id": "2088123456789012",
    "invoice_amount": "100.00",
    "version": "1.0",
    "notify_id": "notify_id_123",
    "fund_bill_list": "[{\"amount\":\"100.00\",\"fundChannel\":\"ALIPAYACCOUNT\"}]",
    "notify_type": "trade_status_sync",
    "out_trade_no": "BY20250122153045A1B21234",
    "total_amount": "100.00",
    "trade_status": "TRADE_SUCCESS",
    "trade_no": "2024010122001234567890123456",
    "auth_app_id": "app_id",
    "receipt_amount": "100.00",
    "point_amount": "0.00",
    "app_id": "app_id",
    "buyer_pay_amount": "100.00",
    "sign_type": "RSA2",
    "seller_id": "2088123456789012"
}
```

#### 处理流程
1. **验证签名** - 验证支付宝通知签名
2. **查找订单** - 根据 `out_trade_no` 查找订单
3. **更新订单状态** - 更新订单为已支付状态
4. **发送商户通知** - 向商户发送支付成功通知
5. **返回响应** - 返回 `success` 或 `fail`

### 4. 订单查询

#### 查询接口
```
POST /api/v1/payment/query
```

#### 请求参数
```json
{
    "api_key": "merchant_api_key",
    "order_no": "BY20250122153045A1B21234",
    "sign": "generated_signature"
}
```

#### 响应示例
```json
{
    "code": 0,
    "msg": "success",
    "data": {
        "order_no": "BY20250122153045A1B21234",
        "merchant_order_no": "M202501220001",
        "amount": 100.00,
        "pay_status": 1,
        "pay_status_text": "已支付",
        "paid_at": "2025-01-22 15:31:00",
        "trade_no": "2024010122001234567890123456",
        "source": "local"
    }
}
```

## 🏗️ 数据库设计

### 关键表结构

#### product 表
- `id` - 主键
- `agent_id` - 代理商ID
- `payment_type_id` - 支付类型ID（关联 payment_type 表）
- `product_code` - 产品编号（4位数字）
- `product_name` - 产品名称
- `status` - 状态

#### payment_type 表
- `id` - 主键
- `product_name` - 产品名称
- `product_code` - 产品代码（如 alipay_wap）
- `class_name` - 推荐的PHP类名
- `description` - 产品描述
- `status` - 状态

#### subject 表
- `id` - 主键
- `agent_id` - 代理商ID
- `product_id` - 产品ID
- `alipay_app_id` - 支付宝应用ID
- `alipay_pid` - 支付宝合作伙伴ID
- `status` - 状态

#### subject_cert 表
- `id` - 主键
- `subject_id` - 支付主体ID
- `app_private_key` - 应用私钥
- `alipay_cert_public_key` - 支付宝公钥证书
- `alipay_root_cert` - 支付宝根证书
- `app_cert_public_key` - 应用公钥证书

## 🔧 配置说明

### 支付类型配置
在 `payment_type` 表中配置支持的支付方式：

```sql
INSERT INTO payment_type (product_name, product_code, class_name, description, status, sort_order) VALUES
('支付宝WAP支付', 'alipay_wap', 'AlipayService', '手机网页支付', 1, 100),
('支付宝APP支付', 'alipay_app', 'AlipayService', '移动应用支付', 1, 99),
('支付宝PC支付', 'alipay_page', 'AlipayService', 'PC网站支付', 1, 98),
('支付宝扫码支付', 'alipay_qr', 'AlipayService', '扫码支付', 1, 97),
('支付宝条码支付', 'alipay_bar', 'AlipayService', '当面付', 1, 96),
('支付宝预授权支付', 'alipay_preauth', 'AlipayService', '预授权支付', 1, 95);
```

### 产品配置
在 `product` 表中配置产品与支付类型的关联：

```sql
INSERT INTO product (agent_id, payment_type_id, product_name, product_code, status) VALUES
(1, 1, '测试产品1', '1001', 1),
(1, 2, '测试产品2', '1002', 1),
(1, 3, '测试产品3', '1003', 1);
```

## 🚀 使用示例

### 1. 创建订单
```php
$params = [
    'api_key' => 'your_api_key',
    'merchant_order_no' => 'M' . time(),
    'product_code' => '1001', // 对应 alipay_wap
    'amount' => '0.01',
    'subject' => '测试商品',
    'notify_url' => 'https://your-domain.com/notify',
    'return_url' => 'https://your-domain.com/return',
];

// 生成签名
$params['sign'] = generateSign($params, 'your_api_secret');

// 发送请求
$response = sendRequest('/api/v1/merchant/order/create', $params);
```

### 2. 处理支付通知
```php
// 在商户系统中接收通知
$notifyData = $_POST;

// 验证签名
if (verifyNotifySign($notifyData, 'your_api_secret')) {
    // 处理支付成功逻辑
    if ($notifyData['pay_status'] == 1) {
        // 更新订单状态
        updateOrderStatus($notifyData['merchant_order_no'], 'paid');
    }
    
    // 返回成功响应
    echo 'success';
} else {
    echo 'fail';
}
```

### 3. 查询订单状态
```php
$params = [
    'api_key' => 'your_api_key',
    'order_no' => 'BY20250122153045A1B21234',
];

$params['sign'] = generateSign($params, 'your_api_secret');

$response = sendRequest('/api/v1/payment/query', $params);
```

## 🔒 安全特性

1. **签名验证** - 所有API请求都需要签名验证
2. **防重复处理** - 使用Redis缓存防止重复处理通知
3. **证书管理** - 支持支付宝证书验证
4. **日志记录** - 详细的操作日志记录
5. **异常处理** - 完善的错误处理机制

## 📝 注意事项

1. 确保支付主体证书配置正确
2. 通知地址必须是HTTPS且可访问
3. 订单号要保证唯一性
4. 金额格式要正确（最多2位小数）
5. 生产环境使用前请充分测试

## 🔄 扩展说明

### 添加新的支付方式
1. 在 `payment_type` 表中添加新的支付类型
2. 在 `PaymentFactory::PAYMENT_METHODS` 中添加映射
3. 实现对应的支付服务类
4. 在 `PaymentFactory::callPaymentMethod` 中添加调用逻辑

### 添加新的支付渠道
1. 创建新的支付服务类（如 `WechatService`）
2. 在 `PaymentFactory` 中添加支持
3. 更新数据库配置
4. 添加相应的通知处理逻辑
