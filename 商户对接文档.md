# 百亿三方支付 - 商户API对接文档

## 概述

本文档描述了商户如何接入百亿三方支付系统进行支付对接。

## 接入准备

在开始对接前，您需要：

1. 获取商户账号（由平台管理员或代理商创建）
2. 获取API密钥对：
   - `api_key`: API密钥（用于身份识别）
   - `api_secret`: API密钥Secret（用于签名验证，请妥善保管）

## 签名规则

### 签名生成步骤

1. 将所有请求参数（**除sign外**）按照参数名ASCII码升序排序
2. 按照`key=value&`格式拼接参数
3. 在拼接字符串末尾添加`key=api_secret`
4. 对拼接后的字符串进行MD5加密
5. 将MD5结果转换为大写字母

### 签名示例

假设请求参数如下：
```
api_key: ABC123
merchant_order_no: M202501220001
product_code: 1001
amount: 100.00
subject: 测试订单
api_secret: xyz789 (不参与参数排序，最后添加)
```

签名步骤：
1. 参数排序后：amount, api_key, merchant_order_no, product_code, subject
2. 拼接字符串：`amount=100.00&api_key=ABC123&merchant_order_no=M202501220001&product_code=1001&subject=测试订单&key=xyz789`
3. MD5加密并转大写：`sign = MD5(拼接字符串).toUpperCase()`

### PHP示例代码

```php
function generateSign($params, $apiSecret) {
    // 移除sign参数
    unset($params['sign']);
    
    // 按key升序排序
    ksort($params);
    
    // 拼接字符串
    $signStr = '';
    foreach ($params as $key => $value) {
        if ($value !== '' && $value !== null) {
            $signStr .= $key . '=' . $value . '&';
        }
    }
    
    // 加上api_secret
    $signStr .= 'key=' . $apiSecret;
    
    // MD5加密并转大写
    return strtoupper(md5($signStr));
}
```

## API接口

### 1. 创建订单

**接口地址**：`POST /api/v1/merchant/order/create`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| api_key | string | 是 | API密钥 |
| merchant_order_no | string | 是 | 商户订单号（商户系统唯一） |
| product_code | string | 是 | 产品编号（4位数字） |
| amount | decimal | 是 | 订单金额（元，保留2位小数） |
| subject | string | 是 | 订单标题 |
| body | string | 否 | 订单描述 |
| notify_url | string | 否 | 异步通知地址（可选，不传使用商户配置的地址） |
| return_url | string | 否 | 同步返回地址（可选，不传使用商户配置的地址） |
| sign | string | 是 | 签名 |

**返回参数**：

```json
{
    "code": 0,
    "msg": "订单创建成功",
    "data": {
        "platform_order_no": "BY20250122153045A1B21234",
        "merchant_order_no": "M202501220001",
        "amount": 100.00,
        "expire_time": "2025-01-22 16:00:45",
        "payment_url": "https://pay.example.com/alipay?order_no=BY20250122153045A1B21234"
    }
}
```

**错误响应**：

```json
{
    "code": 1,
    "msg": "错误信息",
    "data": null
}
```

**请求示例**：

```php
$params = [
    'api_key' => 'YOUR_API_KEY',
    'merchant_order_no' => 'M' . date('YmdHis'),
    'product_code' => '1001',
    'amount' => '100.00',
    'subject' => '测试订单',
    'body' => '这是一个测试订单',
    'notify_url' => 'https://your-domain.com/notify',
    'return_url' => 'https://your-domain.com/return',
];

// 生成签名
$params['sign'] = generateSign($params, 'YOUR_API_SECRET');

// 发送请求
$ch = curl_init('https://your-payment-domain.com/api/v1/merchant/order/create');
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
curl_close($ch);

$result = json_decode($response, true);
if ($result['code'] === 0) {
    // 订单创建成功，跳转到支付页面
    header('Location: ' . $result['data']['payment_url']);
}
```

### 2. 查询订单

**接口地址**：`POST /api/v1/merchant/order/query` 或 `GET /api/v1/merchant/order/query`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| api_key | string | 是 | API密钥 |
| merchant_order_no | string | 否 | 商户订单号（与platform_order_no二选一） |
| platform_order_no | string | 否 | 平台订单号（与merchant_order_no二选一） |
| sign | string | 是 | 签名 |

**返回参数**：

```json
{
    "code": 0,
    "msg": "查询成功",
    "data": {
        "platform_order_no": "BY20250122153045A1B21234",
        "merchant_order_no": "M202501220001",
        "alipay_order_no": "2025012222001234567890",
        "order_amount": 100.00,
        "pay_status": 1,
        "pay_status_text": "已支付",
        "pay_time": "2025-01-22 15:35:20",
        "created_at": "2025-01-22 15:30:45"
    }
}
```

**支付状态说明**：

| 状态值 | 说明 |
|--------|------|
| 0 | 待支付 |
| 1 | 已支付 |
| 2 | 已关闭 |
| 3 | 已退款 |

### 3. 关闭订单

**接口地址**：`POST /api/v1/merchant/order/close`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| api_key | string | 是 | API密钥 |
| merchant_order_no | string | 否 | 商户订单号（与platform_order_no二选一） |
| platform_order_no | string | 否 | 平台订单号（与merchant_order_no二选一） |
| sign | string | 是 | 签名 |

**返回参数**：

```json
{
    "code": 0,
    "msg": "订单关闭成功",
    "data": []
}
```

**注意**：只有待支付状态的订单才能关闭。

## 异步通知

### 通知说明

订单支付成功后，系统会向商户配置的`notify_url`发送POST请求通知。

### 通知参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| platform_order_no | string | 平台订单号 |
| merchant_order_no | string | 商户订单号 |
| alipay_order_no | string | 支付宝订单号 |
| order_amount | decimal | 订单金额 |
| pay_status | int | 支付状态 |
| pay_time | string | 支付时间 |
| sign | string | 签名 |

### 通知响应

商户系统收到通知后，需要：

1. 验证签名
2. 处理业务逻辑
3. 返回字符串`success`（不区分大小写）

如果未返回`success`，系统会重复发送通知（最多尝试5次）。

### 通知处理示例

```php
// 接收通知参数
$params = $_POST;

// 验证签名
$sign = $params['sign'];
unset($params['sign']);

$expectedSign = generateSign($params, 'YOUR_API_SECRET');

if ($sign !== $expectedSign) {
    exit('fail');
}

// 处理业务逻辑
// 1. 查询订单是否已处理
// 2. 更新订单状态
// 3. 发货/开通服务等

// 返回成功
echo 'success';
```

## 常见错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 1 | 业务错误（具体查看msg字段） |
| 500 | 系统异常 |

## 测试环境

- 测试域名：`https://test-pay.example.com`
- 测试商户：联系管理员获取测试账号

## 技术支持

如有疑问，请联系技术支持。

## 更新日志

- 2025-01-22：初始版本发布

