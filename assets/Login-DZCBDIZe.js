import{s as D,d as F,g as t,h as H,i as J,o as g,w as l,e as s,c as x,j as z,a as o,k as O,u as h,l as Q,m as oe,n as B,t as Z,p as se,q as L,v as G,x as N,y as K,z as T,A as le,C as y,D as W,_ as M,F as X,G as ae,H as P,I as te,J as ne}from"./index-Buzfk7pw.js";/* empty css              */function re(I={}){return D({url:"/api/v1/admin/user/login",method:"post",data:I})}const j=I=>D.get("/api/v1/admin/google-auth/qr-code",{params:{admin_id:I}}),de=I=>D.post("/api/v1/admin/google-auth/bind",I),ie={class:"google-auth-bind"},ue={key:0,class:"step-content"},ce={class:"step-header"},pe={class:"qr-code-container"},_e={key:0,class:"qr-loading"},me={key:1,class:"qr-code"},fe=["src"],ge={class:"qr-info"},ve={key:2,class:"qr-error"},we={class:"step-actions"},he={key:1,class:"step-content"},ye={class:"step-header"},be={class:"step-actions"},Ve={key:2,class:"step-content"},ke={class:"success-content"},Ce=F({__name:"GoogleAuthBind",emits:["success","close"],setup(I,{expose:v,emit:w}){const A=w,_=t(!1),d=t(1),$=t(!1),c=t(!1),q=t(0),m=t(null),b=H({google_code:""}),E={google_code:[{required:!0,message:"请输入验证码",trigger:"blur"},{pattern:/^\d{6}$/,message:"请输入6位数字验证码",trigger:"blur"}]},f=t(),a=(r,e)=>{_.value=!0,d.value=1,q.value=r,S()},i=()=>{d.value<3&&d.value++},U=()=>{d.value>1&&d.value--},S=async()=>{try{$.value=!0;const r=await j(q.value);r.data?m.value=r.data:y.error("生成二维码失败")}catch(r){console.error("生成二维码失败:",r),y.error("生成二维码失败")}finally{$.value=!1}},n=async()=>{var r,e;try{await((r=f.value)==null?void 0:r.validate()),c.value=!0;const p=await de({admin_id:q.value,google_code:b.google_code,secret:m.value.secret});p.data?(y.success("绑定成功"),d.value=3):y.error(((e=p.data)==null?void 0:e.message)||"绑定失败")}catch(p){console.error("绑定失败:",p),y.error(p.message||"绑定失败")}finally{c.value=!1}},V=()=>{_.value=!1,A("success"),setTimeout(()=>{window.location.reload()},1e3)};return v({open:a}),(r,e)=>{const p=O,k=L,u=T,C=K,Y=N,ee=W;return g(),J(ee,{modelValue:_.value,"onUpdate:modelValue":e[1]||(e[1]=R=>_.value=R),title:"绑定谷歌验证码",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,center:""},{default:l(()=>[s("div",ie,[d.value===1?(g(),x("div",ue,[s("div",ce,[o(p,{class:"step-icon"},{default:l(()=>[o(h(Q))]),_:1}),e[2]||(e[2]=s("h3",null,"扫描二维码",-1)),e[3]||(e[3]=s("p",null,"请使用谷歌验证器扫描下方二维码",-1))]),s("div",pe,[$.value?(g(),x("div",_e,[o(p,{class:"is-loading"},{default:l(()=>[o(h(oe))]),_:1}),e[4]||(e[4]=s("p",null,"生成二维码中...",-1))])):m.value?(g(),x("div",me,[s("img",{src:m.value.qr_code_url,alt:"谷歌验证码二维码"},null,8,fe),s("div",ge,[s("p",null,[e[5]||(e[5]=s("strong",null,"账户：",-1)),B(Z(m.value.account_name),1)]),s("p",null,[e[6]||(e[6]=s("strong",null,"密钥：",-1)),B(Z(m.value.secret),1)])])])):(g(),x("div",ve,[o(p,null,{default:l(()=>[o(h(se))]),_:1}),e[8]||(e[8]=s("p",null,"生成二维码失败",-1)),o(k,{onClick:h(j),type:"primary"},{default:l(()=>[...e[7]||(e[7]=[B("重试",-1)])]),_:1},8,["onClick"])]))]),s("div",we,[o(k,{onClick:i,type:"primary",disabled:!m.value},{default:l(()=>[...e[9]||(e[9]=[B(" 下一步 ",-1)])]),_:1},8,["disabled"])])])):z("",!0),d.value===2?(g(),x("div",he,[s("div",ye,[o(p,{class:"step-icon"},{default:l(()=>[o(h(G))]),_:1}),e[10]||(e[10]=s("h3",null,"验证绑定",-1)),e[11]||(e[11]=s("p",null,"请输入谷歌验证器中的6位数字验证码",-1))]),o(Y,{model:b,rules:E,ref_key:"bindFormRef",ref:f,"label-width":"0"},{default:l(()=>[o(C,{prop:"google_code"},{default:l(()=>[o(u,{modelValue:b.google_code,"onUpdate:modelValue":e[0]||(e[0]=R=>b.google_code=R),placeholder:"请输入6位验证码",maxlength:"6",size:"large",class:"verification-input"},{prefix:l(()=>[o(p,null,{default:l(()=>[o(h(Q))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"]),s("div",be,[o(k,{onClick:U},{default:l(()=>[...e[12]||(e[12]=[B("上一步",-1)])]),_:1}),o(k,{onClick:n,type:"primary",loading:c.value,disabled:!b.google_code},{default:l(()=>[...e[13]||(e[13]=[B(" 完成绑定 ",-1)])]),_:1},8,["loading","disabled"])])])):z("",!0),d.value===3?(g(),x("div",Ve,[s("div",ke,[o(p,{class:"success-icon"},{default:l(()=>[o(h(le))]),_:1}),e[15]||(e[15]=s("h3",null,"绑定成功",-1)),e[16]||(e[16]=s("p",null,"谷歌验证码已成功绑定到您的账户",-1)),o(k,{onClick:V,type:"primary",size:"large"},{default:l(()=>[...e[14]||(e[14]=[B(" 完成 ",-1)])]),_:1})])])):z("",!0)])]),_:1},8,["modelValue"])}}}),xe=M(Ce,[["__scopeId","data-v-476542ff"]]),Ae={class:"dialog-footer"},$e=F({__name:"ChangePasswordDialog",emits:["success","close"],setup(I,{expose:v,emit:w}){const A=w,_=t(!1),d=t(!1),$=t(0),c=H({new_password:"",confirm_password:""}),q=t(),m={new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度至少8位",trigger:"blur"},{validator:(f,a,i)=>{a&&a.length<8?i(new Error("密码长度至少8位")):a&&!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z\d])/.test(a)?i(new Error("密码必须包含大小写字母、数字、特殊字符")):i()},trigger:"blur"}],confirm_password:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(f,a,i)=>{a!==c.new_password?i(new Error("两次输入的密码不一致")):i()},trigger:"blur"}]},b=f=>{_.value=!0,$.value=f,c.new_password="",c.confirm_password=""},E=async()=>{var f,a;try{await((f=q.value)==null?void 0:f.validate()),d.value=!0;const i=await D.post("/api/v1/admin/change-password",{admin_id:$.value,new_password:c.new_password,confirm_password:c.confirm_password});console.log("密码修改API响应:",i),i.code===200&&(y.success("密码修改成功，请重新登录"),_.value=!1,A("success"))}catch(i){console.error("密码修改失败:",i),console.error("错误详情:",(a=i.response)==null?void 0:a.data)}finally{d.value=!1}};return v({open:b}),(f,a)=>{const i=X,U=T,S=K,n=N,V=L,r=W;return g(),J(r,{modelValue:_.value,"onUpdate:modelValue":a[3]||(a[3]=e=>_.value=e),title:"修改密码",width:"500px","close-on-click-modal":!1,"show-close":!1,"close-on-press-escape":!1,"destroy-on-close":""},{footer:l(()=>[s("div",Ae,[o(V,{onClick:E,type:"primary",loading:d.value},{default:l(()=>[...a[4]||(a[4]=[B(" 确认修改 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[o(i,{title:"首次登录需要修改密码",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}}),o(n,{ref_key:"formRef",ref:q,model:c,rules:m,"label-width":"120px",onSubmit:a[2]||(a[2]=ae(()=>{},["prevent"]))},{default:l(()=>[o(S,{label:"新密码",prop:"new_password"},{default:l(()=>[o(U,{modelValue:c.new_password,"onUpdate:modelValue":a[0]||(a[0]=e=>c.new_password=e),type:"password",placeholder:"请输入新密码","show-password":"",clearable:"",onKeyup:P(E,["enter"])},null,8,["modelValue"])]),_:1}),o(S,{label:"确认密码",prop:"confirm_password"},{default:l(()=>[o(U,{modelValue:c.confirm_password,"onUpdate:modelValue":a[1]||(a[1]=e=>c.confirm_password=e),type:"password",placeholder:"请再次输入新密码","show-password":"",clearable:"",onKeyup:P(E,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),qe=M($e,[["__scopeId","data-v-8ea8ed6c"]]),Ie="/assets/login-header-C_4yz5CA.png",Ee={class:"login-container"},Se={class:"login-content"},Be={class:"login-card"},Ue={class:"login-header"},ze={class:"logo-container"},De=["src"],Re={class:"login-form-container"},Ge={class:"form-item"},Pe={class:"form-item"},Fe={key:0,class:"form-item google-auth-input"},Le={class:"form-submit"},Ne={key:0},Ke={key:1},Te=F({__name:"Login",setup(I){const v=t(""),w=t(""),A=t(""),_=t(!1),d=t(!1),$=t(),c=t(!1),q=t(null),m=t(),b=t(!1),E=t(null),f=t({username:"",password:"",googleAuthCode:""}),a=async()=>{var S,n,V,r,e,p,k;if(!v.value||!w.value){y.error("请输入账号和密码");return}try{d.value=!0;const u=await re({username:v.value,password:w.value,google_code:_.value?A.value:""});if((S=u.data)!=null&&S.need_change_password){b.value=!0,E.value=u.data,(n=m.value)==null||n.open(u.data.admin_id);return}if((V=u.data)!=null&&V.need_bind_google){c.value=!0,q.value=u.data,(r=$.value)==null||r.open(u.data.admin_id,u.data.username);return}(e=u.data)!=null&&e.status||(p=u.data)!=null&&p.Authorization?(y.success("登录成功"),setTimeout(()=>{window.location.href="/dashboard"},1e3)):y.error(((k=u.data)==null?void 0:k.message)||"登录失败")}catch(u){u.message&&u.message.includes("请输入谷歌验证码")&&(_.value=!0,setTimeout(()=>{const C=document.querySelector(".google-auth-input .el-input__inner");C&&C.focus()},100)),console.error("登录错误:",u)}finally{d.value=!1}},i=()=>{c.value=!1,q.value=null,y.success("谷歌验证码绑定成功，页面将自动刷新，请重新登录"),v.value="",w.value="",A.value=""},U=()=>{b.value=!1,E.value=null,y.success("密码修改成功，请重新登录"),v.value="",w.value="",A.value=""};return(S,n)=>{const V=O,r=T,e=K,p=X,k=L,u=N;return g(),x("div",Ee,[n[5]||(n[5]=te('<div class="background-decoration" data-v-eab8af5e><div class="floating-shapes" data-v-eab8af5e><div class="shape shape-1" data-v-eab8af5e></div><div class="shape shape-2" data-v-eab8af5e></div><div class="shape shape-3" data-v-eab8af5e></div><div class="shape shape-4" data-v-eab8af5e></div></div></div>',1)),s("div",Se,[s("div",Be,[s("div",Ue,[s("div",ze,[s("img",{src:h(Ie),alt:"系统Logo",class:"logo"},null,8,De)]),n[3]||(n[3]=s("h1",{class:"welcome-title"},"欢迎登录",-1)),n[4]||(n[4]=s("p",{class:"welcome-subtitle"},"百亿三方支付管理系统",-1))]),s("div",Re,[o(u,{model:f.value,class:"login-form","label-position":"top",size:"large"},{default:l(()=>[s("div",Ge,[o(e,null,{default:l(()=>[o(r,{modelValue:v.value,"onUpdate:modelValue":n[0]||(n[0]=C=>v.value=C),placeholder:"请输入登录账号",class:"custom-input",clearable:""},{prefix:l(()=>[o(V,{class:"input-icon"},{default:l(()=>[o(h(ne))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),s("div",Pe,[o(e,null,{default:l(()=>[o(r,{modelValue:w.value,"onUpdate:modelValue":n[1]||(n[1]=C=>w.value=C),type:"password",placeholder:"请输入登录密码",class:"custom-input","show-password":"",clearable:""},{prefix:l(()=>[o(V,{class:"input-icon"},{default:l(()=>[o(h(G))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_.value?(g(),x("div",Fe,[o(p,{title:"请输入谷歌验证码",type:"info",closable:!1,"show-icon":"",class:"google-auth-alert"}),o(e,null,{default:l(()=>[o(r,{modelValue:A.value,"onUpdate:modelValue":n[2]||(n[2]=C=>A.value=C),placeholder:"请输入6位验证码",class:"custom-input",clearable:"",maxlength:"6",onKeyup:P(a,["enter"])},{prefix:l(()=>[o(V,{class:"input-icon"},{default:l(()=>[o(h(G))]),_:1})]),_:1},8,["modelValue"])]),_:1})])):z("",!0),s("div",Le,[o(k,{type:"primary",size:"large",class:"login-button",onClick:a,disabled:!v.value||!w.value,loading:d.value},{default:l(()=>[d.value?(g(),x("span",Ke,"登录中...")):(g(),x("span",Ne,"登录账号"))]),_:1},8,["disabled","loading"])])]),_:1},8,["model"])])])]),o(xe,{ref_key:"googleAuthBindRef",ref:$,onSuccess:i},null,512),o(qe,{ref_key:"changePasswordRef",ref:m,onSuccess:U},null,512)])}}}),Ze=M(Te,[["__scopeId","data-v-eab8af5e"]]);export{Ze as default};
//# sourceMappingURL=Login-DZCBDIZe.js.map
