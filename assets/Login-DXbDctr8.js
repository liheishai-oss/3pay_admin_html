import{s as P,d as K,g as t,h as O,i as W,o as f,w as l,e as s,c as x,j as G,a as o,k as X,u as b,l as j,m as oe,n as I,t as H,p as se,q as N,v as F,x as T,y as M,z as Q,A as le,C as k,D as Y,_ as Z,F as ee,G as ae,H as L,I as te,J as ne,K as de}from"./index-7VWzzcaF.js";/* empty css              */function re($={}){return P({url:"/api/v1/admin/user/login",method:"post",data:$})}const J=$=>P.get("/api/v1/admin/google-auth/qr-code",{params:{admin_id:$}}),ie=$=>P.post("/api/v1/admin/google-auth/bind",$),ue={class:"google-auth-bind"},ce={key:0,class:"step-content"},pe={class:"step-header"},_e={class:"qr-code-container"},me={key:0,class:"qr-loading"},ge={key:1,class:"qr-code"},fe=["src"],ve={class:"qr-info"},we={key:2,class:"qr-error"},he={class:"step-actions"},ye={key:1,class:"step-content"},be={class:"step-header"},ke={class:"step-actions"},Ve={key:2,class:"step-content"},Ce={class:"success-content"},xe=K({__name:"GoogleAuthBind",emits:["success","close"],setup($,{expose:U,emit:v}){const w=v,_=t(!1),c=t(1),h=t(!1),p=t(!1),A=t(0),g=t(null),V=O({google_code:""}),q={google_code:[{required:!0,message:"请输入验证码",trigger:"blur"},{pattern:/^\d{6}$/,message:"请输入6位数字验证码",trigger:"blur"}]},m=t(),a=(i,e)=>{_.value=!0,c.value=1,A.value=i,B()},d=()=>{c.value<3&&c.value++},z=()=>{c.value>1&&c.value--},B=async()=>{try{h.value=!0;const i=await J(A.value);i.data?g.value=i.data:k.error("生成二维码失败")}catch(i){console.error("生成二维码失败:",i),k.error("生成二维码失败")}finally{h.value=!1}},S=async()=>{var i,e;try{await((i=m.value)==null?void 0:i.validate()),p.value=!0;const u=await ie({admin_id:A.value,google_code:V.google_code,secret:g.value.secret});u.data?(k.success("绑定成功"),c.value=3):k.error(((e=u.data)==null?void 0:e.message)||"绑定失败")}catch(u){console.error("绑定失败:",u),k.error(u.message||"绑定失败")}finally{p.value=!1}},r=()=>{_.value=!1,w("success"),setTimeout(()=>{window.location.reload()},1e3)};return U({open:a}),(i,e)=>{const u=X,C=N,D=Q,R=M,n=T,y=Y;return f(),W(y,{modelValue:_.value,"onUpdate:modelValue":e[1]||(e[1]=E=>_.value=E),title:"绑定谷歌验证码",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1,center:""},{default:l(()=>[s("div",ue,[c.value===1?(f(),x("div",ce,[s("div",pe,[o(u,{class:"step-icon"},{default:l(()=>[o(b(j))]),_:1}),e[2]||(e[2]=s("h3",null,"扫描二维码",-1)),e[3]||(e[3]=s("p",null,"请使用谷歌验证器扫描下方二维码",-1))]),s("div",_e,[h.value?(f(),x("div",me,[o(u,{class:"is-loading"},{default:l(()=>[o(b(oe))]),_:1}),e[4]||(e[4]=s("p",null,"生成二维码中...",-1))])):g.value?(f(),x("div",ge,[s("img",{src:g.value.qr_code_url,alt:"谷歌验证码二维码"},null,8,fe),s("div",ve,[s("p",null,[e[5]||(e[5]=s("strong",null,"账户：",-1)),I(H(g.value.account_name),1)]),s("p",null,[e[6]||(e[6]=s("strong",null,"密钥：",-1)),I(H(g.value.secret),1)])])])):(f(),x("div",we,[o(u,null,{default:l(()=>[o(b(se))]),_:1}),e[8]||(e[8]=s("p",null,"生成二维码失败",-1)),o(C,{onClick:b(J),type:"primary"},{default:l(()=>[...e[7]||(e[7]=[I("重试",-1)])]),_:1},8,["onClick"])]))]),s("div",he,[o(C,{onClick:d,type:"primary",disabled:!g.value},{default:l(()=>[...e[9]||(e[9]=[I(" 下一步 ",-1)])]),_:1},8,["disabled"])])])):G("",!0),c.value===2?(f(),x("div",ye,[s("div",be,[o(u,{class:"step-icon"},{default:l(()=>[o(b(F))]),_:1}),e[10]||(e[10]=s("h3",null,"验证绑定",-1)),e[11]||(e[11]=s("p",null,"请输入谷歌验证器中的6位数字验证码",-1))]),o(n,{model:V,rules:q,ref_key:"bindFormRef",ref:m,"label-width":"0"},{default:l(()=>[o(R,{prop:"google_code"},{default:l(()=>[o(D,{modelValue:V.google_code,"onUpdate:modelValue":e[0]||(e[0]=E=>V.google_code=E),placeholder:"请输入6位验证码",maxlength:"6",size:"large",class:"verification-input"},{prefix:l(()=>[o(u,null,{default:l(()=>[o(b(j))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"]),s("div",ke,[o(C,{onClick:z},{default:l(()=>[...e[12]||(e[12]=[I("上一步",-1)])]),_:1}),o(C,{onClick:S,type:"primary",loading:p.value,disabled:!V.google_code},{default:l(()=>[...e[13]||(e[13]=[I(" 完成绑定 ",-1)])]),_:1},8,["loading","disabled"])])])):G("",!0),c.value===3?(f(),x("div",Ve,[s("div",Ce,[o(u,{class:"success-icon"},{default:l(()=>[o(b(le))]),_:1}),e[15]||(e[15]=s("h3",null,"绑定成功",-1)),e[16]||(e[16]=s("p",null,"谷歌验证码已成功绑定到您的账户",-1)),o(C,{onClick:r,type:"primary",size:"large"},{default:l(()=>[...e[14]||(e[14]=[I(" 完成 ",-1)])]),_:1})])])):G("",!0)])]),_:1},8,["modelValue"])}}}),Ae=Z(xe,[["__scopeId","data-v-476542ff"]]),$e={class:"dialog-footer"},qe=K({__name:"ChangePasswordDialog",emits:["success","close"],setup($,{expose:U,emit:v}){const w=v,_=t(!1),c=t(!1),h=t(0),p=O({new_password:"",confirm_password:""}),A=t(),g={new_password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:8,message:"密码长度至少8位",trigger:"blur"},{validator:(m,a,d)=>{a&&a.length<8?d(new Error("密码长度至少8位")):a&&!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z\d])/.test(a)?d(new Error("密码必须包含大小写字母、数字、特殊字符")):d()},trigger:"blur"}],confirm_password:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(m,a,d)=>{a!==p.new_password?d(new Error("两次输入的密码不一致")):d()},trigger:"blur"}]},V=m=>{_.value=!0,h.value=m,p.new_password="",p.confirm_password=""},q=async()=>{var m,a;try{await((m=A.value)==null?void 0:m.validate()),c.value=!0;const d=await P.post("/api/v1/admin/change-password",{admin_id:h.value,new_password:p.new_password,confirm_password:p.confirm_password});console.log("密码修改API响应:",d),d.code===200&&(k.success("密码修改成功，请重新登录"),_.value=!1,w("success"))}catch(d){console.error("密码修改失败:",d),console.error("错误详情:",(a=d.response)==null?void 0:a.data)}finally{c.value=!1}};return U({open:V}),(m,a)=>{const d=ee,z=Q,B=M,S=T,r=N,i=Y;return f(),W(i,{modelValue:_.value,"onUpdate:modelValue":a[3]||(a[3]=e=>_.value=e),title:"修改密码",width:"500px","close-on-click-modal":!1,"show-close":!1,"close-on-press-escape":!1,"destroy-on-close":""},{footer:l(()=>[s("div",$e,[o(r,{onClick:q,type:"primary",loading:c.value},{default:l(()=>[...a[4]||(a[4]=[I(" 确认修改 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[o(d,{title:"首次登录需要修改密码",type:"warning",closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}}),o(S,{ref_key:"formRef",ref:A,model:p,rules:g,"label-width":"120px",onSubmit:a[2]||(a[2]=ae(()=>{},["prevent"]))},{default:l(()=>[o(B,{label:"新密码",prop:"new_password"},{default:l(()=>[o(z,{modelValue:p.new_password,"onUpdate:modelValue":a[0]||(a[0]=e=>p.new_password=e),type:"password",placeholder:"请输入新密码","show-password":"",clearable:"",onKeyup:L(q,["enter"])},null,8,["modelValue"])]),_:1}),o(B,{label:"确认密码",prop:"confirm_password"},{default:l(()=>[o(z,{modelValue:p.confirm_password,"onUpdate:modelValue":a[1]||(a[1]=e=>p.confirm_password=e),type:"password",placeholder:"请再次输入新密码","show-password":"",clearable:"",onKeyup:L(q,["enter"])},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])}}}),Ie=Z(qe,[["__scopeId","data-v-8ea8ed6c"]]),Se="/assets/login-header-C_4yz5CA.png",Ee={class:"login-container"},ze={class:"login-content"},Be={class:"login-card"},De={class:"login-header"},Re={class:"logo-container"},Ue=["src"],Ge={class:"login-form-container"},Pe={class:"form-item"},Fe={class:"form-item"},Le={key:0,class:"form-item google-auth-input"},Ke={class:"form-submit"},Ne={key:0},Te={key:1},Me=K({__name:"Login",setup($){const U=ne(),v=t(""),w=t(""),_=t(""),c=t(!1),h=t(!1),p=t(),A=t(!1),g=t(null),V=t(),q=t(!1),m=t(null),a=t({username:"",password:"",googleAuthCode:""}),d=async()=>{var S,r,i,e,u,C,D,R;if(!v.value||!w.value){k.error("请输入账号和密码");return}try{h.value=!0;const n=await re({username:v.value,password:w.value,google_code:c.value?_.value:""});if((S=n.data)!=null&&S.need_change_password){q.value=!0,m.value=n.data,(r=V.value)==null||r.open(n.data.admin_id);return}if((i=n.data)!=null&&i.need_bind_google){A.value=!0,g.value=n.data,(e=p.value)==null||e.open(n.data.admin_id,n.data.username);return}const y=n,E=((u=y.data)==null?void 0:u.Authorization)||((D=(C=y.data)==null?void 0:C.data)==null?void 0:D.Authorization);y.status===!0||y.code===200||E?(E&&localStorage.setItem("token",E),k.success("登录成功"),setTimeout(()=>{U.push("/dashboard")},1e3)):k.error(y.message||((R=y.data)==null?void 0:R.message)||"登录失败")}catch(n){n.message&&n.message.includes("请输入谷歌验证码")&&(c.value=!0,setTimeout(()=>{const y=document.querySelector(".google-auth-input .el-input__inner");y&&y.focus()},100)),console.error("登录错误:",n)}finally{h.value=!1}},z=()=>{A.value=!1,g.value=null,k.success("谷歌验证码绑定成功，页面将自动刷新，请重新登录"),v.value="",w.value="",_.value=""},B=()=>{q.value=!1,m.value=null,k.success("密码修改成功，请重新登录"),v.value="",w.value="",_.value=""};return(S,r)=>{const i=X,e=Q,u=M,C=ee,D=N,R=T;return f(),x("div",Ee,[r[5]||(r[5]=te('<div class="background-decoration" data-v-d3ab2480><div class="floating-shapes" data-v-d3ab2480><div class="shape shape-1" data-v-d3ab2480></div><div class="shape shape-2" data-v-d3ab2480></div><div class="shape shape-3" data-v-d3ab2480></div><div class="shape shape-4" data-v-d3ab2480></div></div></div>',1)),s("div",ze,[s("div",Be,[s("div",De,[s("div",Re,[s("img",{src:b(Se),alt:"系统Logo",class:"logo"},null,8,Ue)]),r[3]||(r[3]=s("h1",{class:"welcome-title"},"欢迎登录",-1)),r[4]||(r[4]=s("p",{class:"welcome-subtitle"},"百亿三方支付管理系统",-1))]),s("div",Ge,[o(R,{model:a.value,class:"login-form","label-position":"top",size:"large"},{default:l(()=>[s("div",Pe,[o(u,null,{default:l(()=>[o(e,{modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=n=>v.value=n),placeholder:"请输入登录账号",class:"custom-input",clearable:""},{prefix:l(()=>[o(i,{class:"input-icon"},{default:l(()=>[o(b(de))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),s("div",Fe,[o(u,null,{default:l(()=>[o(e,{modelValue:w.value,"onUpdate:modelValue":r[1]||(r[1]=n=>w.value=n),type:"password",placeholder:"请输入登录密码",class:"custom-input","show-password":"",clearable:""},{prefix:l(()=>[o(i,{class:"input-icon"},{default:l(()=>[o(b(F))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),c.value?(f(),x("div",Le,[o(C,{title:"请输入谷歌验证码",type:"info",closable:!1,"show-icon":"",class:"google-auth-alert"}),o(u,null,{default:l(()=>[o(e,{modelValue:_.value,"onUpdate:modelValue":r[2]||(r[2]=n=>_.value=n),placeholder:"请输入6位验证码",class:"custom-input",clearable:"",maxlength:"6",onKeyup:L(d,["enter"])},{prefix:l(()=>[o(i,{class:"input-icon"},{default:l(()=>[o(b(F))]),_:1})]),_:1},8,["modelValue"])]),_:1})])):G("",!0),s("div",Ke,[o(D,{type:"primary",size:"large",class:"login-button",onClick:d,disabled:!v.value||!w.value,loading:h.value},{default:l(()=>[h.value?(f(),x("span",Te,"登录中...")):(f(),x("span",Ne,"登录账号"))]),_:1},8,["disabled","loading"])])]),_:1},8,["model"])])])]),o(Ae,{ref_key:"googleAuthBindRef",ref:p,onSuccess:z},null,512),o(Ie,{ref_key:"changePasswordRef",ref:V,onSuccess:B},null,512)])}}}),je=Z(Me,[["__scopeId","data-v-d3ab2480"]]);export{je as default};
//# sourceMappingURL=Login-DXbDctr8.js.map
