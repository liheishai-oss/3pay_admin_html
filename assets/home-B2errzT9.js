import{d as Ct,g as E,a9 as Et,L as Vt,aj as Tt,c as N,a as e,e as o,w as a,T as Dt,u as h,n as s,t as r,M as J,s as T,q as St,O as $t,P as Bt,D as Mt,o as u,Q as zt,a1 as Rt,x as It,E as Ut,i as p,j as D,b as Yt,y as jt,z as Pt,ap as Lt,as as Ft,aq as Nt,at as Gt,k as Ht,V as Ot,S as G,R as qt,W as At,a8 as Jt,aJ as Kt,aK as Qt,aL as Wt,aM as Xt,aB as Zt,aN as te,au as ee,av as ae,C as c,aF as j,_ as le}from"./index-_X_07Eu8.js";/* empty css                          *//* empty css                   *//* empty css               *//* empty css                     *//* empty css                 *//* empty css                          */import{u as se}from"./table.plugin-BY9GB1u6.js";const ne={class:"table-com-search"},oe={class:"search-buttons"},re={class:"table-header ba-scroll-style"},ue={class:"table-statistics-bar"},ie={class:"stat stat-amt"},de={class:"stat-num"},_e={class:"stat"},pe={class:"stat-num"},me={class:"stat stat-amt"},ce={class:"stat-num"},fe={class:"stat stat-succ"},ye={class:"stat-num"},ge={class:"stat stat-amt"},ve={class:"stat-num"},be={class:"stat stat-rate"},we={class:"stat-num"},he={class:"stat"},ke={class:"stat-num"},xe={style:{width:"100%","overflow-x":"auto"},class:"table-content"},Ce={key:3},Ee={style:{color:"#909399","font-size":"12px"}},Ve={style:{color:"#909399","font-size":"12px"}},Te={class:"table-footer"},De={class:"table-pagination"},Se=Ct({__name:"home",setup($e){const{loadData:K,data:$,refreshData:B,handleSizeChange:Q,handleCurrentChange:W,searchParams:I}=se("/api/v1/admin/order/list"),X=E(!0),Z=()=>{const l=new Date,t=l.getFullYear(),d=String(l.getMonth()+1).padStart(2,"0"),_=String(l.getDate()).padStart(2,"0");return`${t}-${d}-${_}`},U=()=>{const l=Z();return[`${l} 00:00:00`,`${l} 23:59:59`]},P=E(U()),y=E({agent_id:"",merchant_id:"",platform_order_no:"",merchant_order_no:"",pay_status:"",notify_status:"",start_time:U()[0],end_time:U()[1]}),tt=l=>{l&&l.length===2?(y.value.start_time=l[0],y.value.end_time=l[1]):(y.value.start_time="",y.value.end_time="")},et=E([]),H=E([]),C=E({total_count:0,paid_count:0,unpaid_count:0,closed_count:0,refunded_count:0,total_amount:0,paid_amount:0,success_rate:0,official_fee:0,last_minute_count:0}),L=E(!1),i=E(null),F=E({}),O=Et(()=>{var l;return((l=F.value)==null?void 0:l.is_agent)===!0}),at=async()=>{try{const l=await T({url:"/api/v1/admin/user/info",method:"GET"});l.status&&(F.value=l.data)}catch(l){console.error("获取用户信息失败:",l)}},lt=async()=>{if(!O.value)try{const l=await T({url:"/api/v1/admin/order/agent-list",method:"GET"});l.status&&(et.value=l.data)}catch(l){console.error("获取代理商列表失败:",l)}},st=async()=>{try{const l=await T({url:"/api/v1/admin/order/merchant-list",method:"GET",params:{agent_id:y.value.agent_id}});l.status&&(H.value=l.data)}catch(l){console.error("获取商户列表失败:",l)}},Y=async()=>{try{const l=await T({url:"/api/v1/admin/order/statistics",method:"GET",params:I.value});l.status&&(C.value=l.data)}catch(l){console.error("获取统计失败:",l)}},nt=async()=>{I.value={...y.value},await B(),await Y()},ot=()=>{const l=U();P.value=l,y.value={agent_id:"",merchant_id:"",platform_order_no:"",merchant_order_no:"",pay_status:"",notify_status:"",start_time:l[0],end_time:l[1]},I.value={...y.value},B(),Y()},rt=l=>{const{action:t,row:d}=l;switch(t){case"detail":dt(d);break;case"callback":pt(d);break;case"supplement":mt(d);break}},ut=l=>({0:"待支付",1:"已支付",2:"已关闭",3:"已退款"})[l]||"未知",it=l=>({0:"未通知",1:"通知成功",2:"通知失败"})[l]||"未知",dt=async l=>{try{const t=await T({url:`/api/v1/admin/order/detail/${l.id}`,method:"GET"});t.status&&(i.value=t.data,L.value=!0)}catch(t){console.error("获取详情失败:",t)}},V=E([]),_t=l=>{V.value=l},pt=async l=>{var t,d,_,m,f,S;if(l.platform_order_no){if(!l.notify_url){c.warning("该订单无回调地址，已跳过");return}try{await j.confirm(`确定要回调订单 ${l.platform_order_no} 吗？`,"确认回调",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}try{const w=await T.post("/api/v1/admin/order/callback",{ids:[l.id]});if(w.status){const k=w.data;k.success_count>0?c.success(`回调成功：${k.message||"回调已发送"}`):k.skipped_count>0?c.warning(`回调跳过：${((d=(t=k.results)==null?void 0:t[0])==null?void 0:d.message)||"订单无回调地址"}`):c.error(`回调失败：${((m=(_=k.results)==null?void 0:_[0])==null?void 0:m.message)||"未知错误"}`),B()}else c.error(w.msg||"回调失败")}catch(w){c.error(((S=(f=w.response)==null?void 0:f.data)==null?void 0:S.msg)||w.message||"回调失败")}}},mt=async l=>{var t,d,_,m,f,S;if(l.platform_order_no){try{await j.confirm("确定要补单吗？系统将查询支付宝订单状态并更新本地订单。","确认补单",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}try{const w=await T.post("/api/v1/admin/order/reissue",{ids:[l.id]});if(w.status){const k=w.data;k.success_count>0?c.success(`补单成功：${k.message||"订单已更新并触发回调"}`):k.skipped_count>0?c.warning(`补单跳过：${((d=(t=k.results)==null?void 0:t[0])==null?void 0:d.message)||"订单已支付或已关闭"}`):c.error(`补单失败：${((m=(_=k.results)==null?void 0:_[0])==null?void 0:m.message)||"未知错误"}`),B()}else c.error(w.msg||"补单失败")}catch(w){c.error(((S=(f=w.response)==null?void 0:f.data)==null?void 0:S.msg)||w.message||"补单失败")}}},ct=async()=>{var d,_;if(!V.value.length){c.warning("请先选择要回调的订单");return}const l=V.value.filter(m=>!!m.notify_url),t=V.value.length-l.length;if(!l.length){c.warning("所选订单均无回调地址，已全部跳过");return}try{await j.confirm(`确定要批量回调 ${l.length} 个订单吗？${t>0?`（${t} 个订单无回调地址将被跳过）`:""}`,"确认批量回调",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}try{const m=await T.post("/api/v1/admin/order/callback",{ids:l.map(f=>f.id)});if(m.status){const f=m.data;c.success(f.message||`批量回调完成：成功 ${f.success_count} 条，失败 ${f.failed_count} 条，跳过 ${f.skipped_count} 条`),B()}else c.error(m.msg||"批量回调失败")}catch(m){c.error(((_=(d=m.response)==null?void 0:d.data)==null?void 0:_.msg)||m.message||"批量回调失败")}},ft=async()=>{var l,t;if(!V.value.length){c.warning("请先选择要补单的订单");return}try{await j.confirm(`确定要批量补单 ${V.value.length} 个订单吗？系统将查询支付宝订单状态并更新本地订单。`,"确认批量补单",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"})}catch{return}try{const d=await T.post("/api/v1/admin/order/reissue",{ids:V.value.map(_=>_.id)});if(d.status){const _=d.data;c.success(_.message||`批量补单完成：成功 ${_.success_count} 条，失败 ${_.failed_count} 条，跳过 ${_.skipped_count} 条`),B()}else c.error(d.msg||"批量补单失败")}catch(d){c.error(((t=(l=d.response)==null?void 0:l.data)==null?void 0:t.msg)||d.message||"批量补单失败")}};return Vt(async()=>{await at(),await lt(),await st(),I.value={...y.value},K(),Y()}),Tt(()=>$.data,()=>{Y()},{deep:!0}),(l,t)=>{const d=Pt,_=jt,m=Yt,f=Nt,S=Lt,w=Ut,k=Gt,M=Ht,z=St,yt=It,gt=Rt,x=At,v=Jt,R=Xt,vt=Wt,bt=Kt,wt=$t,ht=Bt,g=ae,kt=ee,xt=Mt;return u(),N(J,null,[e(Dt,{name:"fade"},{default:a(()=>[zt(o("div",ne,[e(gt,{class:"search-card",shadow:"never"},{default:a(()=>[e(yt,{model:y.value,"label-width":"100px",class:"search-form"},{default:a(()=>[e(w,{gutter:20},{default:a(()=>{var n;return[e(m,{span:6},{default:a(()=>[e(_,{label:"平台订单号"},{default:a(()=>[e(d,{modelValue:y.value.platform_order_no,"onUpdate:modelValue":t[0]||(t[0]=b=>y.value.platform_order_no=b),placeholder:"请输入平台订单号",clearable:"","prefix-icon":"Search"},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:6},{default:a(()=>[e(_,{label:"商户订单号"},{default:a(()=>[e(d,{modelValue:y.value.merchant_order_no,"onUpdate:modelValue":t[1]||(t[1]=b=>y.value.merchant_order_no=b),placeholder:"请输入商户订单号",clearable:"","prefix-icon":"Search"},null,8,["modelValue"])]),_:1})]),_:1}),(n=F.value)!=null&&n.is_merchant_admin?D("",!0):(u(),p(m,{key:0,span:6},{default:a(()=>[e(_,{label:"商户"},{default:a(()=>[e(S,{modelValue:y.value.merchant_id,"onUpdate:modelValue":t[2]||(t[2]=b=>y.value.merchant_id=b),placeholder:"请选择商户",clearable:"",filterable:"",style:{width:"100%"}},{default:a(()=>[(u(!0),N(J,null,Ft(H.value,b=>(u(),p(f,{key:b.id,label:b.merchant_name,value:b.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})),e(m,{span:6},{default:a(()=>[e(_,{label:"支付状态"},{default:a(()=>[e(S,{modelValue:y.value.pay_status,"onUpdate:modelValue":t[3]||(t[3]=b=>y.value.pay_status=b),placeholder:"请选择订单状态",clearable:"",style:{width:"100%"}},{default:a(()=>[e(f,{label:"全部",value:""}),e(f,{label:"待支付",value:0}),e(f,{label:"已支付",value:1}),e(f,{label:"已关闭",value:2}),e(f,{label:"已退款",value:3})]),_:1},8,["modelValue"])]),_:1})]),_:1})]}),_:1}),e(w,{gutter:20},{default:a(()=>[e(m,{span:6},{default:a(()=>[e(_,{label:"时间范围"},{default:a(()=>[e(k,{modelValue:P.value,"onUpdate:modelValue":t[4]||(t[4]=n=>P.value=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"},onChange:tt,clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:6},{default:a(()=>[e(_,null,{default:a(()=>[o("div",oe,[e(z,{type:"primary",onClick:nt},{default:a(()=>[e(M,null,{default:a(()=>[e(h(Ot))]),_:1}),t[8]||(t[8]=s("搜索 ",-1))]),_:1}),e(z,{onClick:ot},{default:a(()=>[e(M,null,{default:a(()=>[e(h(G))]),_:1}),t[9]||(t[9]=s("重置 ",-1))]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})],512),[[qt,X.value]])]),_:1}),o("div",re,[e(z,{icon:h(G),onClick:h(B),color:"#40485b"},null,8,["icon","onClick"]),e(z,{type:"primary",onClick:ct,disabled:V.value.length===0},{default:a(()=>[...t[10]||(t[10]=[s("一键回调",-1)])]),_:1},8,["disabled"]),e(z,{type:"warning",onClick:ft,disabled:V.value.length===0},{default:a(()=>[...t[11]||(t[11]=[s("一键补单",-1)])]),_:1},8,["disabled"]),o("div",ue,[o("span",ie,[t[12]||(t[12]=s("总金额: ",-1)),o("b",de,"¥"+r(C.value.total_amount?C.value.total_amount:0),1)]),t[19]||(t[19]=o("span",{class:"split"},"|",-1)),o("span",_e,[t[13]||(t[13]=s("总订单: ",-1)),o("b",pe,r(C.value.total_count||0),1)]),t[20]||(t[20]=o("span",{class:"split"},"|",-1)),o("span",me,[t[14]||(t[14]=s("成交额: ",-1)),o("b",ce,"¥"+r(C.value.paid_amount?C.value.paid_amount:0),1)]),t[21]||(t[21]=o("span",{class:"split"},"|",-1)),o("span",fe,[t[15]||(t[15]=s("成功订单量: ",-1)),o("b",ye,r(C.value.paid_count||0),1)]),t[22]||(t[22]=o("span",{class:"split"},"|",-1)),o("span",ge,[t[16]||(t[16]=s("官方手续费: ",-1)),o("b",ve,"¥"+r(C.value.official_fee?C.value.official_fee:0),1)]),t[23]||(t[23]=o("span",{class:"split"},"|",-1)),o("span",be,[t[17]||(t[17]=s("成功率: ",-1)),o("b",we,r(C.value.success_rate||0)+"%",1)]),t[24]||(t[24]=o("span",{class:"split"},"|",-1)),o("span",he,[t[18]||(t[18]=s("一分钟订单数: ",-1)),o("b",ke,r(C.value.last_minute_count||0),1)])])]),o("div",xe,[e(wt,{data:h($).data,border:"",stripe:"","max-height":"600",style:{width:"100%"},onSelectionChange:_t},{default:a(()=>[e(x,{type:"selection",width:"40"}),O.value?D("",!0):(u(),p(x,{key:0,prop:"agent.agent_name",label:"代理商",align:"center","min-width":"120"})),e(x,{prop:"merchant.merchant_name",label:"商户",align:"center","min-width":"150"}),e(x,{prop:"platform_order_no",label:"平台订单号",align:"center","min-width":"200"}),e(x,{prop:"merchant_order_no",label:"商户订单号",align:"center","min-width":"180"}),e(x,{label:"支付主体",align:"center","min-width":"150"},{default:a(({row:n})=>{var b;return[s(r(((b=n.subject)==null?void 0:b.company_name)||"-"),1)]}),_:1}),e(x,{prop:"order_amount",label:"订单金额",align:"center","min-width":"120"},{default:a(({row:n})=>[s(" ¥"+r(n.order_amount),1)]),_:1}),e(x,{label:"支付状态",align:"center","min-width":"100"},{default:a(({row:n})=>[n.pay_status===0?(u(),p(v,{key:0,type:"info"},{default:a(()=>[...t[25]||(t[25]=[s("待支付",-1)])]),_:1})):n.pay_status===1?(u(),p(v,{key:1,type:"success"},{default:a(()=>[...t[26]||(t[26]=[s("已支付",-1)])]),_:1})):n.pay_status===2?(u(),p(v,{key:2,type:"warning"},{default:a(()=>[...t[27]||(t[27]=[s("已关闭",-1)])]),_:1})):n.pay_status===3?(u(),p(v,{key:3,type:"danger"},{default:a(()=>[...t[28]||(t[28]=[s("已退款",-1)])]),_:1})):D("",!0)]),_:1}),e(x,{label:"分账状态",align:"center","min-width":"120"},{default:a(({row:n})=>{var b,q,A;return[((b=n.subject)==null?void 0:b.royalty_type)==="none"?(u(),p(v,{key:0,type:"info"},{default:a(()=>[...t[29]||(t[29]=[s("不分账",-1)])]),_:1})):((q=n.subject)==null?void 0:q.royalty_type)==="single"?(u(),p(v,{key:1,type:"success"},{default:a(()=>[...t[30]||(t[30]=[s("单笔分账",-1)])]),_:1})):((A=n.subject)==null?void 0:A.royalty_type)==="merchant"?(u(),p(v,{key:2,type:"warning"},{default:a(()=>[...t[31]||(t[31]=[s("商家分账",-1)])]),_:1})):(u(),N("span",Ce,"-"))]}),_:1}),e(x,{label:"通知状态",align:"center","min-width":"100"},{default:a(({row:n})=>[n.notify_status===0?(u(),p(v,{key:0,type:"warning"},{default:a(()=>[...t[32]||(t[32]=[s("未通知",-1)])]),_:1})):n.notify_status===1?(u(),p(v,{key:1,type:"success"},{default:a(()=>[...t[33]||(t[33]=[s("通知成功",-1)])]),_:1})):n.notify_status===2?(u(),p(v,{key:2,type:"danger"},{default:a(()=>[...t[34]||(t[34]=[s("通知失败",-1)])]),_:1})):D("",!0)]),_:1}),e(x,{prop:"created_at",label:"创建时间",align:"center","min-width":"160"}),e(x,{prop:"pay_time",label:"支付时间",align:"center","min-width":"160"}),e(x,{label:"操作",align:"center",fixed:"right","min-width":"120"},{default:a(n=>[e(bt,{onCommand:rt,trigger:"click"},{dropdown:a(()=>[e(vt,null,{default:a(()=>[e(R,{command:{action:"detail",row:n.row}},{default:a(()=>[e(M,null,{default:a(()=>[e(h(Zt))]),_:1}),t[36]||(t[36]=s("查看详情 ",-1))]),_:1},8,["command"]),n.row.pay_status===1?(u(),p(R,{key:0,command:{action:"callback",row:n.row},disabled:!n.row.notify_url},{default:a(()=>[e(M,null,{default:a(()=>[e(h(te))]),_:1}),t[37]||(t[37]=s("回调通知 ",-1))]),_:1},8,["command","disabled"])):D("",!0),e(R,{command:{action:"supplement",row:n.row}},{default:a(()=>[e(M,null,{default:a(()=>[e(h(G))]),_:1}),t[38]||(t[38]=s("补单查询 ",-1))]),_:1},8,["command"]),e(R,{divided:""},{default:a(()=>[o("span",Ee," 状态："+r(ut(n.row.pay_status))+" | 通知："+r(it(n.row.notify_status)),1)]),_:2},1024),n.row.notify_times?(u(),p(R,{key:1,divided:""},{default:a(()=>[o("span",Ve," 回调次数："+r(n.row.notify_times)+" / 5 ",1)]),_:2},1024)):D("",!0)]),_:2},1024)]),default:a(()=>[e(z,{type:"primary",size:"small"},{default:a(()=>[t[35]||(t[35]=s(" 操作 ",-1)),e(M,{class:"el-icon--right"},{default:a(()=>[e(h(Qt))]),_:1})]),_:1})]),_:2},1024)]),_:1})]),_:1},8,["data"])]),o("div",Te,[o("div",De,[e(ht,{"current-page":h($).current_page,"onUpdate:currentPage":t[5]||(t[5]=n=>h($).current_page=n),"page-size":h($).page_size,"onUpdate:pageSize":t[6]||(t[6]=n=>h($).page_size=n),"page-sizes":[10,50,100,200],background:!0,"prev-text":"上一页","next-text":"下一页",layout:"total, sizes, prev, pager, next, jumper",total:h($).page_total,onSizeChange:h(Q),onCurrentChange:h(W)},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),e(xt,{modelValue:L.value,"onUpdate:modelValue":t[7]||(t[7]=n=>L.value=n),title:"订单详情",width:"800px"},{default:a(()=>[i.value?(u(),p(kt,{key:0,column:2,border:""},{default:a(()=>[e(g,{label:"平台订单号"},{default:a(()=>[s(r(i.value.platform_order_no),1)]),_:1}),e(g,{label:"商户订单号"},{default:a(()=>[s(r(i.value.merchant_order_no),1)]),_:1}),e(g,{label:"订单金额"},{default:a(()=>[s("¥"+r(i.value.order_amount),1)]),_:1}),e(g,{label:"代理商"},{default:a(()=>{var n;return[s(r(((n=i.value.agent)==null?void 0:n.agent_name)||"-"),1)]}),_:1}),e(g,{label:"商户"},{default:a(()=>{var n;return[s(r(((n=i.value.merchant)==null?void 0:n.merchant_name)||"-"),1)]}),_:1}),e(g,{label:"产品"},{default:a(()=>{var n;return[s(r(((n=i.value.product)==null?void 0:n.product_name)||"-"),1)]}),_:1}),e(g,{label:"主体"},{default:a(()=>{var n;return[s(r(((n=i.value.subject)==null?void 0:n.company_name)||"-"),1)]}),_:1}),e(g,{label:"支付状态"},{default:a(()=>[i.value.pay_status===0?(u(),p(v,{key:0,type:"info"},{default:a(()=>[...t[39]||(t[39]=[s("待支付",-1)])]),_:1})):i.value.pay_status===1?(u(),p(v,{key:1,type:"success"},{default:a(()=>[...t[40]||(t[40]=[s("已支付",-1)])]),_:1})):i.value.pay_status===2?(u(),p(v,{key:2,type:"warning"},{default:a(()=>[...t[41]||(t[41]=[s("已关闭",-1)])]),_:1})):i.value.pay_status===3?(u(),p(v,{key:3,type:"danger"},{default:a(()=>[...t[42]||(t[42]=[s("已退款",-1)])]),_:1})):D("",!0)]),_:1}),e(g,{label:"通知状态"},{default:a(()=>[i.value.notify_status===0?(u(),p(v,{key:0,type:"info"},{default:a(()=>[...t[43]||(t[43]=[s("未通知",-1)])]),_:1})):i.value.notify_status===1?(u(),p(v,{key:1,type:"success"},{default:a(()=>[...t[44]||(t[44]=[s("通知成功",-1)])]),_:1})):i.value.notify_status===2?(u(),p(v,{key:2,type:"danger"},{default:a(()=>[...t[45]||(t[45]=[s("通知失败",-1)])]),_:1})):D("",!0)]),_:1}),e(g,{label:"通知次数"},{default:a(()=>[s(r(i.value.notify_times),1)]),_:1}),e(g,{label:"客户端IP"},{default:a(()=>[s(r(i.value.client_ip||"-"),1)]),_:1}),e(g,{label:"创建时间"},{default:a(()=>[s(r(i.value.created_at),1)]),_:1}),e(g,{label:"支付时间"},{default:a(()=>[s(r(i.value.pay_time||"-"),1)]),_:1}),e(g,{label:"通知时间"},{default:a(()=>[s(r(i.value.notify_time||"-"),1)]),_:1}),e(g,{label:"关闭时间"},{default:a(()=>[s(r(i.value.close_time||"-"),1)]),_:1}),e(g,{label:"回调通知地址",span:2},{default:a(()=>[s(r(i.value.notify_url||"-"),1)]),_:1}),e(g,{label:"同步返回地址",span:2},{default:a(()=>[s(r(i.value.return_url||"-"),1)]),_:1}),e(g,{label:"备注",span:2},{default:a(()=>[s(r(i.value.remark||"-"),1)]),_:1})]),_:1})):D("",!0)]),_:1},8,["modelValue"])],64)}}}),Pe=le(Se,[["__scopeId","data-v-888f4d42"]]);export{Pe as default};
//# sourceMappingURL=home-B2errzT9.js.map
