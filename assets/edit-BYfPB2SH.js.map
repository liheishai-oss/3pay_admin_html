{"version":3,"file":"edit-BYfPB2SH.js","sources":["../../src/pages/product/edit.vue"],"sourcesContent":["<template>\n  <el-dialog \n    v-model=\"visible\" \n    :title=\"form.id === 0 ? '新增产品' : '编辑产品'\" \n    width=\"600px\"\n    :close-on-click-modal=\"false\"\n  >\n    <el-form :model=\"form\" label-width=\"120px\" :rules=\"rules\" ref=\"formRef\">\n      <!-- 代理商选择（仅管理员） -->\n      <el-row :gutter=\"20\" v-if=\"!isAgent\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"代理商\" prop=\"agent_id\">\n            <el-select \n              v-model=\"form.agent_id\" \n              placeholder=\"请选择代理商\" \n              clearable\n              filterable\n              :disabled=\"form.id > 0\"\n            >\n              <el-option\n                v-for=\"agent in agentList\"\n                :key=\"agent.id\"\n                :label=\"agent.agent_name\"\n                :value=\"agent.id\"\n              />\n            </el-select>\n            <div class=\"form-tip\" v-if=\"form.id > 0\">代理商创建后不可修改</div>\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"产品名称\" prop=\"product_name\">\n            <el-input \n              v-model=\"form.product_name\" \n              placeholder=\"请输入产品名称\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"支付类型\" prop=\"payment_type_id\">\n            <el-select \n              v-model=\"form.payment_type_id\" \n              placeholder=\"请选择支付类型\" \n              clearable\n              filterable\n            >\n              <el-option\n                v-for=\"type in paymentTypeList\"\n                :key=\"type.id\"\n                :label=\"type.product_name\"\n                :value=\"type.id\"\n              />\n            </el-select>\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\" v-if=\"form.id > 0\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"产品编号\">\n            <el-input \n              v-model=\"form.product_code\" \n              disabled\n            />\n            <div class=\"form-tip\">产品编号自动生成，不可修改</div>\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-alert\n        v-if=\"form.id === 0\"\n        title=\"产品编号将在创建时自动生成（4位数字）\"\n        type=\"info\"\n        :closable=\"false\"\n        show-icon\n        style=\"margin-bottom: 20px;\">\n      </el-alert>\n\n      <el-form-item label=\"状态\" prop=\"status\">\n        <el-switch \n          v-model=\"form.status\" \n          :active-value=\"1\" \n          :inactive-value=\"0\"\n        />\n      </el-form-item>\n\n      <el-form-item label=\"备注\" prop=\"remark\">\n        <el-input \n          v-model=\"form.remark\" \n          type=\"textarea\" \n          :rows=\"3\"\n          placeholder=\"请输入备注\"\n        />\n      </el-form-item>\n\n      <el-form-item>\n        <el-button type=\"primary\" @click=\"handleSubmit\" :icon=\"Check\">提交</el-button>\n        <el-button @click=\"visible = false\" :icon=\"Close\">取消</el-button>\n      </el-form-item>\n    </el-form>\n  </el-dialog>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref, computed } from 'vue';\nimport { ElMessage } from 'element-plus';\nimport { Check, Close } from '@element-plus/icons-vue';\nimport request from '@/utils/request';\n\n// 定义emit\nconst emit = defineEmits(['refresh']);\n\n// 表单ref\nconst formRef = ref();\n\n// 控制dialog显示\nconst visible = ref(false);\n\n// 表单数据\nconst form = ref({\n  id: 0,\n  agent_id: '',\n  product_name: '',\n  payment_type_id: '',\n  product_code: '',\n  status: 1,\n  remark: ''\n});\n\n// 用户信息\nconst userInfo = ref<any>({});\nconst isAgent = computed(() => userInfo.value?.is_agent === true);\n\n// 代理商列表\nconst agentList = ref([]);\n\n// 支付类型列表\nconst paymentTypeList = ref([]);\n\n// 验证规则（动态）\nconst rules = computed(() => {\n  const baseRules: any = {\n    product_name: [\n      { required: true, message: '请输入产品名称', trigger: 'blur' }\n    ],\n    payment_type_id: [\n      { required: true, message: '请选择支付类型', trigger: 'change' }\n    ]\n  };\n  \n  // 只有管理员需要验证agent_id\n  if (!isAgent.value) {\n    baseRules.agent_id = [\n      { required: true, message: '请选择代理商', trigger: 'change' }\n    ];\n  }\n  \n  return baseRules;\n});\n\n// 获取用户信息\nconst getUserInfo = async () => {\n  try {\n    const res = await request({\n      url: '/api/v1/admin/user/info',\n      method: 'GET'\n    });\n    if (res.status) {\n      userInfo.value = res.data;\n    }\n  } catch (error) {\n    console.error('获取用户信息失败:', error);\n  }\n};\n\n// 获取代理商列表\nconst getAgentList = async () => {\n  if (isAgent.value) return;\n  \n  try {\n    const res = await request({\n      url: '/api/v1/admin/product/agent-list',\n      method: 'GET'\n    });\n    if (res.status) {\n      agentList.value = res.data;\n    }\n  } catch (error) {\n    console.error('获取代理商列表失败:', error);\n  }\n};\n\n// 获取支付类型列表\nconst getPaymentTypeList = async () => {\n  try {\n    const res = await request({\n      url: '/api/v1/admin/product/payment-type-list',\n      method: 'GET'\n    });\n    if (res.status) {\n      paymentTypeList.value = res.data;\n    }\n  } catch (error) {\n    console.error('获取支付类型列表失败:', error);\n  }\n};\n\n// 打开dialog\nconst open = async (row: any) => {\n  // 先获取用户信息\n  await getUserInfo();\n  \n  // 然后获取其他数据\n  await getAgentList();\n  await getPaymentTypeList();\n  \n  if (row.id) {\n    // 编辑模式 - 获取详情\n    try {\n      const res = await request({\n        url: `/api/v1/admin/product/detail/${row.id}`,\n        method: 'GET'\n      });\n      if (res.status) {\n        form.value = { ...res.data };\n      }\n    } catch (error) {\n      console.error('获取详情失败:', error);\n      ElMessage.error('获取详情失败');\n      return;\n    }\n  } else {\n    // 新增模式 - 重置表单\n    const currentAgentId = isAgent.value ? userInfo.value.agent_id : '';\n    \n    form.value = {\n      id: 0,\n      agent_id: currentAgentId,  // 代理商自动填充agent_id\n      product_name: '',\n      payment_type_id: '',\n      product_code: '',\n      status: 1,\n      remark: ''\n    };\n    \n    // 打印调试信息\n    console.log('isAgent:', isAgent.value);\n    console.log('userInfo:', userInfo.value);\n    console.log('agent_id set to:', currentAgentId);\n  }\n  \n  visible.value = true;\n  \n  // 清除验证\n  setTimeout(() => {\n    formRef.value?.clearValidate();\n  }, 100);\n};\n\n// 提交表单\nconst handleSubmit = async () => {\n  // 验证表单\n  const valid = await formRef.value.validate().catch(() => false);\n  if (!valid) {\n    return;\n  }\n\n  try {\n    const url = form.value.id > 0 \n      ? '/api/v1/admin/product/edit' \n      : '/api/v1/admin/product/add';\n    \n    const res = await request({\n      url,\n      method: 'POST',\n      data: form.value\n    });\n\n    if (res.status) {\n      ElMessage.success(res.msg || '操作成功');\n      visible.value = false;\n      emit('refresh');\n    } else {\n      ElMessage.error(res.msg || '操作失败');\n    }\n  } catch (error: any) {\n    console.error('提交失败:', error);\n    ElMessage.error(error.response?.data?.msg || '提交失败');\n  }\n};\n\n// 暴露方法给父组件\ndefineExpose({\n  open\n});\n</script>\n\n<style scoped>\n.form-tip {\n  font-size: 12px;\n  color: #909399;\n  margin-top: 4px;\n}\n</style>\n\n"],"names":["emit","__emit","formRef","ref","visible","form","userInfo","isAgent","computed","_a","agentList","paymentTypeList","rules","baseRules","getUserInfo","res","request","error","getAgentList","getPaymentTypeList","open","row","ElMessage","currentAgentId","handleSubmit","url","_b","__expose","_createBlock","_component_el_dialog","$event","_createVNode","_component_el_form","_component_el_row","_component_el_col","_component_el_form_item","_component_el_select","_cache","_createElementBlock","_Fragment","_renderList","agent","_component_el_option","_hoisted_1","_component_el_input","type","_createElementVNode","_component_el_alert","_component_el_switch","_component_el_button","_unref","Check","Close"],"mappings":"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"}