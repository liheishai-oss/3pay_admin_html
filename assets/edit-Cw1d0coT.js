import{d as ee,r as v,c as C,g as h,w as l,s as U,aH as ae,E as y,aT as le,n as p,e,Q as te,f as V,i as oe,v as re,R as ue,a as _,j as se,F as ne,q as de,H as ie,S as pe,b as k,p as m,a6 as _e,aU as me,aV as ce,l as ye,h as ve,t as L,J as F,at as fe,ao as ge,_ as be}from"./index-BlNhG5G6.js";/* empty css                 *//* empty css               */const Ve={key:0,class:"form-tip"},ke={key:0},we={key:1},xe={key:0,class:"form-tip",style:{"margin-top":"10px"}},Ue={key:0},Ee={key:1},he={key:0,class:"form-tip",style:{"margin-top":"10px"}},Ie={key:0},De={key:1},Pe={key:0,class:"form-tip",style:{"margin-top":"10px"}},Se=ee({__name:"edit",emits:["refresh"],setup(Ae,{expose:G,emit:N}){const R=N,I=v(),f=v(!1),t=v({id:0,agent_id:"",product_id:"",royalty_type:"none",royalty_mode:"normal",royalty_rate:null,allow_remote_order:1,verify_device:0,scan_pay_enabled:1,transaction_limit:null,amount_min:null,amount_max:null,company_name:"",alipay_app_id:"",alipay_pid:"",custom_product_title:"",app_private_key:"",app_cert_public_key:"",app_cert_public_key_path:"",alipay_cert_public_key:"",alipay_cert_public_key_path:"",alipay_root_cert:"",alipay_root_cert_path:"",status:1}),g=v({}),b=C(()=>{var o;return((o=g.value)==null?void 0:o.is_agent)===!0}),$=v([]),z=v([]),D=C(()=>"https://www.amdmdh.com/api/v1/admin/upload/cert"),P=v({Authorization:`Bearer ${localStorage.getItem("token")||""}`}),H=C(()=>{const o={royalty_type:[{required:!0,message:"请选择分账方式",trigger:"change"}],company_name:[{required:!0,message:"请输入企业名称",trigger:"blur"}],alipay_app_id:[{required:!0,message:"请输入支付宝APPID",trigger:"blur"},{pattern:/^\d{16}$/,message:"APPID格式不正确，应为16位数字",trigger:"blur"}],alipay_pid:[{required:!0,message:"请输入支付宝合作伙伴ID",trigger:"blur"},{pattern:/^\d{16}$/,message:"PID格式不正确，应为16位数字",trigger:"blur"}]};return b.value||(o.agent_id=[{required:!0,message:"请选择代理商",trigger:"change"}]),(t.value.royalty_type==="single"||t.value.royalty_type==="merchant")&&(o.royalty_mode=[{required:!0,message:"请选择分账模式",trigger:"change"}],o.royalty_rate=[{required:!0,message:"请输入分账比例",trigger:"blur"},{type:"number",message:"分账比例必须是数字",trigger:"blur"},{validator:(a,n,d)=>{n!=null&&n!==""&&(n<0||n>100)?d(new Error("分账比例必须在0-100之间")):d()},trigger:"blur"}]),o}),O=async()=>{try{const o=await U({url:"/api/v1/admin/user/info",method:"GET"});o.status&&(g.value=o.data)}catch(o){console.error("获取用户信息失败:",o)}},J=async()=>{if(!b.value)try{const o=await U({url:"/api/v1/admin/subject/agent-list",method:"GET"});o.status&&($.value=o.data)}catch(o){console.error("获取代理商列表失败:",o)}},S=async o=>{try{const a={};o&&(a.agent_id=o);const n=await U({url:"/api/v1/admin/subject/product-list",method:"GET",params:a});n.status&&(z.value=n.data)}catch(a){console.error("获取产品列表失败:",a)}},Q=async o=>{o?(await S(o),t.value.id===0&&(t.value.product_id="")):(z.value=[],t.value.product_id="")},K=async o=>{var a,n,d,s;if(await O(),await J(),b.value&&g.value.agent_id?await S(g.value.agent_id):o.agent_id&&await S(o.agent_id),o.id)try{const u=await U({url:`/api/v1/admin/subject/detail/${o.id}`,method:"GET"});u.status&&(console.log("编辑数据加载:",u.data),t.value={...u.data},console.log("表单数据设置后:",t.value))}catch(u){console.error("获取详情失败:",u);const i=((n=(a=u.response)==null?void 0:a.data)==null?void 0:n.message)||((s=(d=u.response)==null?void 0:d.data)==null?void 0:s.msg)||u.message||"获取详情失败";i.includes("主体不存在")||i.includes("请刷新列表")?ae.alert(i,"提示",{confirmButtonText:"刷新列表",type:"warning",callback:()=>{f.value=!1,R("refresh")}}):y.error(i);return}else{const u=b.value?g.value.agent_id:"";t.value={id:0,agent_id:u,product_id:"",royalty_type:"none",royalty_mode:"normal",royalty_rate:null,allow_remote_order:1,verify_device:0,scan_pay_enabled:1,transaction_limit:null,amount_min:null,amount_max:null,company_name:"",alipay_app_id:"",alipay_pid:"",custom_product_title:"",app_private_key:"",app_cert_public_key:"",app_cert_public_key_path:"",alipay_cert_public_key:"",alipay_cert_public_key_path:"",alipay_root_cert:"",alipay_root_cert_path:"",status:1},console.log("Subject - isAgent:",b.value),console.log("Subject - userInfo:",g.value),console.log("Subject - agent_id set to:",u)}f.value=!0,setTimeout(()=>{var u;(u=I.value)==null||u.clearValidate()},100)},W=async()=>{var a,n;if(await I.value.validate().catch(()=>!1))try{const d=t.value.id>0?"/api/v1/admin/subject/edit":"/api/v1/admin/subject/add",s=await U({url:d,method:"POST",data:t.value});s.status?(y.success(s.msg||"操作成功"),f.value=!1,R("refresh")):y.error(s.msg||"操作失败")}catch(d){console.error("提交失败:",d),y.error(((n=(a=d.response)==null?void 0:a.data)==null?void 0:n.msg)||"提交失败")}},A=o=>{const a=o.size/1024/1024<2;return a||y.error("文件大小不能超过 2MB!"),a},M=(o,a,n)=>{console.log("上传响应:",o),o.status?(t.value[n]=o.data.content,t.value[`${n}_path`]=o.data.path,y.success("上传成功")):(console.error("上传失败响应:",o),y.error(o.message||o.msg||"上传失败"))},T=o=>{var n,d,s,u;console.error("上传失败详情:",o);const a=((d=(n=o.response)==null?void 0:n.data)==null?void 0:d.message)||((u=(s=o.response)==null?void 0:s.data)==null?void 0:u.msg)||o.message||"上传失败，请重试";y.error(a)},j=o=>o&&o.split("/").pop()||"";return G({open:K}),(o,a)=>{const n=ie,d=se,s=ue,u=re,i=oe,c=pe,E=_e,X=me,w=ye,B=ce,q=ve,Y=te,Z=le;return p(),h(Z,{modelValue:f.value,"onUpdate:modelValue":a[17]||(a[17]=r=>f.value=r),title:t.value.id===0?"新增主体":"编辑主体",direction:"rtl",size:"60%","close-on-click-modal":!1},{default:l(()=>[e(Y,{model:t.value,"label-width":"140px",rules:H.value,ref_key:"formRef",ref:I},{default:l(()=>[b.value?V("",!0):(p(),h(i,{key:0,gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"代理商",prop:"agent_id"},{default:l(()=>[e(d,{modelValue:t.value.agent_id,"onUpdate:modelValue":a[0]||(a[0]=r=>t.value.agent_id=r),placeholder:"请选择代理商",clearable:"",filterable:"",disabled:t.value.id>0,onChange:Q},{default:l(()=>[(p(!0),_(ne,null,de($.value,r=>(p(),h(n,{key:r.id,label:r.agent_name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),t.value.id>0?(p(),_("div",Ve,"代理商创建后不可修改")):V("",!0)]),_:1})]),_:1})]),_:1})),e(i,{gutter:20},{default:l(()=>[e(u,{span:12},{default:l(()=>[e(s,{label:"企业名称",prop:"company_name"},{default:l(()=>[e(c,{modelValue:t.value.company_name,"onUpdate:modelValue":a[1]||(a[1]=r=>t.value.company_name=r),placeholder:"请输入企业名称",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"分账方式",prop:"royalty_type"},{default:l(()=>[e(d,{modelValue:t.value.royalty_type,"onUpdate:modelValue":a[2]||(a[2]=r=>t.value.royalty_type=r),placeholder:"请选择分账方式"},{default:l(()=>[e(n,{label:"不分账",value:"none"}),e(n,{label:"单笔",value:"single"}),e(n,{label:"商家（暂不支持）",value:"merchant",disabled:!0})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t.value.royalty_type==="single"||t.value.royalty_type==="merchant"?(p(),h(i,{key:1,gutter:20},{default:l(()=>[e(u,{span:12},{default:l(()=>[e(s,{label:"分账模式",prop:"royalty_mode"},{default:l(()=>[e(d,{modelValue:t.value.royalty_mode,"onUpdate:modelValue":a[3]||(a[3]=r=>t.value.royalty_mode=r),placeholder:"请选择分账模式"},{default:l(()=>[e(n,{label:"普通",value:"normal"}),e(n,{label:"主子（暂不支持）",value:"master_sub",disabled:!0})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(u,{span:12},{default:l(()=>[e(s,{label:"分账比例",prop:"royalty_rate"},{default:l(()=>[e(c,{modelValue:t.value.royalty_rate,"onUpdate:modelValue":a[4]||(a[4]=r=>t.value.royalty_rate=r),modelModifiers:{number:!0},placeholder:"请输入分账比例",clearable:""},{append:l(()=>[...a[18]||(a[18]=[m("%",-1)])]),_:1},8,["modelValue"]),a[19]||(a[19]=k("div",{class:"form-tip"},"输入数字，如：10.5 表示 10.5%",-1))]),_:1})]),_:1})]),_:1})):V("",!0),e(i,{gutter:20},{default:l(()=>[e(u,{span:8},{default:l(()=>[e(s,{label:"异地拉单",prop:"allow_remote_order"},{default:l(()=>[e(E,{modelValue:t.value.allow_remote_order,"onUpdate:modelValue":a[5]||(a[5]=r=>t.value.allow_remote_order=r),"active-value":1,"inactive-value":0,"active-text":"支持","inactive-text":"不支持"},null,8,["modelValue"])]),_:1})]),_:1}),e(u,{span:8},{default:l(()=>[e(s,{label:"验证设备",prop:"verify_device"},{default:l(()=>[e(E,{modelValue:t.value.verify_device,"onUpdate:modelValue":a[6]||(a[6]=r=>t.value.verify_device=r),"active-value":1,"inactive-value":0,"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1})]),_:1}),e(u,{span:8},{default:l(()=>[e(s,{label:"扫码支付",prop:"scan_pay_enabled"},{default:l(()=>[e(E,{modelValue:t.value.scan_pay_enabled,"onUpdate:modelValue":a[7]||(a[7]=r=>t.value.scan_pay_enabled=r),"active-value":1,"inactive-value":0,"active-text":"开启","inactive-text":"关闭"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:8},{default:l(()=>[e(s,{label:"交易笔数限制",prop:"transaction_limit"},{default:l(()=>[e(c,{modelValue:t.value.transaction_limit,"onUpdate:modelValue":a[8]||(a[8]=r=>t.value.transaction_limit=r),modelModifiers:{number:!0},placeholder:"请输入每日交易笔数限制",clearable:"",type:"number"},{append:l(()=>[...a[20]||(a[20]=[m("笔/天",-1)])]),_:1},8,["modelValue"]),a[21]||(a[21]=k("div",{class:"form-tip"},"留空表示不限制",-1))]),_:1})]),_:1}),e(u,{span:8},{default:l(()=>[e(s,{label:"最小交易金额",prop:"amount_min"},{default:l(()=>[e(c,{modelValue:t.value.amount_min,"onUpdate:modelValue":a[9]||(a[9]=r=>t.value.amount_min=r),modelModifiers:{number:!0},placeholder:"请输入单笔最小金额",clearable:"",type:"number"},{append:l(()=>[...a[22]||(a[22]=[m("元",-1)])]),_:1},8,["modelValue"]),a[23]||(a[23]=k("div",{class:"form-tip"},"留空表示不限制",-1))]),_:1})]),_:1}),e(u,{span:8},{default:l(()=>[e(s,{label:"最大交易金额",prop:"amount_max"},{default:l(()=>[e(c,{modelValue:t.value.amount_max,"onUpdate:modelValue":a[10]||(a[10]=r=>t.value.amount_max=r),modelModifiers:{number:!0},placeholder:"请输入单笔最大金额",clearable:"",type:"number"},{append:l(()=>[...a[24]||(a[24]=[m("元",-1)])]),_:1},8,["modelValue"]),a[25]||(a[25]=k("div",{class:"form-tip"},"留空表示不限制",-1))]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:12},{default:l(()=>[e(s,{label:"支付宝APPID",prop:"alipay_app_id"},{default:l(()=>[e(c,{modelValue:t.value.alipay_app_id,"onUpdate:modelValue":a[11]||(a[11]=r=>t.value.alipay_app_id=r),placeholder:"请输入支付宝应用APPID",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),e(u,{span:12},{default:l(()=>[e(s,{label:"合作伙伴ID(PID)",prop:"alipay_pid"},{default:l(()=>[e(c,{modelValue:t.value.alipay_pid,"onUpdate:modelValue":a[12]||(a[12]=r=>t.value.alipay_pid=r),placeholder:"请输入支付宝合作伙伴ID",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"自定义商品标题",prop:"custom_product_title"},{default:l(()=>[e(c,{modelValue:t.value.custom_product_title,"onUpdate:modelValue":a[13]||(a[13]=r=>t.value.custom_product_title=r),placeholder:"请输入自定义商品标题，用于支付页面显示",clearable:"",maxlength:"50","show-word-limit":""},null,8,["modelValue"]),a[26]||(a[26]=k("div",{class:"form-tip"},"支付页面显示的商品标题，留空则使用系统设定的商品名称",-1))]),_:1})]),_:1})]),_:1}),e(X,{"content-position":"left"},{default:l(()=>[...a[27]||(a[27]=[m("证书配置（仅支持证书模式）",-1)])]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"应用私钥",prop:"app_private_key"},{default:l(()=>[e(c,{modelValue:t.value.app_private_key,"onUpdate:modelValue":a[14]||(a[14]=r=>t.value.app_private_key=r),type:"textarea",rows:8,placeholder:"请输入应用私钥（RSA私钥）"},null,8,["modelValue"]),a[28]||(a[28]=k("div",{class:"form-tip"},"请输入完整的应用私钥内容",-1))]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"应用公钥证书",prop:"app_public_cert"},{default:l(()=>[e(B,{class:"upload-cert",action:D.value,headers:P.value,"before-upload":A,"on-success":(r,x)=>M(r,x,"app_cert_public_key"),"on-error":T,"show-file-list":!1,accept:".pem,.crt,.txt"},{default:l(()=>[e(w,{type:"primary",size:"small"},{default:l(()=>[t.value.app_cert_public_key_path?(p(),_("span",we,"重新上传")):(p(),_("span",ke,"上传应用公钥证书"))]),_:1})]),_:1},8,["action","headers","on-success"]),t.value.app_cert_public_key_path?(p(),_("div",xe,[e(q,{type:"success"},{default:l(()=>[m("✓ 已上传: "+L(j(t.value.app_cert_public_key_path)),1)]),_:1})])):V("",!0)]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"支付宝公钥证书",prop:"alipay_public_cert"},{default:l(()=>[e(B,{class:"upload-cert",action:D.value,headers:P.value,"before-upload":A,"on-success":(r,x)=>M(r,x,"alipay_cert_public_key"),"on-error":T,"show-file-list":!1,accept:".pem,.crt,.txt"},{default:l(()=>[e(w,{type:"primary",size:"small"},{default:l(()=>[t.value.alipay_cert_public_key_path?(p(),_("span",Ee,"重新上传")):(p(),_("span",Ue,"上传支付宝公钥证书"))]),_:1})]),_:1},8,["action","headers","on-success"]),t.value.alipay_cert_public_key_path?(p(),_("div",he,[e(q,{type:"success"},{default:l(()=>[m("✓ 已上传: "+L(j(t.value.alipay_cert_public_key_path)),1)]),_:1})])):V("",!0)]),_:1})]),_:1})]),_:1}),e(i,{gutter:20},{default:l(()=>[e(u,{span:24},{default:l(()=>[e(s,{label:"支付宝根证书",prop:"alipay_root_cert"},{default:l(()=>[e(B,{class:"upload-cert",action:D.value,headers:P.value,"before-upload":A,"on-success":(r,x)=>M(r,x,"alipay_root_cert"),"on-error":T,"show-file-list":!1,accept:".pem,.crt,.txt"},{default:l(()=>[e(w,{type:"primary",size:"small"},{default:l(()=>[t.value.alipay_root_cert_path?(p(),_("span",De,"重新上传")):(p(),_("span",Ie,"上传支付宝根证书"))]),_:1})]),_:1},8,["action","headers","on-success"]),t.value.alipay_root_cert_path?(p(),_("div",Pe,[e(q,{type:"success"},{default:l(()=>[m("✓ 已上传: "+L(j(t.value.alipay_root_cert_path)),1)]),_:1})])):V("",!0)]),_:1})]),_:1})]),_:1}),e(s,{label:"状态",prop:"status"},{default:l(()=>[e(E,{modelValue:t.value.status,"onUpdate:modelValue":a[15]||(a[15]=r=>t.value.status=r),"active-value":1,"inactive-value":0},null,8,["modelValue"])]),_:1}),e(s,null,{default:l(()=>[e(w,{type:"primary",onClick:W,icon:F(fe)},{default:l(()=>[...a[29]||(a[29]=[m("提交",-1)])]),_:1},8,["icon"]),e(w,{onClick:a[16]||(a[16]=r=>f.value=!1),icon:F(ge)},{default:l(()=>[...a[30]||(a[30]=[m("取消",-1)])]),_:1},8,["icon"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])}}}),Be=be(Se,[["__scopeId","data-v-b142cd9f"]]);export{Be as default};
//# sourceMappingURL=edit-Cw1d0coT.js.map
