{"version":3,"file":"edit-xIEkOeew.js","sources":["../../src/pages/merchant/edit.vue"],"sourcesContent":["<template>\n  <el-dialog \n    v-model=\"visible\" \n    :title=\"form.id === 0 ? '新增商户' : '编辑商户'\" \n    width=\"700px\"\n    :close-on-click-modal=\"false\"\n  >\n    <el-form :model=\"form\" label-width=\"140px\" :rules=\"rules\" ref=\"formRef\">\n      <!-- 代理商选择（仅管理员） -->\n      <el-row :gutter=\"20\" v-if=\"!isAgent\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"代理商\" prop=\"agent_id\">\n            <el-select \n              v-model=\"form.agent_id\" \n              placeholder=\"请选择代理商\" \n              clearable\n              filterable\n              :disabled=\"form.id > 0\"\n            >\n              <el-option\n                v-for=\"agent in agentList\"\n                :key=\"agent.id\"\n                :label=\"agent.agent_name\"\n                :value=\"agent.id\"\n              />\n            </el-select>\n            <div class=\"form-tip\" v-if=\"form.id > 0\">代理商创建后不可修改</div>\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"商户名称\" prop=\"merchant_name\">\n            <el-input \n              v-model=\"form.merchant_name\" \n              placeholder=\"请输入商户名称\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"联系邮箱\" prop=\"contact_email\">\n            <el-input \n              v-model=\"form.contact_email\" \n              placeholder=\"请输入联系邮箱\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"回调通知地址\" prop=\"notify_url\">\n            <el-input \n              v-model=\"form.notify_url\" \n              placeholder=\"请输入回调通知地址\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"同步返回地址\" prop=\"return_url\">\n            <el-input \n              v-model=\"form.return_url\" \n              placeholder=\"请输入同步返回地址\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"IP白名单\" prop=\"ip_whitelist\">\n            <el-input \n              v-model=\"form.ip_whitelist\" \n              type=\"textarea\"\n              :rows=\"3\"\n              placeholder=\"多个IP用逗号分隔，例如：192.168.1.1,192.168.1.2\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"备注\" prop=\"remark\">\n            <el-input \n              v-model=\"form.remark\" \n              type=\"textarea\"\n              :rows=\"3\"\n              placeholder=\"请输入备注信息\" \n              clearable\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-row :gutter=\"20\">\n        <el-col :span=\"24\">\n          <el-form-item label=\"状态\" prop=\"status\">\n            <el-switch \n              v-model=\"form.status\" \n              :active-value=\"1\" \n              :inactive-value=\"0\"\n              active-text=\"启用\"\n              inactive-text=\"禁用\"\n            />\n          </el-form-item>\n        </el-col>\n      </el-row>\n\n      <el-alert\n        v-if=\"form.id === 0\"\n        title=\"商户创建成功后将自动生成API密钥，请妥善保管\"\n        type=\"warning\"\n        :closable=\"false\"\n        style=\"margin-bottom: 20px\"\n      />\n    </el-form>\n\n    <template #footer>\n      <span class=\"dialog-footer\">\n        <el-button @click=\"visible = false\">取消</el-button>\n        <el-button type=\"primary\" @click=\"handleSubmit\">确定</el-button>\n      </span>\n    </template>\n  </el-dialog>\n</template>\n\n<script lang=\"ts\" setup>\nimport { ref, computed } from 'vue';\nimport { ElMessage, ElMessageBox } from 'element-plus';\nimport request from '@/utils/request';\n\n// 定义emit\nconst emit = defineEmits(['refresh']);\n\n// 表单ref\nconst formRef = ref();\n\n// 控制dialog显示\nconst visible = ref(false);\n\n// 表单数据\nconst form = ref({\n  id: 0,\n  agent_id: '',\n  merchant_name: '',\n  contact_email: '',\n  notify_url: '',\n  return_url: '',\n  ip_whitelist: '',\n  status: 1,\n  remark: ''\n});\n\n// 用户信息\nconst userInfo = ref<any>({});\nconst isAgent = computed(() => userInfo.value?.is_agent === true);\n\n// 代理商列表\nconst agentList = ref([]);\n\n// 验证规则（动态）\nconst rules = computed(() => {\n  const baseRules: any = {\n    merchant_name: [\n      { required: true, message: '请输入商户名称', trigger: 'blur' }\n    ],\n    contact_email: [\n      { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }\n    ]\n  };\n  \n  // 只有管理员需要验证agent_id\n  if (!isAgent.value) {\n    baseRules.agent_id = [\n      { required: true, message: '请选择代理商', trigger: 'change' }\n    ];\n  }\n  \n  return baseRules;\n});\n\n// 获取用户信息\nconst getUserInfo = async () => {\n  try {\n    const res = await request({\n      url: '/api/v1/admin/user/info',\n      method: 'GET'\n    });\n    if (res.status) {\n      userInfo.value = res.data;\n    }\n  } catch (error) {\n    console.error('获取用户信息失败:', error);\n  }\n};\n\n// 获取代理商列表\nconst getAgentList = async () => {\n  if (isAgent.value) return;\n  \n  try {\n    const res = await request({\n      url: '/api/v1/admin/merchant/agent-list',\n      method: 'GET'\n    });\n    if (res.status) {\n      agentList.value = res.data;\n    }\n  } catch (error) {\n    console.error('获取代理商列表失败:', error);\n  }\n};\n\n// 打开dialog\nconst open = async (row: any) => {\n  // 先获取用户信息\n  await getUserInfo();\n  \n  // 然后获取其他数据\n  await getAgentList();\n  \n  if (row.id) {\n    // 编辑模式 - 获取详情\n    try {\n      const res = await request({\n        url: `/api/v1/admin/merchant/detail/${row.id}`,\n        method: 'GET'\n      });\n      if (res.status) {\n        form.value = { ...res.data };\n      }\n    } catch (error) {\n      console.error('获取详情失败:', error);\n      ElMessage.error('获取详情失败');\n      return;\n    }\n  } else {\n    // 新增模式 - 重置表单\n    const currentAgentId = isAgent.value ? userInfo.value.agent_id : '';\n    \n    form.value = {\n      id: 0,\n      agent_id: currentAgentId,\n      merchant_name: '',\n      contact_email: '',\n      notify_url: '',\n      return_url: '',\n      ip_whitelist: '',\n      status: 1,\n      remark: ''\n    };\n  }\n  \n  visible.value = true;\n  \n  // 清除验证\n  setTimeout(() => {\n    formRef.value?.clearValidate();\n  }, 100);\n};\n\n// 提交表单\nconst handleSubmit = async () => {\n  try {\n    await formRef.value.validate();\n    \n    const url = form.value.id \n      ? '/api/v1/admin/merchant/edit' \n      : '/api/v1/admin/merchant/add';\n    \n    const res = await request({\n      url,\n      method: 'POST',\n      data: form.value\n    });\n    \n    if (res.status) {\n      // 如果是新增且返回了密钥信息，显示密钥弹窗\n      if (!form.value.id && res.data && res.data.api_key) {\n        await ElMessageBox.alert(\n          `<div style=\"word-break: break-all;\">\n            <p><strong>API Key:</strong><br/>${res.data.api_key}</p>\n            <p style=\"margin-top: 10px;\"><strong>API Secret:</strong><br/>${res.data.api_secret}</p>\n            <p style=\"margin-top: 10px; color: red;\">请妥善保管以上信息，关闭后将无法再次查看！</p>\n          </div>`,\n          '商户创建成功',\n          {\n            dangerouslyUseHTMLString: true,\n            confirmButtonText: '我已复制',\n          }\n        );\n      } else {\n        ElMessage.success(res.msg || '操作成功');\n      }\n      \n      visible.value = false;\n      emit('refresh');\n    } else {\n      ElMessage.error(res.msg || '操作失败');\n    }\n  } catch (error) {\n    console.error('提交失败:', error);\n    if (error !== false) { // 验证失败时返回false\n      ElMessage.error('提交失败');\n    }\n  }\n};\n\ndefineExpose({\n  open\n});\n</script>\n\n<style scoped>\n.form-tip {\n  font-size: 12px;\n  color: #909399;\n  margin-top: 4px;\n}\n</style>\n\n"],"names":["emit","__emit","formRef","ref","visible","form","userInfo","isAgent","computed","_a","agentList","rules","baseRules","getUserInfo","res","request","error","getAgentList","open","row","ElMessage","currentAgentId","handleSubmit","url","ElMessageBox","__expose","_createBlock","_component_el_dialog","$event","_createElementVNode","_hoisted_2","_createVNode","_component_el_button","_cache","_component_el_form","_component_el_row","_component_el_col","_component_el_form_item","_component_el_select","_createElementBlock","_Fragment","_renderList","agent","_component_el_option","_hoisted_1","_component_el_input","_component_el_switch","_component_el_alert"],"mappings":"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"}