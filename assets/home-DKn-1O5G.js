import{_ as te,g as f,a8 as ae,ai as be,c as T,o as _,a as e,w as a,e as v,P as ne,z as le,k as ge,u as b,U as oe,i as k,N as se,V as ie,W as re,aG as fe,a7 as ye,n as y,t as ee,a0 as de,s as B,C as u,j as F,F as xe,q as ve,aF as _e,d as Ee,K as Te,Z as X,T as Be,L as Y,M as $e,O as ze,E as Ue,b as Re,y as Ae,ao as Fe,ar as me,ap as De,x as Le,Q as Ne,R as Me,S as qe,aQ as Ge,aR as Qe}from"./index-BtkdBdlp.js";/* empty css                   *//* empty css               *//* empty css                     *//* empty css                 */import{u as Ke}from"./table.plugin-BBruccbN.js";import Oe from"./edit-CkLTLA0U.js";/* empty css                *//* empty css              *//* empty css                 */const We={class:"subject-payment-type-binding"},Ze={class:"card-header"},He={class:"header-info"},Je={class:"search-section"},Xe={__name:"SubjectPaymentTypeBinding",props:{subjectId:{type:[Number,String],required:!0}},setup(K,{expose:j}){const c=K,m=f(!1),P=f([]),S=f(""),h=ae(()=>{if(!S.value)return P.value;const r=S.value.toLowerCase();return P.value.filter(g=>g.product_name.toLowerCase().includes(r))}),C=async()=>{if(!c.subjectId){console.log("SubjectPaymentTypeBinding: subjectId为空，跳过加载");return}console.log("SubjectPaymentTypeBinding: 开始加载支付类型列表",{subjectId:c.subjectId});try{m.value=!0;const r=await B.get("/api/v1/admin/subject-payment-type/list",{params:{subject_id:c.subjectId}});console.log("SubjectPaymentTypeBinding: API响应",r),r.code===200?(P.value=r.data.payment_types||[],console.log("SubjectPaymentTypeBinding: 加载成功",{count:P.value.length})):(console.error("SubjectPaymentTypeBinding: API返回错误",r),u.error(r.message||"加载支付类型列表失败"))}catch(r){console.error("SubjectPaymentTypeBinding: 请求异常",r),u.error("加载支付类型列表失败")}finally{m.value=!1}};be(()=>c.subjectId,r=>{console.log("SubjectPaymentTypeBinding: subjectId变化",{newId:r,oldId:c.subjectId}),r&&r>0&&C()},{immediate:!0});const A=()=>{},M=async r=>{console.log("切换支付类型状态",{paymentTypeId:r.id,productName:r.product_name,currentEnabled:r.is_enabled,subjectId:c.subjectId});try{m.value=!0;const g=await B.post("/api/v1/admin/subject-payment-type/toggle",{subject_id:c.subjectId,payment_type_id:r.id});console.log("切换API响应",g),g.code===200?(console.log("操作成功，重新加载数据"),await C(),u.success(g.message||`${g.data.action}成功`)):(console.error("API返回错误，重新加载数据",g),await C(),u.error(g.message||"操作失败"))}catch(g){console.error("切换支付类型状态失败:",g),await C(),u.error("操作失败")}finally{m.value=!1}};return j({loadSubjectPaymentTypes:C}),(r,g)=>{const q=ye,w=ge,$=le,D=ie,G=re,o=se,l=de,t=fe;return _(),T("div",We,[e(l,{class:"box-card"},{header:a(()=>[v("div",Ze,[g[1]||(g[1]=v("span",null,"支付类型支持管理",-1)),v("div",He,[e(q,{type:"info",size:"small"},{default:a(()=>[y(" 共 "+ee(P.value.length)+" 种支付类型 ",1)]),_:1})])])]),default:a(()=>[v("div",Je,[e($,{modelValue:S.value,"onUpdate:modelValue":g[0]||(g[0]=i=>S.value=i),placeholder:"搜索支付类型名称",clearable:"",onInput:A,style:{width:"300px","margin-bottom":"20px"}},{prefix:a(()=>[e(w,null,{default:a(()=>[e(b(oe))]),_:1})]),_:1},8,["modelValue"])]),ne((_(),k(o,{data:h.value,"empty-text":"暂无支付类型","row-key":"id"},{default:a(()=>[e(D,{prop:"product_name",label:"支付名称","min-width":"200"}),e(D,{label:"支持状态",width:"100",align:"center"},{default:a(({row:i})=>[e(G,{modelValue:i.is_enabled,"onUpdate:modelValue":p=>i.is_enabled=p,disabled:m.value,onChange:p=>M(i)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:1})]),_:1},8,["data"])),[[t,m.value]])]),_:1})])}}},Ye=te(Xe,[["__scopeId","data-v-9a0e8fc3"]]),et={class:"subject-product-binding"},tt={class:"search-section"},at={key:0,class:"batch-actions"},nt={__name:"SubjectProductBinding",props:{subjectId:{type:[Number,String],required:!0}},setup(K,{expose:j}){const c=K,m=f(!1),P=f([]),S=f(""),h=f([]),C=f(!1),A=f(!1),M=ae(()=>{let o=P.value;if(S.value){const l=S.value.toLowerCase();o=o.filter(t=>t.product_name.toLowerCase().includes(l)||t.product_code.toLowerCase().includes(l))}return o}),r=async()=>{var o,l;if(c.subjectId)try{m.value=!0;const t=await B.get("/api/v1/admin/subject-product/list",{params:{subject_id:c.subjectId}});if(t.code===200||t.status===!0){const i=((o=t.data)==null?void 0:o.bound_products)||[],p=((l=t.data)==null?void 0:l.available_products)||[],I=new Set(i.map(x=>x.id)),z=[];i.forEach(x=>{z.push({...x,is_bound:!0})}),p.forEach(x=>{I.has(x.id)||z.push({...x,is_bound:!1,is_enabled:0})}),P.value=z}else u.error(t.msg||t.message||"加载产品列表失败")}catch(t){console.error("加载产品列表失败:",t),u.error("加载产品列表失败")}finally{m.value=!1}};be(()=>c.subjectId,o=>{o&&r()},{immediate:!0});const g=()=>{},q=o=>{h.value=o},w=async o=>{if(o.is_bound&&o.is_enabled===1){if(o.is_bound)try{await _e.confirm("确定要关闭该产品的支持状态吗？","确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),m.value=!0;const t=await B.post("/api/v1/admin/subject-product/unbind",{subject_id:c.subjectId,product_id:o.id});t.code===200||t.status?(await r(),u.success(t.msg||t.message||"已关闭支持状态")):u.error(t.msg||t.message||"操作失败")}catch(t){t!=="cancel"&&(console.error("关闭支持状态失败:",t),u.error("操作失败"))}finally{m.value=!1}}else try{if(m.value=!0,o.is_bound)o.is_enabled!==1&&await $(o);else{const t=await B.post("/api/v1/admin/subject-product/batch-bind",{subject_id:c.subjectId,product_ids:[o.id]});if(t.code!==200&&!t.status){u.error(t.msg||t.message||"绑定失败");return}await r();const i=P.value.find(p=>p.id===o.id);i&&i.is_bound&&(i.is_enabled!==1?await $(i):u.success(t.msg||t.message||"已启用支持状态"))}}catch(t){console.error("启用支持状态失败:",t),u.error("操作失败")}finally{m.value=!1}},$=async o=>{var l;console.log("切换产品状态",{productId:o.id,productName:o.product_name,currentEnabled:o.is_enabled,subjectId:c.subjectId});try{m.value=!0;const t=await B.post("/api/v1/admin/subject-product/toggle",{subject_id:c.subjectId,product_id:o.id});console.log("切换API响应",t),t.code===200||t.status===!0?(console.log("操作成功，重新加载数据"),await r(),u.success(t.msg||t.message||`${((l=t.data)==null?void 0:l.action)||"操作"}成功`)):(console.error("API返回错误，重新加载数据",t),await r(),u.error(t.msg||t.message||"操作失败"))}catch(t){console.error("切换产品状态失败:",t),await r(),u.error("操作失败")}finally{m.value=!1}},D=async()=>{const o=h.value.filter(l=>!l.is_bound);if(o.length===0){u.warning("请选择未绑定的产品进行绑定");return}try{C.value=!0;const l=o.map(i=>i.id),t=await B.post("/api/v1/admin/subject-product/batch-bind",{subject_id:c.subjectId,product_ids:l});t.code===200||t.status?(u.success(t.msg||t.message||"批量绑定成功"),h.value=[],await r()):u.error(t.msg||t.message||"批量绑定失败")}catch(l){console.error("批量绑定失败:",l),u.error("批量绑定失败")}finally{C.value=!1}},G=async()=>{const o=h.value.filter(l=>l.is_bound);if(o.length===0){u.warning("请选择已绑定的产品进行解绑");return}try{await _e.confirm(`确定要解绑 ${o.length} 个产品吗？`,"确认解绑",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),A.value=!0;const l=[];for(const p of o)try{const I=await B.post("/api/v1/admin/subject-product/unbind",{subject_id:c.subjectId,product_id:p.id});I.code===200||I.status?l.push({success:!0,product:p.product_name}):l.push({success:!1,product:p.product_name,error:I.msg||I.message})}catch{l.push({success:!1,product:p.product_name,error:"解绑失败"})}const t=l.filter(p=>p.success).length,i=l.filter(p=>!p.success).length;i===0?u.success(`成功解绑 ${t} 个产品`):u.warning(`成功解绑 ${t} 个产品，失败 ${i} 个`),h.value=[],await r()}catch(l){l!=="cancel"&&(console.error("批量解绑失败:",l),u.error("批量解绑失败"))}finally{A.value=!1}};return j({loadSubjectProducts:r}),(o,l)=>{const t=ge,i=le,p=ie,I=re,z=se,x=xe,O=ve,H=de,J=fe;return _(),T("div",et,[e(H,{class:"box-card"},{header:a(()=>[...l[1]||(l[1]=[v("div",{class:"card-header"},[v("span",null,"产品绑定管理")],-1)])]),default:a(()=>[v("div",tt,[e(i,{modelValue:S.value,"onUpdate:modelValue":l[0]||(l[0]=E=>S.value=E),placeholder:"搜索产品名称或代码",clearable:"",onInput:g,style:{width:"300px","margin-bottom":"20px"}},{prefix:a(()=>[e(t,null,{default:a(()=>[e(b(oe))]),_:1})]),_:1},8,["modelValue"])]),ne((_(),k(z,{data:M.value,onSelectionChange:q,"empty-text":"暂无产品"},{default:a(()=>[e(p,{type:"selection",width:"55"}),e(p,{prop:"product_code",label:"产品代码",width:"120"}),e(p,{prop:"product_name",label:"产品名称"}),e(p,{label:"支持状态",width:"120",align:"center"},{default:a(({row:E})=>[e(I,{"model-value":E.is_bound&&E.is_enabled===1,disabled:m.value||E.status!==1,onChange:ce=>w(E),size:"small"},null,8,["model-value","disabled","onChange"])]),_:1})]),_:1},8,["data"])),[[J,m.value]]),h.value.length>0?(_(),T("div",at,[e(x,{title:`已选择 ${h.value.length} 个产品`,type:"info",closable:!1,style:{margin:"20px 0"}},null,8,["title"]),e(O,{type:"primary",onClick:D,loading:C.value},{default:a(()=>[...l[2]||(l[2]=[y(" 批量绑定 ",-1)])]),_:1},8,["loading"]),h.value.some(E=>E.is_bound)?(_(),k(O,{key:0,type:"danger",onClick:G,loading:A.value},{default:a(()=>[...l[3]||(l[3]=[y(" 批量解绑 ",-1)])]),_:1},8,["loading"])):F("",!0)])):F("",!0)]),_:1})])}}},lt=te(nt,[["__scopeId","data-v-bacf5ccf"]]),ot={class:"table-com-search"},st={class:"table-header ba-scroll-style"},it={class:"table-search"},rt={style:{width:"100%","overflow-x":"auto"},class:"table-content"},dt={key:0,class:"payment-types-tags"},ct={key:1,style:{color:"#909399"}},ut={key:0,style:{color:"#909399"}},pt={class:"table-footer"},_t={class:"table-pagination"},mt={key:0,class:"binding-management-section"},bt={class:"binding-header"},gt={class:"binding-title"},ft=Ee({__name:"home",setup(K){const j=f(null),c=f(null),m=f("payment"),P=f(null),S=f(null),h=(d={})=>{console.log(d),X(()=>{j.value&&j.value.open?j.value.open({...d}):(console.error("EditForm 组件未正确挂载！",j.value),setTimeout(()=>{j.value&&j.value.open?j.value.open({...d}):console.error("EditForm 组件重试后仍然未正确挂载！")},100))})},C=d=>{c.value=d,m.value="payment",X(()=>{const n=document.querySelector(".binding-management-section");n&&n.scrollIntoView({behavior:"smooth",block:"start"})})},{handleSelectionChange:A,hasSelectedRows:M,isVisible:r,toggleVisibility:g,loadData:q,data:w,refreshData:$,handleSizeChange:D,handleCurrentChange:G,searchParams:o,deleteRows:l,toggleSwitch:t}=Ke("/api/v1/admin/subject/list"),i=f({agent_id:"",company_name:"",alipay_app_id:"",status:""}),p=f([]),I=f({}),z=ae(()=>{var d;return((d=I.value)==null?void 0:d.is_agent)===!0}),x=async()=>{try{const d=await B({url:"/api/v1/admin/user/info",method:"GET"});d.status&&(I.value=d.data)}catch(d){console.error("获取用户信息失败:",d)}},O=async()=>{if(!z.value)try{const d=await B({url:"/api/v1/admin/subject/agent-list",method:"GET"});d.status&&(p.value=d.data)}catch(d){console.error("获取代理商列表失败:",d)}},H=async()=>{o.value={...i.value},await $()},J=()=>{i.value={agent_id:"",company_name:"",alipay_app_id:"",status:""},o.value={...i.value},$()};Te(async()=>{await x(),await O(),await q(),X(()=>{w.value.data&&w.value.data.length>0&&C(w.value.data[0])})});const E=(d,n)=>{l(d,[n.id])},ce=d=>{l(d)},he=d=>{const n={支付宝:"success",微信支付:"primary",银联支付:"warning",QQ钱包:"info",京东支付:"danger"};for(const[L,W]of Object.entries(n))if(d.includes(L))return W;return"info"};return(d,n)=>{const L=De,W=Fe,Q=Ae,Z=Re,ue=le,we=Ue,U=ve,je=Le,Ce=$e,V=ie,N=ye,Ie=re,ke=se,Pe=ze,pe=Qe,Se=Ge,Ve=de;return _(),T(Y,null,[e(Oe,{ref_key:"editFormRef",ref:j,onRefresh:b($)},null,8,["onRefresh"]),e(Be,{name:"fade"},{default:a(()=>[ne(v("div",ot,[e(we,{gutter:20},{default:a(()=>[z.value?F("",!0):(_(),k(Z,{key:0,span:6},{default:a(()=>[e(Q,{label:"代理商"},{default:a(()=>[e(W,{modelValue:i.value.agent_id,"onUpdate:modelValue":n[0]||(n[0]=s=>i.value.agent_id=s),placeholder:"选择代理商",clearable:"",filterable:""},{default:a(()=>[(_(!0),T(Y,null,me(p.value,s=>(_(),k(L,{key:s.id,label:s.agent_name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})),e(Z,{span:6},{default:a(()=>[e(Q,{label:"企业名称"},{default:a(()=>[e(ue,{modelValue:i.value.company_name,"onUpdate:modelValue":n[1]||(n[1]=s=>i.value.company_name=s),placeholder:"按企业名称搜索",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),e(Z,{span:6},{default:a(()=>[e(Q,{label:"APPID"},{default:a(()=>[e(ue,{modelValue:i.value.alipay_app_id,"onUpdate:modelValue":n[2]||(n[2]=s=>i.value.alipay_app_id=s),placeholder:"按APPID搜索",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),e(Z,{span:6},{default:a(()=>[e(Q,{label:"状态"},{default:a(()=>[e(W,{modelValue:i.value.status,"onUpdate:modelValue":n[3]||(n[3]=s=>i.value.status=s),placeholder:"选择状态",clearable:""},{default:a(()=>[e(L,{label:"全部",value:""}),e(L,{label:"启用",value:1}),e(L,{label:"禁用",value:0})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(je,{inline:!0,class:"demo-form-inline"},{default:a(()=>[e(Q,null,{default:a(()=>[e(U,{type:"primary",onClick:H},{default:a(()=>[...n[8]||(n[8]=[y("搜索",-1)])]),_:1}),e(U,{type:"primary",onClick:J},{default:a(()=>[...n[9]||(n[9]=[y("重置",-1)])]),_:1})]),_:1})]),_:1})],512),[[Ne,b(r)]])]),_:1}),v("div",st,[e(U,{icon:b(Me),onClick:b($),color:"#40485b"},null,8,["icon","onClick"]),e(U,{type:"primary",icon:b(qe),onClick:h},{default:a(()=>[...n[10]||(n[10]=[y("添加",-1)])]),_:1},8,["icon"]),e(U,{type:"danger",disabled:!b(M),onClick:n[4]||(n[4]=s=>ce("/api/v1/admin/subject/delete"))},{default:a(()=>[...n[11]||(n[11]=[y("删除",-1)])]),_:1},8,["disabled"]),v("div",it,[e(Ce,{class:"ml-4"},{default:a(()=>[e(U,{icon:b(oe),onClick:b(g)},null,8,["icon","onClick"])]),_:1})])]),v("div",rt,[e(ke,{data:b(w).data,border:"",stripe:"","max-height":"600",style:{width:"100%"},onSelectionChange:b(A)},{default:a(()=>[e(V,{type:"selection",width:"40"}),z.value?F("",!0):(_(),k(V,{key:0,prop:"agent.agent_name",label:"代理商",align:"center","min-width":"150"})),e(V,{label:"支付类型",align:"center","min-width":"200"},{default:a(({row:s})=>[s.payment_types&&s.payment_types.length>0?(_(),T("div",dt,[(_(!0),T(Y,null,me(s.payment_types,R=>(_(),k(N,{key:R.id,type:he(R.product_name),size:"small",class:"payment-type-tag"},{default:a(()=>[y(ee(R.product_name),1)]),_:2},1032,["type"]))),128))])):(_(),T("span",ct,"未设置"))]),_:1}),e(V,{prop:"company_name",label:"企业名称",align:"center","min-width":"200"}),e(V,{label:"分账方式",align:"center","min-width":"120"},{default:a(({row:s})=>[s.royalty_type==="none"?(_(),k(N,{key:0,type:"info"},{default:a(()=>[...n[12]||(n[12]=[y("不分账",-1)])]),_:1})):s.royalty_type==="single"?(_(),k(N,{key:1,type:"success"},{default:a(()=>[...n[13]||(n[13]=[y("单笔",-1)])]),_:1})):s.royalty_type==="merchant"?(_(),k(N,{key:2,type:"warning"},{default:a(()=>[...n[14]||(n[14]=[y("商家",-1)])]),_:1})):F("",!0)]),_:1}),e(V,{label:"分账模式",align:"center","min-width":"120"},{default:a(({row:s})=>[s.royalty_type==="none"?(_(),T("span",ut,"-")):s.royalty_mode==="normal"?(_(),k(N,{key:1,size:"small"},{default:a(()=>[...n[15]||(n[15]=[y("普通",-1)])]),_:1})):s.royalty_mode==="master_sub"?(_(),k(N,{key:2,type:"success",size:"small"},{default:a(()=>[...n[16]||(n[16]=[y("主子",-1)])]),_:1})):F("",!0)]),_:1}),e(V,{prop:"alipay_app_id",label:"支付宝APPID",align:"center","min-width":"180"}),e(V,{prop:"alipay_pid",label:"合作伙伴ID",align:"center","min-width":"150"}),e(V,{label:"状态",align:"center","min-width":"90"},{default:a(({row:s})=>[e(Ie,{modelValue:s.status,"onUpdate:modelValue":R=>s.status=R,"active-value":1,"inactive-value":0,onChange:R=>b(t)("/api/v1/admin/subject/switch",s.id)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),e(V,{prop:"created_at",label:"创建时间",align:"center","min-width":"150"}),e(V,{label:"操作",align:"center",fixed:"right","min-width":"200"},{default:a(s=>[e(U,{size:"small",onClick:R=>h(s.row)},{default:a(()=>[...n[17]||(n[17]=[y("编辑",-1)])]),_:1},8,["onClick"]),e(U,{size:"small",type:"primary",onClick:R=>C(s.row)},{default:a(()=>[...n[18]||(n[18]=[y("查看绑定",-1)])]),_:1},8,["onClick"]),e(U,{size:"small",type:"danger",onClick:R=>E("/api/v1/admin/subject/delete",s.row)},{default:a(()=>[...n[19]||(n[19]=[y("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data","onSelectionChange"])]),v("div",pt,[v("div",_t,[e(Pe,{"current-page":b(w).current_page,"onUpdate:currentPage":n[5]||(n[5]=s=>b(w).current_page=s),"page-size":b(w).page_size,"onUpdate:pageSize":n[6]||(n[6]=s=>b(w).page_size=s),"page-sizes":[10,50,100,200],background:!0,"prev-text":"上一页","next-text":"下一页",layout:"total, sizes, prev, pager, next, jumper",total:b(w).page_total,onSizeChange:b(D),onCurrentChange:b(G)},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),c.value&&c.value.id?(_(),T("div",mt,[e(Ve,{class:"binding-card"},{header:a(()=>[v("div",bt,[v("span",gt,ee(c.value.company_name)+" - 绑定管理",1)])]),default:a(()=>[e(Se,{modelValue:m.value,"onUpdate:modelValue":n[7]||(n[7]=s=>m.value=s),type:"border-card"},{default:a(()=>[e(pe,{label:"支付类型绑定",name:"payment"},{default:a(()=>[e(Ye,{"subject-id":c.value.id,ref_key:"paymentTypeBindingRef",ref:P},null,8,["subject-id"])]),_:1}),e(pe,{label:"产品绑定",name:"product"},{default:a(()=>[e(lt,{"subject-id":c.value.id,ref_key:"productBindingRef",ref:S},null,8,["subject-id"])]),_:1})]),_:1},8,["modelValue"])]),_:1})])):F("",!0)],64)}}}),Vt=te(ft,[["__scopeId","data-v-141aafa9"]]);export{Vt as default};
//# sourceMappingURL=home-DKn-1O5G.js.map
