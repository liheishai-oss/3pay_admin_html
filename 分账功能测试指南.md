# 分账功能测试指南

## 一、测试前准备

### 1.1 数据库检查
- [x] `order_royalty` 表已创建
- [ ] 表结构和索引正确
- [ ] `single_royalty` 表中有测试数据（单笔分账需要）
- [ ] 测试订单数据已准备

### 1.2 配置检查
- [ ] 支付宝应用已配置并测试可用
- [ ] 支付宝分账接口权限已开通（需要联系支付宝开通）
- [ ] 主体配置中已设置分账方式（`royalty_type`）和分账比例（`royalty_rate`）
- [ ] 单笔分账收款账号已配置（如果使用单笔分账）

### 1.3 测试订单准备
- [ ] 至少有一个已支付且未分账的订单
- [ ] 订单关联的主体配置了分账（`royalty_type != 'none'`）
- [ ] 订单有支付宝交易号（`trade_no` 或 `alipay_order_no`）

---

## 二、功能测试

### 2.1 分账金额计算测试

运行测试脚本：
```bash
cd third_party_payment_api
php test_royalty.php test_royalty_calculation
```

**测试点：**
- [ ] 不同订单金额和分账比例的计算是否正确
- [ ] 分账金额 + 主体金额 = 订单金额（精度检查）
- [ ] 金额不能为负数

### 2.2 防重复分账测试

运行测试脚本：
```bash
php test_royalty.php test_royalty_prevent_duplicate
```

**测试点：**
- [ ] 已有成功分账记录的订单不应再次分账
- [ ] 系统应返回明确的提示信息

### 2.3 分账状态查询测试

运行测试脚本：
```bash
php test_royalty.php test_royalty_query
```

**测试点：**
- [ ] 能正确查询订单的分账状态
- [ ] 返回的分账信息完整准确

### 2.4 分账流程测试（需要真实订单）

运行测试脚本：
```bash
php test_royalty.php test_royalty_process
```

**测试点：**
- [ ] 能找到符合条件的测试订单
- [ ] 分账流程能正常执行
- [ ] 分账记录正确保存到数据库
- [ ] 分账日志正确记录

### 2.5 支付回调触发分账测试

**测试步骤：**
1. 创建一个测试订单并完成支付
2. 模拟支付宝回调（或等待真实回调）
3. 检查订单是否触发分账
4. 检查分账记录是否正确创建

**测试点：**
- [ ] 支付成功后自动触发分账
- [ ] 分账不阻塞回调响应
- [ ] 分账失败不影响订单状态更新

### 2.6 补单触发分账测试

**测试步骤：**
1. 创建一个未支付订单
2. 在支付宝完成支付（但系统未收到回调）
3. 手动执行补单操作
4. 检查是否触发分账

**测试点：**
- [ ] 补单成功后触发分账
- [ ] 分账结果记录在补单返回信息中

### 2.7 自动分账定时任务测试

**测试步骤：**
1. 确保 `OrderAutoRoyalty` 进程已启动
2. 创建已支付但未分账的订单（支付时间超过5分钟）
3. 等待10分钟（定时任务执行周期）
4. 检查订单是否自动分账

**测试点：**
- [ ] 定时任务正常运行
- [ ] 能正确扫描待分账订单
- [ ] 自动分账执行成功

---

## 三、边界情况测试

### 3.1 异常情况测试

**测试场景：**
- [ ] 订单未支付时尝试分账（应返回"订单不需要分账"）
- [ ] 订单主体不存在时尝试分账（应返回"订单主体不存在"）
- [ ] 分账类型为 `none` 时尝试分账（应返回"订单不需要分账"）
- [ ] 缺少支付宝交易号时尝试分账（应抛出异常）
- [ ] 缺少收款人支付宝用户ID时尝试分账（应抛出异常）
- [ ] 单笔分账但未配置收款账号（应抛出异常）

### 3.2 金额边界测试

**测试场景：**
- [ ] 订单金额为 0.01（最小金额）
- [ ] 订单金额为 999999.99（大金额）
- [ ] 分账比例为 0%（不分账）
- [ ] 分账比例为 100%（全部分账，如果允许）
- [ ] 分账金额计算精度（四舍五入）

### 3.3 并发测试

**测试场景：**
- [ ] 同一订单同时触发多次分账（应防止重复分账）
- [ ] 多个订单同时分账（压力测试）

---

## 四、管理界面测试

### 4.1 分账记录列表

**测试步骤：**
1. 访问分账记录列表页面
2. 测试搜索功能（订单号、交易号）
3. 测试筛选功能（分账状态、分账方式）
4. 测试分页功能

**测试点：**
- [ ] 列表数据正确显示
- [ ] 搜索和筛选功能正常
- [ ] 分页功能正常

### 4.2 分账记录详情

**测试步骤：**
1. 点击查看分账记录详情
2. 检查详情信息是否完整

**测试点：**
- [ ] 详情信息完整准确
- [ ] 支付宝返回结果正确显示

### 4.3 分账重试功能

**测试步骤：**
1. 找到一条失败的分账记录
2. 点击重试按钮
3. 检查是否重新执行分账

**测试点：**
- [ ] 只能重试失败的分账记录
- [ ] 重试功能正常工作
- [ ] 重试后更新分账状态

---

## 五、集成测试

### 5.1 完整支付流程测试

**测试步骤：**
1. 创建订单
2. 完成支付
3. 接收支付宝回调
4. 检查订单状态更新
5. 检查是否触发分账
6. 检查分账记录
7. 检查分账日志

**测试点：**
- [ ] 整个流程顺畅无阻塞
- [ ] 各环节日志记录完整
- [ ] 数据一致性正确

### 5.2 补单流程测试

**测试步骤：**
1. 创建订单
2. 在支付宝完成支付（但系统未收到回调）
3. 手动执行补单
4. 检查订单状态更新
5. 检查是否触发分账
6. 检查分账记录

**测试点：**
- [ ] 补单成功后正确触发分账
- [ ] 分账结果记录在补单返回中

---

## 六、性能测试

### 6.1 批量分账测试

**测试步骤：**
1. 创建多个已支付订单
2. 测试批量分账性能

**测试点：**
- [ ] 批量分账响应时间
- [ ] 内存使用情况
- [ ] 数据库连接数

### 6.2 定时任务性能

**测试步骤：**
1. 创建大量待分账订单
2. 观察定时任务执行情况

**测试点：**
- [ ] 定时任务执行时间
- [ ] 批量处理效率
- [ ] 错误处理不影响整体执行

---

## 七、日志和监控

### 7.1 日志检查

**检查点：**
- [ ] 分账开始日志记录完整
- [ ] 分账结果日志记录完整
- [ ] 错误日志记录详细
- [ ] 链路日志（OrderLogService）记录完整

### 7.2 监控指标

**检查点：**
- [ ] 分账成功率统计
- [ ] 分账失败率统计
- [ ] 分账平均处理时间
- [ ] 支付宝接口调用成功率

---

## 八、问题排查

### 8.1 常见问题

1. **分账失败：缺少支付宝交易号**
   - 检查订单是否有 `trade_no` 或 `alipay_order_no`
   - 检查支付回调是否正确更新了交易号

2. **分账失败：缺少收款人支付宝用户ID**
   - 检查单笔分账配置（`single_royalty` 表）
   - 检查商户分账配置（如使用商户分账）

3. **分账失败：支付宝接口权限不足**
   - 联系支付宝开通 `alipay.trade.order.settle` 接口权限
   - 检查支付宝应用配置是否正确

4. **分账记录重复**
   - 检查防重复分账机制是否生效
   - 检查数据库锁是否正确使用

### 8.2 调试方法

1. **查看分账日志**
   ```bash
   tail -f runtime/logs/app.log | grep "分账"
   ```

2. **查看链路日志**
   ```sql
   SELECT * FROM order_log WHERE platform_order_no = '订单号' ORDER BY created_at;
   ```

3. **查看分账记录**
   ```sql
   SELECT * FROM order_royalty WHERE order_id = 订单ID ORDER BY created_at DESC;
   ```

---

## 九、测试报告

测试完成后，请填写以下信息：

- **测试日期：**
- **测试环境：** （开发/测试/生产）
- **测试人员：**
- **测试结果：** （通过/部分通过/不通过）
- **发现问题：**
- **修复建议：**

---

## 十、上线前检查清单

- [ ] 所有功能测试通过
- [ ] 边界情况测试通过
- [ ] 性能测试满足要求
- [ ] 日志和监控已配置
- [ ] 支付宝接口权限已开通
- [ ] 数据库表已创建并验证
- [ ] 代码审查完成
- [ ] 文档已更新



