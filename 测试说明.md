# 商户对接API测试说明

## 测试前准备

### 1. 创建测试数据

在开始测试之前，需要确保系统中已有以下数据：

#### 1.1 创建代理商
1. 登录管理后台
2. 进入「代理商管理」
3. 创建一个测试代理商（如果还没有）

#### 1.2 创建支付产品
1. 进入「产品管理」
2. 为该代理商创建一个测试产品
3. 记录产品编号（4位数字，如：1001）

#### 1.3 创建支付主体
1. 进入「主体管理」
2. 为该代理商创建一个支付主体
3. 选择刚才创建的产品
4. 填写企业信息和支付宝配置

#### 1.4 创建测试商户
1. 进入「商户管理」
2. 点击「添加」按钮
3. 填写商户信息：
   - 选择代理商（如果是管理员）
   - 填写商户名称
   - 填写联系邮箱
   - 填写回调地址（可选）
   - 状态设为「启用」
4. 点击「确定」
5. **重要**：弹出的API密钥信息只显示一次，请务必复制保存：
   - API Key
   - API Secret

### 2. 配置测试脚本

打开 `test_merchant_api.php` 文件，修改配置：

```php
$config = [
    'base_url' => 'http://localhost:8787', // 修改为实际的API地址
    'api_key' => 'YOUR_API_KEY',           // 填入步骤1.4中获取的API Key
    'api_secret' => 'YOUR_API_SECRET',     // 填入步骤1.4中获取的API Secret
];
```

在测试脚本中找到这一行并修改产品编号：

```php
'product_code' => '1001', // 修改为步骤1.2中创建的产品编号
```

## 运行测试

在终端中执行：

```bash
cd /Users/apple/dnmp/www/3pay/third_party_payment_api
php test_merchant_api.php
```

## 测试用例说明

测试脚本会依次执行以下测试：

### 测试1：创建订单
- 使用标准参数创建一个测试订单
- 订单金额：0.01元
- 验证订单创建是否成功
- 检查返回的平台订单号

### 测试2：查询订单（商户订单号）
- 使用商户订单号查询刚创建的订单
- 验证订单信息是否正确

### 测试3：查询订单（平台订单号，GET方式）
- 使用平台订单号查询订单
- 使用GET请求方式
- 验证订单信息是否正确

### 测试4：关闭订单
- 关闭刚创建的订单
- 验证订单状态是否变为已关闭

### 测试5：签名错误处理
- 使用错误的签名创建订单
- 验证系统是否正确拒绝请求
- 应该返回"签名验证失败"

### 测试6：重复订单号处理
- 使用已存在的商户订单号创建订单
- 验证系统是否正确拒绝请求
- 应该返回"商户订单号已存在"

## 预期结果

成功的测试输出应该类似：

```
╔════════════════════════════════════════╗
║   百亿三方支付 - 商户API测试工具      ║
╚════════════════════════════════════════╝

配置信息:
- 接口地址: http://localhost:8787
- API Key: abc123...
- API Secret: xyz789...


【测试1】创建订单
========================================
✅ 测试通过
平台订单号: BY20250122153045A1B21234


【测试2】查询订单（使用商户订单号）
========================================
✅ 测试通过


【测试3】查询订单（使用平台订单号，GET方式）
========================================
✅ 测试通过


【测试4】关闭订单
========================================
✅ 测试通过


【测试5】验证签名错误处理
========================================
✅ 测试通过
错误信息: 签名验证失败


【测试6】验证重复订单号处理
========================================
✅ 测试通过
错误信息: 商户订单号已存在
```

## 常见问题

### 1. 提示"请先配置 api_key 和 api_secret"
- 请确保在测试脚本中正确填写了API密钥

### 2. 提示"无效的API密钥或商户已被禁用"
- 检查API Key是否正确
- 检查商户状态是否为「启用」
- 检查代理商状态是否为「启用」

### 3. 提示"产品不存在或已禁用"
- 检查product_code是否正确
- 检查产品状态是否为「启用」
- 检查产品是否属于该商户的代理商

### 4. 提示"暂无可用支付主体"
- 检查是否已创建支付主体
- 检查主体状态是否为「启用」
- 检查主体是否关联了正确的产品
- 检查主体是否属于该代理商

### 5. 连接超时
- 检查webman服务是否正常运行
- 检查base_url配置是否正确
- 检查防火墙设置

## 手动测试

如果需要手动测试单个接口，可以使用curl命令：

### 创建订单示例

```bash
# 1. 准备参数
API_KEY="your_api_key"
API_SECRET="your_api_secret"
MERCHANT_ORDER_NO="TEST$(date +%Y%m%d%H%M%S)"
PRODUCT_CODE="1001"
AMOUNT="0.01"
SUBJECT="测试订单"

# 2. 计算签名（需要按字母顺序排列参数）
# amount=0.01&api_key=xxx&merchant_order_no=xxx&product_code=1001&subject=测试订单&key=api_secret
# 然后MD5并转大写

# 3. 发送请求
curl -X POST http://localhost:8787/api/v1/merchant/order/create \
  -d "api_key=${API_KEY}" \
  -d "merchant_order_no=${MERCHANT_ORDER_NO}" \
  -d "product_code=${PRODUCT_CODE}" \
  -d "amount=${AMOUNT}" \
  -d "subject=${SUBJECT}" \
  -d "sign=${SIGN}"
```

### 查询订单示例

```bash
curl -X POST http://localhost:8787/api/v1/merchant/order/query \
  -d "api_key=${API_KEY}" \
  -d "merchant_order_no=${MERCHANT_ORDER_NO}" \
  -d "sign=${SIGN}"
```

## 数据清理

测试完成后，可以在管理后台删除测试数据：

1. 「订单管理」中删除测试订单（如需要）
2. 「商户管理」中删除测试商户（如需要）

注意：删除商户前请确保该商户下没有未完成的订单。

## 下一步

测试通过后，可以：

1. 查看完整的API文档：`商户对接文档.md`
2. 开始实际业务对接
3. 配置正式的回调地址
4. 配置IP白名单（如需要）
5. 集成支付宝SDK完成实际支付功能

## 技术支持

如遇到问题，请联系技术支持并提供：
- 完整的错误信息
- 测试脚本的输出
- 相关的日志文件（runtime/logs/）


