# æ”¯ä»˜å®é»‘åå•ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [1. æ–¹æ¡ˆæ¦‚è¿°](#1-æ–¹æ¡ˆæ¦‚è¿°)
- [2. ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
- [3. æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
- [4. æ ¸å¿ƒåŠŸèƒ½](#4-æ ¸å¿ƒåŠŸèƒ½)
- [5. æ¶ˆæ¯æ¨é€](#5-æ¶ˆæ¯æ¨é€)
- [6. ä»£ç ç»“æ„](#6-ä»£ç ç»“æ„)
- [7. ä½¿ç”¨ç¤ºä¾‹](#7-ä½¿ç”¨ç¤ºä¾‹)
- [8. ç›‘æ§å‘Šè­¦](#8-ç›‘æ§å‘Šè­¦)
- [9. æ‰©å±•æ€§](#9-æ‰©å±•æ€§)

---

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 éœ€æ±‚è¯´æ˜

**ç›®æ ‡ï¼š** å»ºç«‹æ”¯ä»˜å®ç”¨æˆ·é»‘åå•ç³»ç»Ÿï¼Œè®°å½•é£é™©ç”¨æˆ·ä¿¡æ¯å¹¶å®æ—¶æ¨é€åˆ°Telegram

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- é»‘åå•ç”¨æˆ·ç®¡ç†ï¼ˆæ–°å¢ã€æŸ¥è¯¢ã€ç»Ÿè®¡ï¼‰
- å¤šç»´åº¦è¯†åˆ«ï¼ˆæ”¯ä»˜å®IDã€è®¾å¤‡ç ã€IPåœ°å€ï¼‰
- é£é™©ç­‰çº§è¯„ä¼°ï¼ˆæ ¹æ®è§¦å‘æ¬¡æ•°ï¼‰
- å®æ—¶Telegramé€šçŸ¥
- é˜²é‡å¤æ¨é€æœºåˆ¶

### 1.2 è®¾è®¡ç†å¿µ

> **è½»é‡çº§ + è§£è€¦è®¾è®¡ + æ¶ˆæ¯é˜Ÿåˆ—**

- **è½»é‡çº§**ï¼šåŸºäºç°æœ‰PHPç³»ç»Ÿï¼Œæ— éœ€é¢å¤–æœåŠ¡
- **è§£è€¦è®¾è®¡**ï¼šé»‘åå•æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ Telegramæ¨é€
- **å¼‚æ­¥å¤„ç†**ï¼šé»‘åå•å…¥åº“ä¸æ¶ˆæ¯æ¨é€åˆ†ç¦»
- **æ˜“æ‰©å±•**ï¼šæ”¯æŒå¤šç§è§¦å‘åœºæ™¯å’Œé€šçŸ¥æ–¹å¼

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ”¯ä»˜å®é»‘åå•ç³»ç»Ÿ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ä¸šåŠ¡è§¦å‘ç‚¹                   â”‚
              â”‚   - å¼‚å¸¸æ”¯ä»˜è¡Œä¸º               â”‚
              â”‚   - å¤šæ¬¡æ‹’ä»˜                   â”‚
              â”‚   - è®¾å¤‡å¼‚å¸¸                   â”‚
              â”‚   - IPå¼‚å¸¸                    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  AlipayBlacklistService       â”‚
              â”‚  - addToBlacklist()           â”‚
              â”‚  - checkBlacklist()           â”‚
              â”‚  - isDeviceOrIpInBlacklist()  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ•°æ®åº“æŒä¹…åŒ–     â”‚   â”‚  Redisç¼“å­˜        â”‚
        â”‚  alipay_blacklistâ”‚   â”‚  é˜²é‡åˆ¤æ–­         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  TelegramMessageQueueService  â”‚
              â”‚  - åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—               â”‚
              â”‚  - ä½¿ç”¨é»‘åå•æ¨¡æ¿             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  telegram_message_queueè¡¨     â”‚
              â”‚  (æ¶ˆæ¯é˜Ÿåˆ—)                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  TelegramMessageMonitor       â”‚
              â”‚  (æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡)              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  TelegramRobotPush            â”‚
              â”‚  - æ¸²æŸ“é»‘åå•æ¨¡æ¿             â”‚
              â”‚  - æ¨é€åˆ°Telegram             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                          Telegramç¾¤ç»„
```

### 2.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ç±»å‹ | èŒè´£ |
|-----|------|-----|
| **AlipayBlacklist** | Model | é»‘åå•æ•°æ®æ¨¡å‹ |
| **AlipayBlacklistService** | Service | é»‘åå•ä¸šåŠ¡é€»è¾‘ |
| **TelegramMessageQueue** | Model | æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹ |
| **TelegramMessageQueueService** | Service | æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ |
| **BlacklistTemplate** | Template | é»‘åå•æ¶ˆæ¯æ¨¡æ¿ |
| **TelegramRobotPush** | Service | Telegramæ¨é€æœåŠ¡ |
| **TelegramMessageMonitor** | Process | æ¶ˆæ¯é˜Ÿåˆ—ç›‘æ§è¿›ç¨‹ |

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 é»‘åå•è¡¨

```sql
CREATE TABLE `alipay_blacklist` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `alipay_user_id` VARCHAR(64) NOT NULL COMMENT 'æ”¯ä»˜å®ç”¨æˆ·ID',
    `device_code` VARCHAR(128) NULL COMMENT 'è®¾å¤‡ç ',
    `ip_address` VARCHAR(64) NULL COMMENT 'ç”¨æˆ·æ‹‰å•IP',
    `risk_count` INT DEFAULT 1 COMMENT 'é£é™©æ¬¡æ•°',
    `last_risk_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'æœ€åé£é™©æ—¶é—´',
    `remark` VARCHAR(255) NULL COMMENT 'å¤‡æ³¨ä¿¡æ¯',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€ç´¢å¼•ï¼šä¸‰è€…ç»„åˆå”¯ä¸€
    UNIQUE KEY `uniq_blacklist` (`alipay_user_id`, `device_code`, `ip_address`),
    -- å•ç‹¬ç´¢å¼•ï¼šæ”¯æŒå„ç»´åº¦æŸ¥è¯¢
    KEY `idx_alipay_user_id` (`alipay_user_id`),
    KEY `idx_device_code` (`device_code`),
    KEY `idx_ip_address` (`ip_address`)
    
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¯ä»˜å®é»‘åå•';
```

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|-----|------|
| alipay_user_id | VARCHAR(64) | æ”¯ä»˜å®ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰ | 2088100200300400 |
| device_code | VARCHAR(128) | è®¾å¤‡æŒ‡çº¹ç ï¼ˆå¯é€‰ï¼‰ | device_abc123def456 |
| ip_address | VARCHAR(64) | IPåœ°å€ï¼ˆå¯é€‰ï¼‰ | 192.168.1.100 |
| risk_count | INT | é£é™©è§¦å‘æ¬¡æ•° | 1, 5, 10... |
| last_risk_time | DATETIME | æœ€åè§¦å‘æ—¶é—´ | 2025-10-28 15:30:00 |
| remark | VARCHAR(255) | å¤‡æ³¨è¯´æ˜ | æ£€æµ‹åˆ°å¯ç–‘æ”¯ä»˜è¡Œä¸º |

**ç´¢å¼•è®¾è®¡ï¼š**
- **å”¯ä¸€ç´¢å¼•**ï¼šé˜²æ­¢ç›¸åŒç”¨æˆ·+è®¾å¤‡+IPé‡å¤æ’å…¥
- **å•å­—æ®µç´¢å¼•**ï¼šæ”¯æŒæŒ‰å•ä¸€ç»´åº¦æŸ¥è¯¢

### 3.2 æ¶ˆæ¯é˜Ÿåˆ—è¡¨

```sql
CREATE TABLE `telegram_message_queue` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `title` VARCHAR(255) NOT NULL COMMENT 'æ¶ˆæ¯æ ‡é¢˜',
    `content` TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
    `priority` TINYINT DEFAULT 5 COMMENT 'ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰',
    `status` ENUM('pending', 'sending', 'sent', 'failed') DEFAULT 'pending',
    `message_type` VARCHAR(50) DEFAULT 'text' COMMENT 'æ¶ˆæ¯ç±»å‹',
    `template_name` VARCHAR(100) NULL COMMENT 'æ¨¡æ¿åç§°',
    `template_data` JSON NULL COMMENT 'æ¨¡æ¿æ•°æ®',
    `chat_id` VARCHAR(100) NULL COMMENT 'æŒ‡å®šèŠå¤©ID',
    `retry_count` TINYINT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    `max_retry` TINYINT DEFAULT 3 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
    `error_message` TEXT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `sent_at` DATETIME NULL COMMENT 'å‘é€æ—¶é—´',
    `scheduled_at` DATETIME NULL COMMENT 'è®¡åˆ’å‘é€æ—¶é—´',
    
    KEY `idx_status_priority` (`status`, `priority`),
    KEY `idx_created_at` (`created_at`)
    
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Telegramæ¶ˆæ¯é˜Ÿåˆ—';
```

---

## 4. æ ¸å¿ƒåŠŸèƒ½

### 4.1 æ·»åŠ é»‘åå•

**æ–¹æ³•ï¼š** `AlipayBlacklistService::addToBlacklist()`

**åŠŸèƒ½æè¿°ï¼š**
- æ·»åŠ æˆ–æ›´æ–°é»‘åå•è®°å½•
- è‡ªåŠ¨å¢åŠ é£é™©æ¬¡æ•°
- æ›´æ–°æœ€åè§¦å‘æ—¶é—´

**å¤„ç†é€»è¾‘ï¼š**
```
1. æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
   â”œâ”€ å­˜åœ¨ â†’ æ›´æ–°: risk_count++, last_risk_time
   â””â”€ ä¸å­˜åœ¨ â†’ æ’å…¥æ–°è®°å½•

2. ä¿å­˜åˆ°æ•°æ®åº“

3. è¿”å›è®°å½•ID
```

**è°ƒç”¨ç¤ºä¾‹ï¼š**
```php
use app\service\AlipayBlacklistService;

$blacklistId = AlipayBlacklistService::addToBlacklist(
    '2088100200300400',          // æ”¯ä»˜å®ç”¨æˆ·ID
    'device_abc123',             // è®¾å¤‡ç 
    '192.168.1.100',             // IPåœ°å€
    'æ£€æµ‹åˆ°å¯ç–‘æ”¯ä»˜è¡Œä¸º'          // å¤‡æ³¨
);
```

### 4.2 æŸ¥è¯¢é»‘åå•

**æ–¹æ³•ï¼š** `AlipayBlacklistService::checkBlacklist()`

**åŠŸèƒ½æè¿°ï¼š**
- ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆä¸‰ä¸ªæ¡ä»¶éƒ½åŒ¹é…ï¼‰
- è¿”å›é»‘åå•è®°å½•æˆ–null

**è°ƒç”¨ç¤ºä¾‹ï¼š**
```php
$blacklist = AlipayBlacklistService::checkBlacklist(
    '2088100200300400',
    'device_abc123',
    '192.168.1.100'
);

if ($blacklist) {
    echo "ç”¨æˆ·åœ¨é»‘åå•ä¸­ï¼Œé£é™©æ¬¡æ•°ï¼š{$blacklist->risk_count}";
}
```

### 4.3 æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•

**æ–¹æ³•ï¼š** `AlipayBlacklistService::isInBlacklist()`

**åŠŸèƒ½æè¿°ï¼š**
- åªæ£€æŸ¥æ”¯ä»˜å®ç”¨æˆ·ID
- è¿”å› true/false

**è°ƒç”¨ç¤ºä¾‹ï¼š**
```php
if (AlipayBlacklistService::isInBlacklist('2088100200300400')) {
    // æ‹’ç»äº¤æ˜“
    return error('ç”¨æˆ·å·²è¢«åˆ—å…¥é»‘åå•');
}
```

### 4.4 è®¾å¤‡/IPæ£€æŸ¥

**æ–¹æ³•ï¼š** `AlipayBlacklistService::isDeviceOrIpInBlacklist()`

**åŠŸèƒ½æè¿°ï¼š**
- æ£€æŸ¥è®¾å¤‡ç æˆ–IPæ˜¯å¦åœ¨é»‘åå•ä¸­
- æ”¯æŒå•ç‹¬æŸ¥è¯¢è®¾å¤‡æˆ–IP

**è°ƒç”¨ç¤ºä¾‹ï¼š**
```php
// æ£€æŸ¥è®¾å¤‡ç 
if (AlipayBlacklistService::isDeviceOrIpInBlacklist('device_abc123', null)) {
    return error('è®¾å¤‡å·²è¢«åˆ—å…¥é»‘åå•');
}

// æ£€æŸ¥IPåœ°å€
if (AlipayBlacklistService::isDeviceOrIpInBlacklist(null, '192.168.1.100')) {
    return error('IPåœ°å€å·²è¢«åˆ—å…¥é»‘åå•');
}
```

### 4.5 é£é™©ç­‰çº§è¯„ä¼°

**æ ¹æ® `risk_count` è‡ªåŠ¨åˆ¤å®šï¼š**

| é£é™©æ¬¡æ•° | é£é™©ç­‰çº§ | å›¾æ ‡ |
|---------|---------|------|
| 1-2 | ä½é£é™© | ğŸŸ¢ |
| 3-4 | ä¸­é£é™© | ğŸŸ¡ |
| 5-9 | é«˜é£é™© | ğŸŸ  |
| 10+ | æé«˜é£é™© | ğŸ”´ |

---

## 5. æ¶ˆæ¯æ¨é€

### 5.1 æ¨é€æµç¨‹

```
ä¸šåŠ¡è§¦å‘æ·»åŠ é»‘åå•
    â†“
AlipayBlacklistService::addToBlacklist()
    â†“
ï¼ˆå¯é€‰ï¼‰TelegramMessageQueueService::addBlacklistMessage()
    â†“
INSERT INTO telegram_message_queue
    â†“
TelegramMessageMonitor (æ¯3ç§’æ£€æŸ¥)
    â†“
TelegramRobotPush::sendTemplate('blacklist')
    â†“
BlacklistTemplate::render()
    â†“
Telegram Bot API
    â†“
Telegramç¾¤ç»„æ”¶åˆ°é€šçŸ¥
```

### 5.2 æ¶ˆæ¯æ¨¡æ¿

**æ¨¡æ¿æ–‡ä»¶ï¼š** `app/service/robot/templates/BlacklistTemplate.php`

**æ¸²æŸ“æ•ˆæœï¼š**
```
ğŸš¨ æ–°ç”¨æˆ·åŠ å…¥é»‘åå•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“± æ”¯ä»˜å®ç”¨æˆ·IDï¼š
2088100200300400

ğŸ’» è®¾å¤‡ç ï¼š
device_abc123def456

ğŸŒ IPåœ°å€ï¼š
192.168.1.100

âš ï¸ é£é™©æ¬¡æ•°ï¼š1 æ¬¡ ğŸŸ¢ ä½é£é™©

ğŸ“ å¤‡æ³¨ä¿¡æ¯ï¼š
æ£€æµ‹åˆ°å¯ç–‘æ”¯ä»˜è¡Œä¸º

ğŸ”” è§¦å‘ç±»å‹ï¼šé¦–æ¬¡åŠ å…¥

â° è§¦å‘æ—¶é—´ï¼š
2025-10-28 15:30:00

ğŸ’¬ è¯¦ç»†ä¿¡æ¯ï¼š
æ£€æµ‹åˆ°æ–°ç”¨æˆ·åŠ å…¥é»‘åå•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 5.3 æ‰‹åŠ¨æ¨é€ç¤ºä¾‹

```php
use app\service\robot\TelegramMessageQueueService;

// æ·»åŠ é»‘åå•æ¶ˆæ¯åˆ°é˜Ÿåˆ—
TelegramMessageQueueService::addBlacklistMessage([
    'action' => 'insert',              // insert=æ–°å¢, update=æ›´æ–°
    'alipay_user_id' => '2088100200300400',
    'device_code' => 'device_abc123',
    'ip_address' => '192.168.1.100',
    'risk_count' => 1,
    'remark' => 'æ£€æµ‹åˆ°å¯ç–‘æ”¯ä»˜è¡Œä¸º',
    'message' => 'æ£€æµ‹åˆ°æ–°ç”¨æˆ·åŠ å…¥é»‘åå•'
]);
```

### 5.4 è‡ªåŠ¨æ¨é€é…ç½®

**ç›‘æ§è¿›ç¨‹é…ç½®ï¼š** `config/process.php`

```php
'telegram-message-monitor' => [
    'handler' => app\process\TelegramMessageMonitor::class,
    'reloadable' => true,
    'count' => 1,
],
```

**Telegramé…ç½®ï¼š** `.env`

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here
TELEGRAM_ENABLED=true
```

---

## 6. ä»£ç ç»“æ„

### 6.1 æ–‡ä»¶æ¸…å•

```
third_party_payment_api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”œâ”€â”€ AlipayBlacklist.php              # é»‘åå•æ¨¡å‹
â”‚   â”‚   â””â”€â”€ TelegramMessageQueue.php         # æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ AlipayBlacklistService.php       # é»‘åå•æœåŠ¡
â”‚   â”‚   â””â”€â”€ robot/
â”‚   â”‚       â”œâ”€â”€ TelegramMessageQueueService.php  # æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ TelegramRobotPush.php            # Telegramæ¨é€
â”‚   â”‚       â””â”€â”€ templates/
â”‚   â”‚           â””â”€â”€ BlacklistTemplate.php        # é»‘åå•æ¨¡æ¿
â”‚   â”‚
â”‚   â””â”€â”€ process/
â”‚       â””â”€â”€ TelegramMessageMonitor.php       # æ¶ˆæ¯ç›‘æ§è¿›ç¨‹
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ process.php                          # è¿›ç¨‹é…ç½®
â”‚   â””â”€â”€ telegram.php                         # Telegramé…ç½®
â”‚
â”œâ”€â”€ create_alipay_blacklist_table.sql        # å»ºè¡¨SQL
â”œâ”€â”€ create_telegram_message_queue_table.sql  # æ¶ˆæ¯é˜Ÿåˆ—è¡¨SQL
â””â”€â”€ .env                                     # ç¯å¢ƒé…ç½®
```

### 6.2 æ ¸å¿ƒç±»è¯´æ˜

**1. AlipayBlacklist (Model)**
```php
namespace app\model;

class AlipayBlacklist extends Model
{
    protected $table = 'alipay_blacklist';
    protected $fillable = [
        'alipay_user_id',
        'device_code',
        'ip_address',
        'risk_count',
        'last_risk_time',
        'remark'
    ];
}
```

**2. AlipayBlacklistService (Service)**
```php
namespace app\service;

class AlipayBlacklistService
{
    // æ·»åŠ åˆ°é»‘åå•
    public static function addToBlacklist($alipayUserId, $deviceCode, $ipAddress, $remark);
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
    public static function checkBlacklist($alipayUserId, $deviceCode, $ipAddress);
    
    // ç®€å•æ£€æŸ¥ç”¨æˆ·ID
    public static function isInBlacklist($alipayUserId);
    
    // æ£€æŸ¥è®¾å¤‡æˆ–IP
    public static function isDeviceOrIpInBlacklist($deviceCode, $ipAddress);
}
```

**3. TelegramMessageQueueService (Service)**
```php
namespace app\service\robot;

class TelegramMessageQueueService
{
    // æ·»åŠ é»‘åå•æ¶ˆæ¯
    public static function addBlacklistMessage(array $blacklistData);
    
    // æ·»åŠ æ™®é€šæ¶ˆæ¯
    public static function addMessage($title, $content, $priority, $messageType, $options);
    
    // è·å–å¾…å‘é€ç»Ÿè®¡
    public static function getPendingStats();
}
```

**4. BlacklistTemplate (Template)**
```php
namespace app\service\robot\templates;

class BlacklistTemplate
{
    // æ¸²æŸ“æ¨¡æ¿
    public function render(array $data): string;
    
    // è·å–é£é™©ç­‰çº§
    private function getRiskLevel(int $count): string;
}
```

**5. TelegramRobotPush (Service)**
```php
namespace app\service\robot;

class TelegramRobotPush
{
    // å‘é€æ–‡æœ¬
    public function sendText(string $content, ?string $chatId = null): bool;
    
    // å‘é€HTML
    public function sendHtml(string $content, ?string $chatId = null): bool;
    
    // å‘é€æ¨¡æ¿æ¶ˆæ¯
    public function sendTemplate(string $templateName, array $data, ?string $chatId = null): bool;
}
```

**6. TelegramMessageMonitor (Process)**
```php
namespace app\process;

class TelegramMessageMonitor
{
    const CHECK_INTERVAL = 3;  // 3ç§’æ£€æŸ¥ä¸€æ¬¡
    
    public function onWorkerStart(Worker $worker);
    private function processMessageQueue();
    private function processMessage($message, $robot, &$successCount, &$failedCount);
}
```

---

## 7. ä½¿ç”¨ç¤ºä¾‹

### 7.1 åœºæ™¯1ï¼šæ£€æµ‹åˆ°å¼‚å¸¸æ”¯ä»˜

```php
use app\service\AlipayBlacklistService;
use app\service\robot\TelegramMessageQueueService;

// ä¸šåŠ¡æ£€æµ‹é€»è¾‘
if ($this->detectAbnormalPayment($order)) {
    // 1. æ·»åŠ åˆ°é»‘åå•
    $blacklistId = AlipayBlacklistService::addToBlacklist(
        $order->buyer_id,
        $order->device_code,
        $order->client_ip,
        'æ£€æµ‹åˆ°å¼‚å¸¸æ”¯ä»˜è¡Œä¸º'
    );
    
    // 2. æ¨é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    TelegramMessageQueueService::addBlacklistMessage([
        'action' => 'insert',
        'alipay_user_id' => $order->buyer_id,
        'device_code' => $order->device_code,
        'ip_address' => $order->client_ip,
        'risk_count' => 1,
        'remark' => 'æ£€æµ‹åˆ°å¼‚å¸¸æ”¯ä»˜è¡Œä¸º',
        'message' => 'ç”¨æˆ·å°è¯•å¼‚å¸¸æ”¯ä»˜æ“ä½œ'
    ]);
    
    // 3. æ‹’ç»äº¤æ˜“
    return $this->error('äº¤æ˜“è¢«æ‹’ç»');
}
```

### 7.2 åœºæ™¯2ï¼šè®¢å•åˆ›å»ºå‰æ£€æŸ¥

```php
use app\service\AlipayBlacklistService;

public function create(Request $request)
{
    $buyerId = $request->input('buyer_id');
    
    // æ£€æŸ¥é»‘åå•
    if (AlipayBlacklistService::isInBlacklist($buyerId)) {
        Log::warning('é»‘åå•ç”¨æˆ·å°è¯•åˆ›å»ºè®¢å•', [
            'buyer_id' => $buyerId,
            'ip' => $request->getRealIp()
        ]);
        
        return $this->error('è¯¥ç”¨æˆ·æ— æ³•å®Œæˆæ”¯ä»˜');
    }
    
    // ç»§ç»­è®¢å•åˆ›å»ºæµç¨‹...
}
```

### 7.3 åœºæ™¯3ï¼šOAuthè®¤è¯åæ£€æŸ¥

```php
use app\service\AlipayBlacklistService;

public function oauthCallback(Request $request)
{
    // è·å–æ”¯ä»˜å®ç”¨æˆ·ID
    $buyerId = $this->getAlipayUserId($authCode);
    
    // æ£€æŸ¥é»‘åå•
    if (AlipayBlacklistService::isInBlacklist($buyerId)) {
        return $this->error('æˆæƒå¤±è´¥ï¼šç”¨æˆ·é£é™©ç­‰çº§è¿‡é«˜');
    }
    
    // ç»§ç»­æˆæƒæµç¨‹...
}
```

### 7.4 åœºæ™¯4ï¼šè®¾å¤‡éªŒè¯é¡µé¢æ£€æŸ¥

```php
use app\service\AlipayBlacklistService;

public function showDeviceVerificationPage($buyerId, $deviceCode, $ipAddress)
{
    // å¤šç»´åº¦æ£€æŸ¥
    $isBlacklisted = AlipayBlacklistService::isInBlacklist($buyerId)
        || AlipayBlacklistService::isDeviceOrIpInBlacklist($deviceCode, null)
        || AlipayBlacklistService::isDeviceOrIpInBlacklist(null, $ipAddress);
    
    if ($isBlacklisted) {
        return $this->error('è®¾å¤‡éªŒè¯å¤±è´¥ï¼šæ£€æµ‹åˆ°é£é™©');
    }
    
    // ç»§ç»­éªŒè¯æµç¨‹...
}
```

### 7.5 åœºæ™¯5ï¼šå®šæ—¶ä»»åŠ¡æ‰¹é‡æ¨é€

```php
use app\model\AlipayBlacklist;
use app\service\robot\TelegramMessageQueueService;

// æ¯å¤©æ¨é€æ˜¨æ—¥æ–°å¢é»‘åå•
$newBlacklist = AlipayBlacklist::where('created_at', '>', date('Y-m-d 00:00:00', strtotime('-1 day')))
    ->where('created_at', '<', date('Y-m-d 00:00:00'))
    ->get();

foreach ($newBlacklist as $record) {
    TelegramMessageQueueService::addBlacklistMessage([
        'action' => 'insert',
        'alipay_user_id' => $record->alipay_user_id,
        'device_code' => $record->device_code,
        'ip_address' => $record->ip_address,
        'risk_count' => $record->risk_count,
        'remark' => $record->remark,
        'message' => 'æ˜¨æ—¥æ–°å¢é»‘åå•ç”¨æˆ·'
    ]);
}
```

---

## 8. ç›‘æ§å‘Šè­¦

### 8.1 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|-----|------|---------|
| **é»‘åå•æ€»æ•°** | å½“å‰é»‘åå•ç”¨æˆ·æ€»æ•° | > 10000 |
| **æ–°å¢é€Ÿåº¦** | æ¯å°æ—¶æ–°å¢é»‘åå•æ•° | > 50/h |
| **é«˜é£é™©ç”¨æˆ·** | risk_count >= 10 çš„ç”¨æˆ·æ•° | > 100 |
| **æ¨é€æˆåŠŸç‡** | æ¶ˆæ¯æ¨é€æˆåŠŸç‡ | < 95% |
| **æ¶ˆæ¯ç§¯å‹** | å¾…å‘é€æ¶ˆæ¯æ•°é‡ | > 100 |

### 8.2 æ•°æ®ç»Ÿè®¡

**SQLæŸ¥è¯¢ç¤ºä¾‹ï¼š**

```sql
-- é»‘åå•æ€»æ•°
SELECT COUNT(*) as total FROM alipay_blacklist;

-- ä»Šæ—¥æ–°å¢
SELECT COUNT(*) as today_new 
FROM alipay_blacklist 
WHERE DATE(created_at) = CURDATE();

-- é«˜é£é™©ç”¨æˆ·
SELECT COUNT(*) as high_risk 
FROM alipay_blacklist 
WHERE risk_count >= 10;

-- å¾…å‘é€æ¶ˆæ¯
SELECT COUNT(*) as pending 
FROM telegram_message_queue 
WHERE status = 'pending';

-- æ¨é€æˆåŠŸç‡
SELECT 
    SUM(CASE WHEN status = 'sent' THEN 1 ELSE 0 END) / COUNT(*) * 100 as success_rate
FROM telegram_message_queue 
WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### 8.3 æ—¥å¿—è®°å½•

**å…³é”®æ—¥å¿—ï¼š**
```php
// æ·»åŠ é»‘åå•
Log::info('ç”¨æˆ·åŠ å…¥é»‘åå•', [
    'alipay_user_id' => $alipayUserId,
    'device_code' => $deviceCode,
    'ip_address' => $ipAddress,
    'risk_count' => $riskCount
]);

// æ£€æµ‹åˆ°é»‘åå•ç”¨æˆ·
Log::warning('æ£€æµ‹åˆ°é»‘åå•ç”¨æˆ·æ“ä½œ', [
    'alipay_user_id' => $buyerId,
    'action' => 'create_order',
    'ip' => $clientIp
]);

// æ¨é€å¤±è´¥
Log::error('é»‘åå•æ¶ˆæ¯æ¨é€å¤±è´¥', [
    'message_id' => $messageId,
    'error' => $errorMessage
]);
```

---

## 9. æ‰©å±•æ€§

### 9.1 æ‰©å±•åœºæ™¯

**1. å¤šå•†æˆ·éš”ç¦»**
```sql
ALTER TABLE alipay_blacklist 
ADD COLUMN merchant_id INT NULL COMMENT 'å•†æˆ·ID',
ADD KEY idx_merchant_id (merchant_id);
```

**2. é»‘åå•æ¥æº**
```sql
ALTER TABLE alipay_blacklist 
ADD COLUMN source VARCHAR(50) DEFAULT 'manual' COMMENT 'æ¥æºï¼šmanual/auto/import',
ADD COLUMN source_detail TEXT NULL COMMENT 'æ¥æºè¯¦æƒ…';
```

**3. é»‘åå•æœ‰æ•ˆæœŸ**
```sql
ALTER TABLE alipay_blacklist 
ADD COLUMN expire_at DATETIME NULL COMMENT 'è¿‡æœŸæ—¶é—´',
ADD COLUMN is_permanent TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦æ°¸ä¹…';
```

**4. å®¡æ ¸æµç¨‹**
```sql
ALTER TABLE alipay_blacklist 
ADD COLUMN status ENUM('pending', 'approved', 'rejected') DEFAULT 'approved',
ADD COLUMN approved_by INT NULL,
ADD COLUMN approved_at DATETIME NULL;
```

### 9.2 å…¶ä»–é€šçŸ¥æ–¹å¼

**é‚®ä»¶é€šçŸ¥ï¼š**
```php
interface NotificationInterface {
    public function send(array $data): bool;
}

class EmailNotification implements NotificationInterface {
    public function send(array $data): bool {
        // å‘é€é‚®ä»¶
    }
}

class SmsNotification implements NotificationInterface {
    public function send(array $data): bool {
        // å‘é€çŸ­ä¿¡
    }
}
```

### 9.3 ç™½åå•åŠŸèƒ½

```sql
CREATE TABLE `alipay_whitelist` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `alipay_user_id` VARCHAR(64) NOT NULL UNIQUE,
    `reason` VARCHAR(255),
    `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

```php
// æ£€æŸ¥æ—¶å…ˆæŸ¥ç™½åå•
if (AlipayWhitelistService::isInWhitelist($buyerId)) {
    return true; // ç™½åå•ç”¨æˆ·ï¼Œæ”¾è¡Œ
}

// å†æŸ¥é»‘åå•
if (AlipayBlacklistService::isInBlacklist($buyerId)) {
    return false; // é»‘åå•ç”¨æˆ·ï¼Œæ‹’ç»
}
```

---

## é™„å½•

### A. å¿«é€Ÿå¼€å§‹

**1. åˆ›å»ºæ•°æ®åº“è¡¨**
```bash
mysql -h127.0.0.1 -uç”¨æˆ·å -på¯†ç  æ•°æ®åº“å < create_alipay_blacklist_table.sql
mysql -h127.0.0.1 -uç”¨æˆ·å -på¯†ç  æ•°æ®åº“å < create_telegram_message_queue_table.sql
```

**2. é…ç½®Telegram**
```bash
# ç¼–è¾‘ .env æ–‡ä»¶
TELEGRAM_BOT_TOKEN=your_token
TELEGRAM_CHAT_ID=your_chat_id
TELEGRAM_ENABLED=true
```

**3. å¯åŠ¨ç›‘æ§è¿›ç¨‹**
```bash
cd /path/to/third_party_payment_api
php start.php restart
```

**4. æµ‹è¯•æ·»åŠ é»‘åå•**
```bash
# é€šè¿‡SQLç›´æ¥æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO alipay_blacklist 
(alipay_user_id, device_code, ip_address, risk_count, remark) 
VALUES 
('2088100200300400', 'device_test123', '192.168.1.100', 1, 'æµ‹è¯•æ•°æ®');

# é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¨é€
INSERT INTO telegram_message_queue 
(title, content, priority, status, message_type, template_name, template_data) 
VALUES 
('ğŸš¨ æ–°ç”¨æˆ·åŠ å…¥é»‘åå•', '', 3, 'pending', 'template', 'blacklist', 
 '{"action":"insert","alipay_user_id":"2088100200300400","device_code":"device_test123","ip_address":"192.168.1.100","risk_count":1,"remark":"æµ‹è¯•æ•°æ®","message":"æµ‹è¯•æ¨é€"}');
```

### B. å¸¸è§é—®é¢˜

**Q1: æ¶ˆæ¯æ²¡æœ‰æ¨é€åˆ°Telegramï¼Ÿ**
- æ£€æŸ¥ `.env` é…ç½®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç›‘æ§è¿›ç¨‹æ˜¯å¦è¿è¡Œï¼š`php start.php status`
- æŸ¥çœ‹æ—¥å¿—ï¼š`tail -f runtime/logs/webman.log`

**Q2: å¦‚ä½•ä¿®æ”¹æ¨é€é—´éš”ï¼Ÿ**
```php
// app/process/TelegramMessageMonitor.php
const CHECK_INTERVAL = 3;  // æ”¹ä¸º5ç§’
```

**Q3: å¦‚ä½•è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿ï¼Ÿ**
```php
// ä¿®æ”¹ app/service/robot/templates/BlacklistTemplate.php
// ç¼–è¾‘ render() æ–¹æ³•ä¸­çš„ HTML å†…å®¹
```

**Q4: å¦‚ä½•æ‰¹é‡å¯¼å…¥é»‘åå•ï¼Ÿ**
```sql
LOAD DATA LOCAL INFILE '/path/to/blacklist.csv'
INTO TABLE alipay_blacklist
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
(alipay_user_id, device_code, ip_address, remark);
```

### C. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šæ ¹æ®æŸ¥è¯¢é¢‘ç‡è°ƒæ•´ç´¢å¼•
2. **åˆ†è¡¨ç­–ç•¥**ï¼šé»‘åå•æ•°æ®è¶…è¿‡100ä¸‡æ—¶è€ƒè™‘åˆ†è¡¨
3. **ç¼“å­˜ç­–ç•¥**ï¼šé«˜é¢‘æŸ¥è¯¢çš„ç”¨æˆ·IDç¼“å­˜åˆ°Redis
4. **æ‰¹é‡æŸ¥è¯¢**ï¼šä½¿ç”¨ `whereIn` æ‰¹é‡æ£€æŸ¥
5. **å®šæœŸå½’æ¡£**ï¼šå°†è¿‡æœŸæ•°æ®å½’æ¡£åˆ°å†å²è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç¼–å†™æ—¶é—´**: 2025-10-28  
**ç»´æŠ¤å›¢é˜Ÿ**: å¼€å‘å›¢é˜Ÿ

