# 查看投诉退款日志说明

## 查看日志文件

```bash
# 查看最新的日志文件
tail -f runtime/logs/$(date +%Y-%m-%d).log | grep "投诉退款"

# 或者查看所有相关日志
grep -r "投诉退款" runtime/logs/ | tail -50
```

## 关键日志信息

### 1. 投诉详情数据
查找：`投诉退款：投诉详情数据（含数据库直接查询结果）`
- 查看 `merchant_order_no`、`platform_order_no`、`complaint_no` 的值
- 查看 `merchant_order_no_exists`、`platform_order_no_exists` 是否为 `true`

### 2. 查询订单
查找：`投诉退款：查询订单`
- 查看订单号的值和长度
- 查看是否有特殊字符

### 3. 多字段组合查询
查找：`投诉退款：查询订单SQL（多字段组合查询）`
- 查看完整的SQL语句
- 查看绑定的参数值

### 4. 单独字段查询
查找：`投诉退款：单独查询`
- 查看每个字段的单独查询结果
- 确定哪个字段能找到订单

## 常见问题

### 问题1：订单号不匹配
- **现象**：日志显示订单号存在，但查询不到
- **原因**：订单号可能有空格、换行符等不可见字符
- **解决**：查看 `merchant_order_no_length`、`platform_order_no_length` 是否正常

### 问题2：字段映射错误
- **现象**：查询 `platform_order_no` 但实际应该查询 `alipay_order_no`
- **原因**：字段映射关系理解错误
- **解决**：查看日志中的 `note` 字段，确认字段映射关系

### 问题3：订单不存在
- **现象**：所有查询都失败
- **原因**：订单确实不存在，或者订单号完全错误
- **解决**：查看 `order_in_db` 和 `order_in_db_by_platform` 字段，确认订单是否存在

## 调试步骤

1. **查看投诉详情数据**
   ```bash
   grep "投诉退款：投诉详情数据" runtime/logs/*.log | tail -1
   ```

2. **查看查询订单SQL**
   ```bash
   grep "投诉退款：查询订单SQL" runtime/logs/*.log | tail -10
   ```

3. **查看多字段组合查询结果**
   ```bash
   grep "投诉退款：多字段组合查询" runtime/logs/*.log | tail -5
   ```

4. **查看单独字段查询结果**
   ```bash
   grep "投诉退款：单独查询" runtime/logs/*.log | tail -10
   ```

5. **手动执行SQL查询**
   ```sql
   -- 根据日志中的订单号，手动查询
   SELECT id, merchant_order_no, platform_order_no, alipay_order_no, subject_id, pay_status 
   FROM `order` 
   WHERE merchant_order_no = '订单号' 
      OR platform_order_no = '订单号' 
      OR alipay_order_no = '订单号';
   ```

## 提供日志信息

如果问题仍然存在，请提供以下日志信息：

1. `投诉退款：投诉详情数据（含数据库直接查询结果）` 的完整日志
2. `投诉退款：查询订单SQL（多字段组合查询）` 的完整日志
3. `投诉退款：多字段组合查询未找到订单` 的完整日志
4. `投诉退款：单独查询` 的所有日志

这些信息将帮助我们确定问题的根本原因。

